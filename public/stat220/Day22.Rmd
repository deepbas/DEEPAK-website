---
title: "Intro to Classification"
subtitle: "<br/> Fall 2022"
author: "Bastola"
date: "`r format(Sys.Date(), ' %B %d %Y')`"
output:
  xaringan::moon_reader:
    css: ["default", css/xaringan-themer-solns.css, css/my-theme.css, css/my-font.css]
    lib_dir: libs
    chakra: libs/remark-latest.min.js
    seal: false
    nature:
      highlightStyle: googlecode  #http://arm.rbind.io/slides/xaringan.html#77 # idea, magula
      highlightLines: true
      highlightLanguage: ["r", "css", "yaml"]
      countIncrementalSlides: true
      slideNumberFormat: "%current%"
      titleSlideClass: ["left", "middle", "inverse"]
      ratio: "16:9"
    includes:
      in_header: header.html
editor_options: 
  chunk_output_type: console
header-includes:
    - \usepackage{caption}
---


```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
options(htmltools.preserve.raw = FALSE)
options(ggrepel.max.overlaps = Inf)

knitr::opts_chunk$set(echo = TRUE, 
                      dev = 'svg',
                      collapse = TRUE, 
                      comment = NA,  # PRINTS IN FRONT OF OUTPUT, default is '##' which comments out output
                      prompt = FALSE, # IF TRUE adds a > before each code input
                      warning = FALSE, 
                      message = FALSE,
                      fig.height = 3, 
                      fig.width = 4,
                      out.width = "100%",
                      prompt = FALSE,
                      rows.print=7
                      )


# load necessary packages
library(tidyr)
library(dplyr)
library(ggplot2)
library(countdown)
library(ggthemes)
library(tidyverse)
library(stringr)
library(xaringanExtra)
xaringanExtra::use_panelset()
xaringanExtra::use_tachyons()
library(flipbookr)
library(htmlwidgets)
library(lubridate)
library(palmerpenguins)
library(fontawesome)
library(class)
library(patchwork)
library(tidymodels)
library(mlbench)     # for PimaIndiansDiabetes2 dataset
library(janitor)
library(parsnip)
library(kknn)
library(paletteer)
library(corrr)
library(scico)


select <- dplyr::select

# Set ggplot theme
# theme_set(theme_stata(base_size = 10))

yt <- 0


fire <- read_csv("https://raw.githubusercontent.com/deepbas/statdatasets/main/Algeriafires.csv")
fire <- fire %>% clean_names() %>% na.omit() %>% mutate_at(c(10,13), as.numeric) %>% mutate(date = lubridate::make_datetime(year = year, month = month, day = day)) %>% select(-c(1,2,3)) %>% relocate(date, .before = temperature)

fire_foo <- fire %>%
  select(temperature, ffmc, classes) %>%
  bind_rows(., tibble(temperature = 37, ffmc = 83, classes = "unknown"))

distances <- as.matrix(dist(fire_foo[,-3], method = "euclidian"))

fire_foo <- fire_foo %>% 
  mutate(dist = distances[244,]) %>%
  filter(dist > 0)

x_std <- (37 - mean(fire$temperature, na.rm = TRUE)) / sd(fire$temperature, na.rm = TRUE)
y_std <- (83 - mean(fire$ffmc, na.rm = TRUE)) / sd(fire$ffmc, na.rm = TRUE)


```




```{r xaringanExtra-clipboard, echo=FALSE}
htmltools::tagList(
  xaringanExtra::use_clipboard(
    button_text = "<i class=\"fa fa-clipboard\"></i>",
    success_text = "<i class=\"fa fa-check\" style=\"color: #90BE6D\"></i>",
    error_text = "<i class=\"fa fa-times-circle\" style=\"color: #F94144\"></i>"
  ),
  rmarkdown::html_dependency_font_awesome()
)
```


layout: true
  
---

class: title-slide, middle

# .fancy[Introduction to Classification]

### .fancy[Fall 2022]

`r format(Sys.Date(), ' %B %d %Y')`


---


class: center, inverse, top
background-image: url("images/shiny_demo.png")
background-size: 90%

--


### .yellow.bold.font150[https://deepbas.shinyapps.io/my_app/]



---

# Classification


.bql[
Predicting what category a (future) observation falls into
]

<br>
--

.bq.font90[**Examples:**
- .bold[Astronomy:] Whether an exoplanet is habitable (or not)
- .bold[Filtering:] Identify spam emails
- .bold[Medicine:] Use lab results to determine who has a disease (or not)
- .bold[Product preference:] make product recommendations based on past purchases
]

---

background-image: url(images/forest_fire.jpg)
background-position: center
background-size: cover

<br>
<br>

# .center.yellow[Fire can be deadly, destroying homes, wildlife habitat and timber, and polluting air with harmful emission]

---


class: middle

# Predicting the next forest fire ..

.bq[**Dataset**
- contains a culmination of forest fire observations 
- based on two regions of Algeria: the Bejaia region and the Sidi Bel-Abbes region. 
- from June 2012 to September 2012
]

.footnote[Click [here](https://archive.ics.uci.edu/ml/datasets/Algerian+Forest+Fires+Dataset++#) to learn more about the dataset]


---

# Data Description 
<br>

Variable | Description
-------- | -------------
`Date` | (DD-MM-YYYY) Day, month, year 
`Temp` | Noon temperature in Celsius degrees: 22 to 42
`RH` | Relative Humidity in percentage: 21 to 90
`Ws` | Wind speed in km/h: 6 to 29
`Rain` | Daily total rain in mm: 0 to 16.8
`Fine Fuel Moisture Code (FFMC) index` | 28.6 to 92.5
`Duff Moisture Code (DMC) index` | 1.1 to 65.9
`Drought Code (DC) index` | 7 to 220.4
`Initial Spread Index (ISI) index` | 0 to 18.5
`Buildup Index (BUI) index` | 1.1 to 68
`Fire Weather Index (FWI) index` | 0 to 31.1
`Classes` | Two classes, namely .bold[fire] and .bold[not fire]


---

# Glimpse of the data 


.font110[
```{r}
glimpse(fire)
```
]

---


## Scatterplot

```{r echo=FALSE, fig.width=7, fig.height=4.5, fig.align='center', out.width = "80%"}
ggplot(data = fire, aes(x = temperature, y = ffmc , fill = classes)) +
  geom_point(color = "black", pch = 21) +
  labs(x = "Temperature", y = "Fine Fuel Moisture Code (FFMC)") +
  scale_fill_brewer(palette = "Spectral") +
  theme_tufte()
```

---

## How can we classify a new observation?

```{r echo=FALSE, fig.width=7, fig.height=4.5, fig.align='center', out.width = "80%"}
ggplot(data = fire, aes(x = temperature, y = ffmc , fill = classes)) +
  geom_point(aes(x = 37, y = 83), color = "green", pch = 4) +
  geom_point(color = "black", pch = 21) +
  labs(x = "Temperature", y = "Fine Fuel Moisture Code (FFMC)") +
  scale_fill_brewer(palette = "Spectral") +
  theme_tufte()
```

---

background-image: url(images/distance-metrics.png)
background-position: left bottom
background-size: 50%

## Calculating distance

--

.pull-right[
<br>
.bq[
.bold[Euclidean distance:] the straight line distance between two points on the x-y plane with coordinates  
$(x_a, y_a)$ and  $(x_b,y_b)$

$${\rm Distance} = \sqrt{\left(x_a - x_b \right)^2 + \left( y_a - y_b \right)^2}$$


.bold[Manhattan distance:] the "taxi-cab" distance between two points on the x-y plane

$${\rm Distance} = \left|x_a - x_b \right| + \left| y_a - y_b \right|$$

]
]

---

# Looking at Euclidean distance

```{r echo=FALSE, fig.width=7, fig.height=4.5, fig.align='center', out.width = "80%"}
ggplot(data = fire, aes(x = temperature, y = ffmc , fill = classes)) +
  geom_point(aes(x = 37, y = 83), color = "green", pch = 4) +
  geom_segment(aes(xend=37, yend=83), alpha = 0.2) +
  geom_point(color = "black", pch = 21) +
  labs(x = "Temperature", y = "Fine Fuel Moisture Code (FFMC)") +
  scale_fill_brewer(palette = "Spectral") +
  theme_tufte()
```


---

# 1-Nearest Neighbor (NN)

```{r echo=FALSE, fig.width=7, fig.height=4.5, fig.align='center', out.width = "80%"}
ggplot(data = fire, aes(x = temperature, y = ffmc , fill = classes)) +
  geom_point(aes(x = 37, y = 83), color = "green", pch = 4) +
  geom_segment(data = top_n(fire_foo, n = -1, dist), aes(xend=37, yend=83), alpha = 0.8) +
  geom_point(color = "black", pch = 21) +
  labs(x = "Temperature", y = "Fine Fuel Moisture Code (FFMC)") +
  scale_fill_brewer(palette = "Spectral") +
  theme_tufte()
```

---

# 10-NN

```{r echo=FALSE, fig.width=7, fig.height=4.5, fig.align='center', out.width = "80%"}
ggplot(data = fire, aes(x = temperature, y = ffmc , fill = classes)) +
  geom_point(aes(x = 37, y = 83), color = "green", pch = 4) +
  geom_segment(data = top_n(fire_foo, n = -10, dist), aes(xend=37, yend=83), alpha = 0.8) +
  geom_point(color = "black", pch = 21) +
  labs(x = "Temperature", y = "Fine Fuel Moisture Code (FFMC)") +
  scale_fill_brewer(palette = "Spectral") +
  theme_tufte()
```

---

# .center.large[.bold[.purple[Wait, something is not quite right..]]]


```{r echo=FALSE, fig.width=7, fig.height=4.5, fig.align='center', out.width = "80%"}
ggplot(data = fire, aes(x = temperature, y = ffmc , fill = classes)) +
  geom_point(aes(x = 37, y = 83), color = "green", pch = 4) +
  geom_segment(data = top_n(fire_foo, n = -10, dist), aes(xend=37, yend=83), alpha = 0.8) +
  geom_point(color = "black", pch = 21) +
  labs(x = "Temperature", y = "Fine Fuel Moisture Code (FFMC)") +
  scale_fill_brewer(palette = "Spectral") +
  theme_tufte()
```

---

class: middle

# Need to standardize data

```{r}
standardize <- function(x, na.rm = FALSE) {
  (x - mean(x, na.rm = na.rm)) / sd(x, na.rm = na.rm)
}
```

.fancy.bq[
- Predictors with larger variation will have larger influence on which cases are “nearest” neighbors
- Methods relying on distance can be sensitive (i.e. not invariant) to the scale of the predictors
- Standardizing only shifts and rescales the variable, it doesn't change the shape of the distribution
]

---
background-image: url(images/horst_dplyr_across.png)
background-position: center
background-size: cover

---

class: middle

# Standardized data

.code70[
```{r}
fire1 <- fire %>% mutate(across(where(is.numeric), standardize)) #<<
fire1 %>% summary()
```
]

---
background-image: url(images/corplot.png)
background-size: 85%


```{r, echo=FALSE}
fire_bar <- fire1 %>%
  select(temperature, ffmc, classes) %>%
  bind_rows(., tibble(temperature = x_std, ffmc = y_std, classes = "unknown"))

distances <- as.matrix(dist(fire_bar[,-3], method = "euclidian"))

fire_bar <- fire_bar %>% 
  mutate(dist = distances[244,]) %>%
  filter(dist > 0)
```


---

# 1-NN again

```{r echo=FALSE, fig.width=7, fig.height=4.5, fig.align='center', out.width = "80%"}
ggplot(data = fire1, aes(x = temperature, y = ffmc , fill = classes)) +
  geom_point(aes(x = x_std, y = y_std), color = "green", pch = 4) +
  geom_segment(data = top_n(fire_bar, n = -1, dist), aes(xend=x_std, yend=y_std), alpha = 0.8) +
  geom_point(color = "black", pch = 21) +
  labs(x = "Temperature", y = "Fine Fuel Moisture Code (FFMC)") +
  scale_fill_brewer(palette = "Spectral") +
  theme_tufte()
```

---

# 10-NN again

```{r echo=FALSE, fig.width=7, fig.height=4.5, fig.align='center', out.width = "80%"}
ggplot(data = fire1, aes(x = temperature, y = ffmc , fill = classes)) +
  geom_point(aes(x = x_std, y = y_std), color = "green", pch = 4) +
  geom_segment(data = top_n(fire_bar, n = -10, dist), aes(xend=x_std, yend=y_std), alpha = 0.8) +
  geom_point(color = "black", pch = 21) +
  labs(x = "Temperature", y = "Fine Fuel Moisture Code (FFMC)") +
  scale_fill_brewer(palette = "Spectral") +
  theme_tufte()
```

---

# 50-NN again

```{r echo=FALSE, fig.width=7, fig.height=4.5, fig.align='center', out.width = "80%"}
ggplot(data = fire1, aes(x = temperature, y = ffmc , fill = classes)) +
  geom_point(aes(x = x_std, y = y_std), color = "green", pch = 4) +
  geom_segment(data = top_n(fire_bar, n = -50, dist), aes(xend=x_std, yend=y_std), alpha = 0.8) +
  geom_point(color = "black", pch = 21) +
  labs(x = "Temperature", y = "Fine Fuel Moisture Code (FFMC)") +
  scale_fill_brewer(palette = "Spectral") +
  theme_tufte()
```


---
class: middle

# .purple[Visualizing the decision boundary]

.font100.fancy.bq[

- We can map out the region in feature-space where the classifier would predict 'fire', and the kinds where it would predict 'not fire'

- There is some boundary between the two, where points on one side of
the boundary will be classified 'fire' and points on the other side will be
classified 'not fire'

- This boundary is called **decision boundary**
]

---

# Visualizing the decision boundary

```{r echo=FALSE, fig.width=7, fig.height=4.5, fig.align='center', out.width = "80%"}
grid_pts <- expand.grid(temperature = seq(min(fire1$temperature), max(fire1$temperature), length.out = 50), 
                        ffmc = seq(min(fire1$ffmc), max(fire1$ffmc), length.out = 50))

ggplot(data = fire1) +
  geom_point(data = grid_pts, aes(x = temperature, y = ffmc), alpha = 0.1) +
  geom_point(aes(x = temperature, y = ffmc, fill = classes), color = "black", pch = 21) +
  labs(x = "Temperature", y = "Fine Fuel Moisture Code (FFMC)") +
  scale_fill_brewer(palette = "Spectral") +
  theme_tufte()
```

---

# 1-NN decision boundary

```{r echo=FALSE, fig.width=7, fig.height=4.5, fig.align='center', out.width = "80%"}
# Illustrating the decision boundary
knn_preds <- knn(train = fire1[, c("temperature", "ffmc")], test = grid_pts, cl = fire1[["classes"]], k = 1)

knn_df <- data.frame(grid_pts, classes = knn_preds)

ggplot(data = fire1) +
  geom_point(data = knn_df, aes(x = temperature, y = ffmc, color = classes), alpha = 0.3) +
  geom_point(aes(x = temperature, y = ffmc, fill = classes), color = "black", pch = 21) +
  labs(x = "Temperature", y = "Fine Fuel Moisture Code (FFMC)") +
  scale_color_brewer(palette = "Spectral") +
  scale_fill_brewer(palette = "Spectral") +
  theme_tufte()
```

---

# 25-NN decision boundary

```{r echo=FALSE, fig.width=7, fig.height=4.5, fig.align='center', out.width = "80%"}
# Illustrating the decision boundary
knn_preds <- knn(train = fire1[, c("temperature", "ffmc")], test = grid_pts, cl = fire1[["classes"]], k = 25)

knn_df <- data.frame(grid_pts, classes = knn_preds)

ggplot(data = fire1) +
  geom_point(data = knn_df, aes(x = temperature, y = ffmc, color = classes), alpha = 0.3) +
  geom_point(aes(x = temperature, y = ffmc, fill = classes), color = "black", pch = 21) +
  labs(x = "Temperature", y = "Fine Fuel Moisture Code (FFMC)") +
  scale_color_brewer(palette = "Spectral") +
  scale_fill_brewer(palette = "Spectral") +
  theme_tufte()
```


---

background-image: url("images/tidymodels.png")
background-position: left
background-size: 50%
class: clear, middle

.pull-right[
#   a collection of packages for modeling and machine learning using tidyverse principles
]

---

# 1. Load data and convert types
.code120[
```{r}
fire_raw <- read_csv("https://raw.githubusercontent.com/deepbas/statdatasets/main/Algeriafires.csv") %>% 
  clean_names() %>% na.omit() %>% 
  mutate(classes = as_factor(classes)) %>%
  mutate_at(c(10,13), as.numeric) %>%
  select(temperature, ffmc, classes)
```
]

.code120[
```{r}
head(fire_raw)
```
]

---



background-image: url("images/recipe.jpg")
background-position: center
background-size: cover
class: left



---

class: middle

# 2. Create a recipe for data preprocessing

.code120[
```{r}
fire_recipe <- recipe(classes ~ ., data = fire_raw) %>%
 step_scale(all_predictors()) %>%
 step_center(all_predictors()) %>%
 prep()
```
]


---

class: middle


# 3. Apply the recipe to the data set
.code120[
```{r}
fire_scaled <- bake(fire_recipe, fire_raw)
```
]

.code110[
```{r, echo=FALSE}
fire_scaled
```
]

---

class: middle

# 4. Create a model specification

.code120[
```{r}
knn_spec <- nearest_neighbor(mode = "classification",
                             engine = "kknn",
                             weight_func = "rectangular",
                             neighbors = 5) 
```
]


---

class: middle

# 5. Fit the model on the preprocessed data

.code120[
```{r}
knn_fit <- knn_spec %>%
 fit(classes ~ ., data = fire_scaled)
```
]

---
class: middle


# 6. Classify


.Large[Suppose we get two new observations, use predict to classify the observations]

.code120[
```{r}
# Data frame/tibble of new observations
new_observations <- tibble(temperature = c(1, 2), ffmc = c(-1, 1))
```
]

.code120[
```{r}
# Making classifications (i.e. predictions)
predict(knn_fit, new_data = new_observations)
```
]

---

class: middle

# Further Practice: Pima Indians Diabetes 

.bql[
- Owned by the National Institute of Diabetes and Digestive and Kidney Diseases

- A data frame with 768 observations on 9 variables.

- We have the lab results of 158 patients, including whether they have CKD

- Response variable: `diabetes` =	`pos`, `neg`

- Predictor variables: _pregnant, glucose, pressure, triceps, insulin, mass,  pedigree, age_
]

.footnote[Click here for [source](https://archive.ics.uci.edu/ml/index.php)]

---

# Variables

.large[
Variable | Description
-------- | -------------
`pregnant`| Number of times pregnant
`glucose` | Plasma glucose concentration (glucose tolerance test)
`pressure` | Diastolic blood pressure (mm Hg)
`triceps` | Triceps skinfold thickness (mm)
`insulin` | 2-Hour serum insulin (mu U/ml)
`mass` | Body mass index (weight in kg/(height in m)\²)
`pedigree` | Diabetes pedigree function
`age` | Age (years)
`diabetes` | diabetes case (pos/neg)
]


---


class: action, middle

# <i class="fa fa-pencil-square-o" style="font-size:48px;color:purple">&nbsp;Group&nbsp;Activity&nbsp;`r (yt <- yt + 1)`</i>    


.pull-left-40[
![](https://media.giphy.com/media/RKApDdwsQ6jkwd6RNn/giphy.gif)
]
.pull-right-60[
<br>
<br>
.bq[
- Let's go over to maize server/ local Rstudio and our class [moodle](https://moodle.carleton.edu/course/view.php?id=39491)
- Get the class activity 22.Rmd file
- Work on activity 1
- Ask me questions
]

]

`r countdown(minutes = 10, seconds = 00, top = 0 , color_background = "inherit", padding = "3px 4px", font_size = "2em")`

