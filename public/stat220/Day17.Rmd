---
title: "Advanced Web Scraping"
subtitle: "<br/> Spring 2023"
author: "Bastola"
date: "`r format(Sys.Date(), ' %B %d %Y')`"
output:
  xaringan::moon_reader:
    css: ["default", css/xaringan-themer-solns.css, css/my-theme.css, css/my-font.css]
    lib_dir: libs
    chakra: libs/remark-latest.min.js
    seal: false
    nature:
      highlightStyle: googlecode  #http://arm.rbind.io/slides/xaringan.html#77 # idea, magula
      highlightLines: true
      highlightLanguage: ["r", "css", "yaml"]
      countIncrementalSlides: true
      slideNumberFormat: "%current%"
      titleSlideClass: ["left", "middle", "inverse"]
      ratio: "16:9"
    includes:
      in_header: header.html
editor_options: 
  chunk_output_type: console
header-includes:
    - \usepackage{caption}
---


```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
options(htmltools.preserve.raw = FALSE)
options(ggrepel.max.overlaps = Inf)

knitr::opts_chunk$set(echo = TRUE, 
                      dev = 'svg',
                      collapse = TRUE, 
                      comment = NA,  # PRINTS IN FRONT OF OUTPUT, default is '##' which comments out output
                      prompt = FALSE, # IF TRUE adds a > before each code input
                      warning = FALSE, 
                      message = FALSE,
                      fig.height = 3, 
                      fig.width = 4,
                      out.width = "100%",
                      prompt = FALSE,
                      rows.print=7
                      )

# load necessary packages
library(tidyverse)
library(countdown)
library(mosaic)
library(ggthemes)
library(xaringanExtra)
library(forcats)
xaringanExtra::use_panelset()
xaringanExtra::use_tachyons()
xaringanExtra::use_clipboard()
xaringanExtra::use_extra_styles(
  hover_code_line = TRUE,         
  mute_unhighlighted_code = TRUE  
)
library(flipbookr)
library(patchwork)
library(DT)
library(knitr)
library(grid)
library(gridExtra)
library(ggrepel)
library(lubridate)

# specific packages
library(plotly)
library(polite)
library(rvest)
library(stringr)
select <- dplyr::select

# Set ggplot theme
# theme_set(theme_stata(base_size = 10))

yt <- 0

# read.csv("https://raw.githubusercontent.com/deepbas/statdatasets/main/agstrat.csv")

base_url <- "https://www.the-numbers.com/movie/budgets/all"
idx <- seq(1, 6301, 100)
urls <- map_chr(idx, ~ str_glue("{base_url}/{.x}"))

# Use map_df to scrape and combine tables from all pages, ensuring consistent column types
df_movies <- map_df(urls, ~ {
  page_data <- read_html(.x) %>%
    html_table() %>%
    .[[1]] %>%
    tibble::as_tibble(.name_repair = "unique") %>%
    mutate(across(everything(), as.character))
  return(page_data)
})

```



```{r xaringanExtra-clipboard, echo=FALSE}
htmltools::tagList(
  xaringanExtra::use_clipboard(
    button_text = "<i class=\"fa fa-clipboard\"></i>",
    success_text = "<i class=\"fa fa-check\" style=\"color: #90BE6D\"></i>",
    error_text = "<i class=\"fa fa-times-circle\" style=\"color: #F94144\"></i>"
  ),
  rmarkdown::html_dependency_font_awesome()
)
```


layout: true
  
---

class: title-slide, middle

# .fancy[Advanced Web Scraping]

### .fancy[Stat 220]

`r format(Sys.Date(), ' %B %d %Y')`


---

class: center, inverse, top
background-image: url("images/usafacts.png")
background-size: 90%


---


# Scrape table

.scroll-box-32[
```{r}
table_usafacts <- bow(url = "https://usafacts.org/visualizations/covid-vaccine-tracker-states/state/minnesota") %>%
  scrape() %>% html_elements(css = "table") %>% html_table() %>% pluck(1)
knitr::kable(table_usafacts, format = "html")
```
]


.footnote[Click [here](https://usafacts.org/visualizations/covid-vaccine-tracker-states/state/minnesota) to take a look at the webpage]


---

# Scraping multiple tables

```{r}
all_url <- "https://finance.yahoo.com/screener/predefined/day_gainers?count=25&offset="
idx <- seq(0, 1050, by = 25)

start_time <- proc.time() # Capture start time

my_df <- map_df(idx, ~ {
  new_webpage <- read_html(str_glue("{all_url}{.x}")) 
  table_new <- html_table(new_webpage)[[1]] %>%
    janitor::clean_names() %>% 
    mutate(across(everything(), as.character))
  return(table_new)
})
end_time <- proc.time() # Capture end time
end_time - start_time # Calculate duration
```


.footnote[Click [here](https://finance.yahoo.com/gainers?count=25&offset=0) to take a look at the webpage]

---

### Multiple tables combined

.scroll-output[
```{r, echo=FALSE}
DT::datatable(
  my_df %>% select(-x52_week_range),
  fillContainer = FALSE, options = list(pageLength = 5)
)
```
]


---

class: action, middle

# <i class="fa fa-pencil-square-o" style="font-size:48px;color:purple">&nbsp;Group&nbsp;Activity&nbsp;`r (yt <- yt + 1)`</i>    


.pull-left-40[
![](https://media.giphy.com/media/RKApDdwsQ6jkwd6RNn/giphy.gif)
]
.pull-right-60[
<br>
.bql.font90[
- Let's go over to maize server/ local Rstudio and our class [moodle](https://moodle.carleton.edu/course/view.php?id=43045)
- Get the class activity 17.Rmd file
- Work on activity 1
]

]

`r countdown(minutes = 30, seconds = 00, top = 0 , color_background = "inherit", padding = "3px 4px", font_size = "2em")`

---

class: center, inverse, top
background-image: url("images/numbers_scraping.png")
background-size: 70%


---


`r chunk_reveal("demo3", widths = c(60, 40), font_size_code="80%", title = "## Scrape, Tidy, and Visualize")`

```{r,demo3}
df_movies %>% 
mutate(
  ID = row_number(), 
  ProductionBudget = parse_number(ProductionBudget),
  DomesticGross = parse_number(DomesticGross),
  WorldwideGross = parse_number(WorldwideGross),
  ReleaseDate = mdy(ReleaseDate),
  MonthOfRelease = month(ReleaseDate, label = TRUE, abbr = TRUE),
  YearOfRelease = year(ReleaseDate)
) %>%
replace_na(list(ReleaseDate = make_date(year = 1900))) %>%
  group_by(MonthOfRelease) %>%
  summarize(AverageByMonth = mean(DomesticGross, na.rm = TRUE)) -> df_DomesticGross_month
```


---

##  Introduction to `plotly`


.panelset[

.panel[

.panel-name[plot]

```{r, echo=FALSE, fig.height=6, fig.width=6}
library(plotly)
fig <- df_DomesticGross_month %>% plot_ly(labels = ~MonthOfRelease, values = ~AverageByMonth)
fig <- fig %>% add_pie(hole = 0.6)
fig <- fig %>% layout(title = "Average Domestic Gross by Month",  showlegend = F,
                      xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
                      yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig
```


]

.panel[

.panel-name[code]

```{r, eval=FALSE, fig.height=7, fig.width=6}
library(plotly)
fig <- df_DomesticGross_month %>% plot_ly(labels = ~MonthOfRelease, values = ~AverageByMonth)
fig <- fig %>% add_pie(hole = 0.6)
fig <- fig %>% layout(title = "Average Domestic Gross by Month",  showlegend = F,
                      xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
                      yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig
```

]

]



---

class: middle



### `ggplotly` converts `ggplot2` figures into interactive `plotly` graphs.


.scroll-box-16[
```{r}
midwest %>% as_tibble()
```
]

---


# Interactive visualizations using `ggplotly`


.panelset[

.panel[

.panel-name[plot]

```{r, echo=FALSE, fig.height=7, fig.width=6}
gg <- ggplot(midwest, aes(x = area, y = poptotal)) + geom_point()
ggplotly(gg)
```


]

.panel[

.panel-name[code]

```{r, eval=FALSE}
gg <- ggplot(midwest, aes(x = area, y = poptotal)) + geom_point()
ggplotly(gg)
```


]

]

---

## Enhance plots with `tooltips` for better interactivity:

.panelset[

.panel[

.panel-name[plot]

```{r, echo=FALSE, fig.height=7, fig.width=6}
gg <- mtcars %>%
  ggplot(aes(wt, mpg, color = factor(gear), text = paste("Gear:", gear))) +
  geom_point()
ggplotly(gg, tooltip = "text")

```


]

.panel[

.panel-name[code]

```{r, eval=FALSE}
gg <- mtcars %>%
  ggplot(aes(wt, mpg, color = factor(gear), text = paste("Gear:", gear))) +
  geom_point()
ggplotly(gg, tooltip = "text")

```


]

]

---

##  Highlight data points on hover:


.panelset[

.panel[

.panel-name[plot]


```{r, echo=FALSE, fig.height=7, fig.width=6}
gg <- mtcars %>%
  ggplot(aes(wt, mpg, color = factor(carb))) +
  geom_point(size = 3) +
  theme_minimal()
ggplotly(gg) %>% layout(hovermode = "closest")
```


]

.panel[

.panel-name[code]

```{r, eval=FALSE}
gg <- mtcars %>%
  ggplot(aes(wt, mpg, color = factor(carb))) +
  geom_point(size = 3) +
  theme_minimal()
ggplotly(gg) %>% layout(hovermode = "closest")
```


]

]


---

.panelset[

.panel[

.panel-name[plot]
```{r, echo=FALSE, fig.height=7, fig.width=6}
library(plotly)
library(ggplot2)

p <- ggplot(midwest, aes(x = percbelowpoverty, y = percollege)) + 
  geom_point() + # Add points
  theme_minimal() + # Use a minimal theme
  labs(x = "Percentage Below Poverty", 
       y = "Percentage College Educated", 
       title = "Education vs. Poverty in the Midwest")

ggplotly(p)
```


]

.panel[

.panel-name[code]
```{r, eval=FALSE}
library(plotly)
library(ggplot2)

p <- ggplot(midwest, aes(x = percbelowpoverty, y = percollege)) + 
  geom_point() + # Add points
  theme_minimal() + # Use a minimal theme
  labs(x = "Percentage Below Poverty", 
       y = "Percentage College Educated", 
       title = "Education vs. Poverty in the Midwest")

ggplotly(p)
```


]

]




---


.panelset[

.panel[

.panel-name[plot]


```{r, echo=FALSE, fig.height=7, fig.width=6}
gp = mtcars %>%
  mutate(amFactor = factor(am, labels = c('auto', 'manual')),
         hovertext = paste(wt, mpg, amFactor)) %>%
  arrange(wt) %>%
  ggplot(aes(x = wt, y = mpg, color = amFactor)) +
  geom_smooth(se = F) +
  geom_point(aes(color = amFactor))

ggplotly()
```



]

.panel[

.panel-name[code]


```{r, eval=FALSE, fig.height=7, fig.width=6}
gp = mtcars %>%
  mutate(amFactor = factor(am, labels = c('auto', 'manual')),
         hovertext = paste(wt, mpg, amFactor)) %>%
  arrange(wt) %>%
  ggplot(aes(x = wt, y = mpg, color = amFactor)) +
  geom_smooth(se = F) +
  geom_point(aes(color = amFactor))

ggplotly()
```


]

]

---

# DT: Interactive Data Tables

.code70[
```{r, eval=FALSE}
library(ggplot2movies)
library(DT)
movies %>% select(1:6) %>%
  filter(rating > 8, !is.na(budget), votes > 1000) %>% 
  datatable(fillContainer = FALSE, options = list(pageLength = 6))
```
]

--

```{r, echo=FALSE}
library(ggplot2movies)
movies %>%
  select(1:6) %>%
  filter(rating > 8, !is.na(budget), votes > 1000) %>% 
  datatable(fillContainer = FALSE, options = list(pageLength = 6))
```




