---
title: "Shiny and Interactive Maps"
subtitle: "<br/> STAT 220"
author: "Bastola"
date: "`r format(Sys.Date(), ' %B %d %Y')`"
output:
  xaringan::moon_reader:
    css: ["default", css/xaringan-themer-solns.css, css/my-theme.css, css/my-font.css]
    lib_dir: libs
    chakra: libs/remark-latest.min.js
    seal: false
    nature:
      highlightStyle: googlecode  #http://arm.rbind.io/slides/xaringan.html#77 # idea, magula
      highlightLines: true
      highlightLanguage: ["r", "css", "yaml"]
      countIncrementalSlides: true
      slideNumberFormat: "%current%"
      titleSlideClass: ["left", "middle", "inverse"]
      ratio: "16:9"
      countdown: 60000
    includes:
      in_header: header.html  
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
options(htmltools.preserve.raw = FALSE)


knitr::opts_chunk$set(echo = TRUE, 
                      dev = 'svg',
                      collapse = TRUE, 
                      comment = NA,  # PRINTS IN FRONT OF OUTPUT, default is '##' which comments out output
                      prompt = FALSE, # IF TRUE adds a > before each code input
                      warning = FALSE, 
                      message = FALSE,
                      fig.height = 3, 
                      fig.width = 4,
                      out.width = "100%"
                      )


# load necessary packages
library(tidyverse)
library(ggplot2)
library(countdown)
library(ggthemes)
library(xaringanExtra)
xaringanExtra::use_panelset()
xaringanExtra::use_tachyons()
library(flipbookr)
library(htmlwidgets)
library(lubridate)
library(icons)


library(kableExtra)
library(fontawesome)
library(rvest)
library(forcats)
library(patchwork)
library(polite)
library(DT)
library(polite)
library(purrr)
library(leaflet)
library(maptools)
library(maps)     
library(sp)       
library(maptools) 
library(mapdata)
library(ggiraph)

yt <- 0

```


```{r xaringan-themer, include = FALSE}
# Use xaringan theme from first set
```

layout: true
  
<!-- <div class="my-footer"><span>Bastola</span></div> -->
<!-- this adds the link footer to all slides, depends on my-footer class in css-->

---
class: title-slide, middle
<!-- background-image: url("assets/title-image2.jpg") -->
background-position: 10% 90%, 100% 50%
background-size: 160px, 100% 100%

# .fancy[Shiny and Interactive Graphs]

### .fancy[Stat 220]

.large[Bastola]

`r format(Sys.Date(), ' %B %d %Y')`

---

class: middle

# Interactive maps using `ggiraph`

<blockquote>
A tool that allows you to create dynamic ggplot graphs.
</blockquote>

- allows you to add tooltips, hover effects and other useful effects
- displays information when the mouse is over elements


.footnote[Click [here](https://davidgohel.github.io/ggiraph/index.html) for more useful resources.]

---

`r chunk_reveal("demo1", widths = c(10, 10), font_size_code="10%", title = "# Data Scraping and Cleaning", display_type = c("code"))`

.code80[
```{r, demo1, eval=FALSE, echo=FALSE}
table_usafacts <- bow(url = "https://usafacts.org/visualizations/coronavirus-covid-19-spread-map/") %>%
  scrape() %>% 
  html_elements(css = "table") %>% 
  html_table()

covid <- table_usafacts[[2]]
covid_clean <- covid %>% janitor::clean_names() %>%
  mutate_at(4:6, parse_number) %>% mutate(state = str_to_lower(state))

states <- map_data("state")
covid_data <- left_join(states, covid_clean, by = c("region" = "state"))

```
]

---

# Glimpse of data

```{r, echo=FALSE}
# Scrape the webpage for tables
table_usafacts <- bow(url = "https://usafacts.org/visualizations/coronavirus-covid-19-spread-map/") %>% scrape() %>% html_elements(css = "table") %>% html_table()

# Extract the right table
covid <- table_usafacts[[2]]

# Clean the data
covid_clean <- covid %>% janitor::clean_names() %>%
  mutate_at(4:6, parse_number) %>% mutate(state = str_to_lower(state))

# Store the geographical coordinates and grouping information
states <- map_data("state")

# Joint the state-wise data for plotting
covid_data <- left_join(states, covid_clean, by = c("region" = "state"))

```

.code120[
```{r}
glimpse(covid_data)
```
]

---

`r chunk_reveal("demo2", widths = c(10, 10), font_size_code="40%", title = "# Interactive Plot", display_type = c("code"))`

.code80[
```{r, demo2, eval=FALSE, echo=FALSE}
map1 <- ggplot(covid_data, aes(long, lat, group = group)) + coord_map() + theme_map() +
  geom_polygon_interactive(aes(fill = deaths, 
                               tooltip = deaths)) + 
  guides(fill=guide_legend(title="7 day average cases")) + 
  scale_fill_fermenter(type = "div", palette = "Spectral") + 
  theme(legend.position = "right") 
  
ggiraph(code = print(map1))
```
]

---

# Interactive Plot

```{r, echo=FALSE}
map1 <- ggplot(covid_data, aes(long, lat, group = group)) + coord_map() + theme_map() +
  geom_polygon_interactive(aes(fill = deaths, 
                               tooltip = deaths)) + 
  guides(fill=guide_legend(title="Total Deaths")) + 
  scale_fill_fermenter(type = "div", palette = "Spectral") + 
  theme(legend.position = "right") 
  
ggiraph(code = print(map1))
```

---

# Interactive Plot

.code120[
```{r, eval=FALSE}
covid_data$tooltip <- str_c("State = ", str_to_upper(covid_data$region), "\n Cases =", covid_data$cases) #<<

map2 <- ggplot(covid_data, aes(long, lat)) + coord_map() + theme_map() +
  geom_polygon_interactive(aes(fill = cases, group = group,
                               tooltip = tooltip, 
                               data_id = cases)) +
  guides(fill=guide_legend(title="Total Cases")) + 
  scale_fill_fermenter(type = "div", palette = "Spectral") + 
  theme(legend.position = "right") 
  
ggiraph(code = print(map2),  hover_css = "fill:lightgreen;r:10pt;")
```
]
---

# Interactive Plot

.code120[
```{r, eval=FALSE}
covid_data$tooltip <- str_c("State = ", str_to_upper(covid_data$region), "\n Cases =", covid_data$cases)

map2 <- ggplot(covid_data, aes(long, lat)) + coord_map() + theme_map() +
  geom_polygon_interactive(aes(fill = cases, group = group,
                               tooltip = tooltip, 
                               data_id = cases)) +
  guides(fill=guide_legend(title="Total Cases")) + 
  scale_fill_fermenter(type = "div", palette = "Spectral") + 
  theme(legend.position = "right") 
  
ggiraph(code = print(map2),  hover_css = "fill:lightgreen;r:10pt;") #<<
```
]

---

```{r, echo=FALSE}
covid_data$tooltip <- str_c("State = ", str_to_upper(covid_data$region), "\n Cases =", covid_data$cases)

map2 <- ggplot(covid_data, aes(long, lat)) + coord_map() + theme_map() +
  geom_polygon_interactive(aes(fill = cases, group = group,
                               tooltip = tooltip, 
                               data_id = cases)) +
  guides(fill=guide_legend(title="Total Cases")) + 
  scale_fill_fermenter(type = "div", palette = "Spectral") + 
  theme(legend.position = "right") 
  
ggiraph(code = print(map2),  hover_css = "fill:lightgreen;r:10pt;") #<<
```


---
class: middle

# Shiny Implementation

.code120[
```{r, eval=FALSE}
# Basic ggiraph using Shiny
ui <- fluidPage(
  girafeOutput("plot")
  )

server <- function(input, output) {

  output$plot <- renderGirafe({
    girafe(ggobj = gg_blahblah )
  })
  })
}

```
]


---

class: middle

# Leaflet

<blockquote>
Leaflet is a JavaScript library for creating dynamic maps that support panning and zooming along with various annotations like markers, polygons, and popups.
</blockquote>


```{r, out.width="100%",  fig.height = 5,  fig.width = 6}
leaflet() %>%
  addTiles() %>% 
  setView(lng = -93.1616, lat = 44.4583, zoom = 12)
```

---

class: middle

# What can you do with `leaflet`?

- Create a color palette thanks to the .bold[colorNumeric()] function.

- Translate a numeric variable to a palette of color. Leaflet offers 3 options:

  - Quantile with .out-t[colorQuantile]
  - Numeric with .out-t[colorNumeric]
  - Bin with .out-t[colorBin]

- Make the background map with `leaflet()`, `addTiles()` and `setView()`.

- Use `addPolygons()` to add the shape of all country/states/county, with a color representing some numerical variable

For more information, [click here](https://rstudio.github.io/leaflet/) 

---

# Implementation

<blockquote>
In the UI you call .bold[leafletOutput], and on the server side you assign a .bold[renderLeaflet] call to the output. Inside the .bold[renderLeaflet] expression, you return a Leaflet map object.
</blockquote>


```{r, eval=FALSE}
# Basic Leaflet using Shiny
ui <- fluidPage(
  leafletOutput("mymap")
  )

server <- function(input, output, session) {

  output$mymap <- renderLeaflet({
    leaflet() %>%
      addTiles() %>%
      addPolygons() %>%
      addLegend()
  })
}
```


---

`r chunk_reveal("demo3", widths = c(10, 10), font_size_code="40%", title = "# Data Wrangling", display_type = c("code"))`

.code80[
```{r, demo3, eval=FALSE, echo=FALSE}
table_usafacts <- bow(url = "https://usafacts.org/visualizations/coronavirus-covid-19-spread-map/state/minnesota") %>%
  scrape() %>% 
  html_elements(css = "table") %>% 
  html_table()

covidMN <- table_usafacts[[2]]

# tidy it up
covidMN_final <- covidMN %>% janitor::clean_names() %>%
  mutate(cases = as.numeric(str_remove(cases, ","))) %>%
  mutate(county = str_remove(county, " County"))
```
]

---

# Glimpse of data

```{r, echo=FALSE}
table_usafacts <- bow(url = "https://usafacts.org/visualizations/coronavirus-covid-19-spread-map/state/minnesota") %>%
  scrape() %>% 
  html_elements(css = "table") %>% 
  html_table()

covidMN <- table_usafacts[[2]]

# tidy it up
covidMN_final <- covidMN %>% janitor::clean_names() %>%
  mutate(cases = as.numeric(str_remove(cases, ","))) %>%
  mutate(county = str_remove(county, " County"))

# leaflet
MNcounty <- map("county","Minnesota", plot=FALSE, fill=TRUE)
MNmap <- map2SpatialPolygons(MNcounty, IDs = MNcounty$names)

map <- SpatialPolygonsDataFrame(MNmap, covidMN_final, match.ID = FALSE)

#pal <- colorNumeric(palette = "viridis", alpha = TRUE, domain = map$cases)

bins <- c(0, 1000, 5000, 10000, 100000, Inf)
pal <- colorBin("viridis", domain = map$cases, bins = bins)

labels <- sprintf("<strong> %s </strong> <br/> Observed: %s", map$county, map$cases) %>%
  lapply(htmltools::HTML)

```


```{r}
glimpse(covidMN_final)
```


---

`r chunk_reveal("demo4", widths = c(40, 40), font_size_code="80%", title = "# Objects needed for Plotting", display_type = c("code"))`


```{r, demo4, eval=FALSE, echo=FALSE}
# leaflet
library(maps)
library(sp)

MNcounty <- map("county", "Minnesota", plot=FALSE, fill=TRUE)
MNmap <- map2SpatialPolygons(MNcounty, IDs = MNcounty$names)

map <- SpatialPolygonsDataFrame(MNmap, covidMN_final, match.ID = FALSE)

pal1 <- colorNumeric(palette = "viridis", alpha = TRUE, domain = map$cases)

bins <- c(0, 1000, 5000, 10000, 100000, Inf)
pal2 <- colorBin("viridis", domain = map$cases, bins = bins)

labels <- sprintf("<strong> %s </strong> <br/> Observed: %s", map$county, map$cases) %>%
  lapply(htmltools::HTML)
```

---

`r chunk_reveal("demo5", widths = c(40, 40), font_size_code="80%", title = "# Final plotting code", display_type = c("code"))`


```{r, demo5, eval=FALSE, echo=FALSE}

l <- leaflet(map) %>% addTiles() %>% setView(lng = -93.1616, lat = 44.4583, zoom = 5) 

l %>% addPolygons(color = "grey", weight = 1,
                  fillColor = ~pal(cases), fillOpacity = 0.7,
                  highlightOptions = highlightOptions(weight = 5),
                  label = labels) %>%
                  addLegend(pal = pal2, values = ~cases, opacity = 0.5, 
                            title = "Observed Cases", 
                            position = "bottomright")

```

---

# Interactive leaflet map

```{r, echo=FALSE, fig.height=6, fig.width=5}

l <- leaflet(map) %>% addTiles() %>% setView(lng = -93.1616, lat = 46, zoom = 6) 

l %>% addPolygons(color = "grey", weight = 1,
                  fillColor = ~pal(cases), fillOpacity = 0.7,
                  highlightOptions = highlightOptions(weight = 5),
                  label = labels) %>%
                  addLegend(pal = pal, values = ~cases, opacity = 0.5, 
                            title = "Observed Cases", 
                            position = "bottomright")

```


---

# Store leaflet map as html

```{r, eval=FALSE}
library(htmlwidgets)
saveWidget(l, file="Minnesota.html")
```

--

> Please clone the repository on [interactive shiny examples](https://github.com/stat220/17-interactive-shiny-examples) to your local folder. For the remainder of the class, let's go over to in the class activity .Rmd file and practice more examples together.



