---
title: "Two Quantitative Variables: Association"
subtitle: "<br/> STAT 120"
author: "Bastola"
date: "`r format(Sys.Date(), ' %B %d %Y')`"
output:
  xaringan::moon_reader:
    css: ["default", css/xaringan-themer-solns.css, css/my-theme.css, css/my-font.css]
    lib_dir: libs
    chakra: libs/remark-latest.min.js
    seal: false
    nature:
      highlightStyle: googlecode  #http://arm.rbind.io/slides/xaringan.html#77 # idea, magula, googlecode, default
      highlightLines: true
      highlightLanguage: ["r", "css", "yaml"]
      countIncrementalSlides: true
      slideNumberFormat: "%current%"
      titleSlideClass: ["left", "middle", "inverse"]
      ratio: "16:9"
    includes:
      in_header: header.html  
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
options(htmltools.preserve.raw = FALSE)
options(ggrepel.max.overlaps = Inf)

knitr::opts_chunk$set(echo = TRUE, 
                      dev = 'svg',
                      collapse = TRUE, 
                      comment = NA,  # PRINTS IN FRONT OF OUTPUT, default is '##' which comments out output
                      prompt = FALSE, # IF TRUE adds a > before each code input
                      warning = FALSE, 
                      message = FALSE,
                      fig.height = 3, 
                      fig.width = 4,
                      out.width = "100%"
                      )



# load necessary packages
library(tidyverse)
library(countdown)
library(mosaic)
library(ggthemes)
library(xaringanExtra)
library(forcats)
xaringanExtra::use_panelset()
xaringanExtra::use_tachyons()
xaringanExtra::use_clipboard()
xaringanExtra::use_extra_styles(
  hover_code_line = TRUE,         #<<
  mute_unhighlighted_code = TRUE  #<<
)
library(flipbookr)
library(patchwork)
library(Lock5Data)

# Set ggplot theme
theme_set(theme_tufte(base_size = 10))

yt <- 0

# read.csv("https://raw.githubusercontent.com/deepbas/statdatasets/main/APM_DougEvansCases.csv")
# renderthis::to_pdf(from = "Day4.html", complex_slides = TRUE, partial_slides = TRUE)
```



```{r xaringanExtra-clipboard, echo=FALSE}
htmltools::tagList(
  xaringanExtra::use_clipboard(
    button_text = "<i class=\"fa fa-clipboard\"></i>",
    success_text = "<i class=\"fa fa-check\" style=\"color: #90BE6D\"></i>",
    error_text = "<i class=\"fa fa-times-circle\" style=\"color: #F94144\"></i>"
  ),
  rmarkdown::html_dependency_font_awesome()
)
```


layout: true
  
<!-- <div class="my-footer"><span>Stat 230</span></div> -->
<!-- this adds the link footer to all slides, depends on my-footer class in css-->

---

class: title-slide, middle
<!-- background-image: url("assets/title-image2.jpg") -->
background-position: 10% 90%, 100% 50%
background-size: 160px, 100% 100%

# .fancy[Two Quantitative Variables: Association]

### .fancy[Stat 120]

`r format(Sys.Date(), ' %B %d %Y')`

---

# Describing associations between two quantitative variables

.bql[
.bold[Data]: each case $i$ has two measurements
- $x_i$ is explanatory variable
- $y_i$ is response variable
]

--

<br>

.bq.font80[
A .bold[scatterplot] is the plot of $(x_i, y_i)$.
- form? linear or non-linear
- direction? positive, negative, no association
- strength? amount of variation in $y$ around a "trend"
]

---

# Example: Associations in Car dataset 


<center>
<img src="images/linearassociation.png" width="80%" height="80%"><br>
<a>Various Associations of quantitative variables in Cars data</a>
</center>


---

# Direction

.bql[
.bold[positive association:] as $x$ increases, $y$ increases 

- age of the husband and age of the wife
- height and diameter of a tree
]  
 
--

<br>

.bql[    
.bold[negative association:] as $x$ increases, $y$ decreases
- number of cigarettes smoked per day and lung capacity
- depth of tire tread and number of miles driven on the tires
]

---

class: middle

# Correlation Coefficients

.pull-left-60[
.bql.font70[
.bold[Correlation coefficient:] denoted $r$ (sample) or $\rho$ (population)

- Strength of linear association
    - $r\approx \pm 1:$ strong
    - $r\approx 0:$ weak
  
- Direction of linear association
    - $r > 0:$ positive
    - $r < 0:$ negative
]
]



.pull-right-40[
<br>
<br>

.blue-h[Correlation can be heavily affected by outliers. Plot your data!]

## R-code:

```{r, eval=FALSE}
# order of x and y doesn't matter!
cor(data$x, data$y)  
```

]

---

## Car Correlations

<center>
<img src="images/carcorrelations.png" width="80%" height="75%"><br>
<a>Correlations of various variables in Cars data</a>
</center>

---


# Linear Regression

.center.blue-h[.b[Goal:] To find a straight line that best fits the data in a scatterplot]
.bql.font80[
The estimated regression line is $\hat{y} = a + bx$
- x is the explanatory variable
- $\hat{y}$ is the predicted response variable.
]
<br>
.bqt.font80[
.bold[Slope:] increase in predicted $y$ for every unit increase in $x$
$$ b = \frac{\text{change }\hat{y}}{\text{change } x} $$

.bold[Intercept:] predicted $y$ value when $x = 0$
 $$ \hat{y} = a + b(0) = a $$]

---

class: middle

# Residuals

.pull-left.font80[
.bql[
- .bold[Geometrically], residual is the vertical distance from each point to the line

- .bold[Mathematically], $y - \hat{y}$ is the residual of $y$ at $x$

- If the model is linear, measure how much variation in the response is explained by the model.
]
]
.pull-right[
<br>
<center>
<img src="images/residuals.png" width="115%" height="105%"><br>
<a>Residuals</a>
</center>
]

---

class: middle

# Regression Caution!

.bql.font80[
- Do not use the regression equation or line to predict values far from those that were used to create it --> .bold[Extrapolation!]

- The regression line/equation should only be used if the association is approximately linear

- .b[Unlike correlation], for linear regression it does matter which is the explanatory variable and which is the response
]

---

class: middle

# Presence of Outliers 


.pull-left-40[

<br>

.bql[
.bold[Outliers] can be very influential on the regression line

- remove the points and see if the regression line changes significantly 
]

]

.pull-right-60[

```{r,  echo=FALSE, fig.align='center', fig.width=4, fig.height=3.5, out.width="90%"}
library(ggplot2)
library(dplyr)

# Load the data
sat <- read.csv("https://math.carleton.edu/Stats215/RLabManual/sat.csv")

# Filter for Midwest region
sat.MW <- filter(sat, region == "Midwest")

# Linear models
sat.lm <- lm(math ~ verbal, data = sat.MW)
sat.lm.noIO <- lm(math ~ verbal, data = sat.MW %>% slice(-c(2, 10)))

# Coefficients for the line without IN and OH
coeffs_noIO <- coef(sat.lm.noIO)

# Create ggplot
p <- ggplot(sat.MW, aes(x = verbal, y = math)) +
  geom_point(shape = 19) +
  geom_smooth(method = "lm", se = FALSE, aes(color = "With IN and OH"), linetype = "solid") +
  geom_segment(aes(x = min(verbal), y = coeffs_noIO[1] + coeffs_noIO[2] * min(verbal),
                   xend = max(verbal), yend = coeffs_noIO[1] + coeffs_noIO[2] * max(verbal),
                   color = "Without IN and OH"), linetype = "solid") +
  scale_color_manual("Legend", values = c("With IN and OH" = "black", "Without IN and OH" = "red")) +
  ggtitle("Average SAT for Midwest States") +
  xlab("Verbal SAT scores") +
  ylab("Math SAT scores") +
  theme_minimal() +
  theme(text = element_text(size = 8), legend.position = "bottom") +
  annotate("text", x = 540, y = 535, label = "OH", size = 3) +
  annotate("text", x = 500, y = 495, label = "IN", size = 3)

# Show the plot
print(p)

```
]

---

# Regression line of Blood Alcohol Content (BAC) data

```{r, echo=FALSE}
bac <- read.csv("http://math.carleton.edu/kstclair/data/BAC.csv")
```

.pull-left-60[

.hljs[Regression of BAC on number of beers]

.code70[
```{r}
bac.lm <- lm(BAC ~ Beers, data=bac)
summary(bac.lm)
```
]
]

.pull-right-40[
<br>
<br>
.bq.font80[
Slope, $b= 0.0180$: 

- `Estimate` column and `Beers` row

Intercept, $a = -0.0127$: 

- `Estimate` column and `Intercept` row
]
]


---


# Regressing BAC on number of beers

$$ \widehat{BAC} = -0.0127 + 0.0180(Beers) $$

.bql[
Slope Interpretation?
- Each additional beer consumed is associated with a $0.0180$ unit increase in BAC
]

--

<br>

.bql[
y-intercept Interpretation?
- Predicted BAC with 0 beers consumed 
]

---

# Regressing BAC on number of beers

.pull-left[
  
```{r, echo=TRUE, eval=FALSE}
library(ggplot2)
ggplot(bac, aes(x = Beers, y = BAC)) +
  geom_point(shape = 19) +
  geom_smooth(method = "lm", se = FALSE)
```
  
> If your friend drank 2 beers, what is your best guess at their BAC after 30 minutes?
 $$\widehat{BAC} = -0.0127 + 0.0180(2) = 0.023$$
  
]

.pull-right[
```{r, echo=FALSE, eval=TRUE, fig.align='center', fig.width=4.5, fig.height=4.5, out.width="120%"}
library(ggplot2)


# Create ggplot
p <- ggplot(bac, aes(x = Beers, y = BAC)) +
  geom_point(shape = 19) +
  geom_smooth(method = "lm", se = FALSE) +
  ggtitle("Beer and BAC") +
  xlab("Number of beers drank") +
  ylab("Blood Alcohol Content") +
  theme_minimal() +
  theme(
    text = element_text(size = 8),
    axis.text = element_text(size = 7),
    axis.title = element_text(size = 7),
    plot.title = element_text(size = 7)
  )

# Show the plot
print(p)

```
]

---


# Regressing BAC on number of beers

.pull-left[

<br>
<br>

> Find the residual for the student in the dataset who drank 2 beers and had a BAC of 0.03.
> The residual is about $y - \hat{y} = 0.03 - 0.023 = 0.007$

]

.pull-right[
 
```{r, echo = FALSE, eval=TRUE, fig.align='center', fig.width=4.5, fig.height=4.5, out.width="120%" }
library(ggplot2)

# Assuming you've read the data into a data frame named bac and fitted a linear model bac.lm
bac <- read.csv("http://math.carleton.edu/kstclair/data/BAC.csv")
bac.lm <- lm(BAC ~ Beers, data=bac)

# Create ggplot
p <- ggplot(bac, aes(x = Beers, y = BAC)) +
  geom_point(shape = 19) +
  geom_smooth(method = "lm", se = FALSE) +
  geom_segment(aes(x = 2, y = 0, xend = 2, yend = 0.023), linetype = 2, color = "red") +
  geom_segment(aes(x = 0, y = 0.023, xend = 2, yend = 0.023), linetype = 2, color = "red") +
  geom_segment(aes(x = 2, y = 0.023, xend = 2, yend = 0.03), linetype = 3, color = "red") +
  geom_segment(aes(x = 0, y = 0.03, xend = 2, yend = 0.03), linetype = 3, color = "blue") +
  geom_text(aes(x = 1, y = 0.018, label = "0.023"), color = "red", size = 3) +
  geom_text(aes(x = 1, y = 0.035, label = "0.03"), color = "blue", size = 3) +
  ggtitle("Beer and BAC") +
  xlab("Number of beers drank") +
  ylab("Blood Alcohol Content") +
  theme_minimal() +
  theme(
    text = element_text(size = 8),
    axis.text = element_text(size = 7),
    axis.title = element_text(size = 7),
    plot.title = element_text(size = 7)
  )

# Show the plot
print(p)

```

]

---

# R-squared
.bql[
.bold[R-squared] is proportion (or percentage) of variability observed in the response y which can be explained by the explanatory variable x.
]

.hljs[
$R^2 = r^2$ in simple linear regression model (One explanatory variable)]

.bq.font90[
.bold[BAC] : $R^2 = 0.7998$

- The number of beers consumed explains about 80.0% of the observed variation in BAC
- What factors (variables) besides number of beers drank might explain the
other roughly 20% of variation in BAC?
]

---

class: middle

# R-squared

Called .bold[Multiple R-squared] in the summary output

.code80[
```{r}
summary(bac.lm)
```
]


---

class: middle

# Adding a categorical variable (confounding variable)

.pull-left[

```{r, echo = FALSE, eval=TRUE, fig.align='center', fig.width=4, fig.height=4, out.width="80%"}
ggplot(bac, aes(x = Beers, y = BAC, color = Sex)) + 
  geom_point() 
```

]

.pull-right[

```{r, eval=FALSE}
ggplot(bac, aes(x = Beers, y = BAC, color = Sex)) + 
  geom_point()
```

.bq.font90[
- Visually split the data by Sex
- Potentially different trends
]
]
  
---

class: middle

# Adding a categorical variable (confounding variable)

.pull-left[

```{r, echo = FALSE, fig.align='center', fig.width=4, fig.height=4, out.width="85%"}
ggplot(bac, aes(x = Beers, y = BAC, color = Sex)) + 
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE)
```

]

.pull-right[

```{r, eval=FALSE}
ggplot(bac, aes(x = Beers, y = BAC, color = Sex)) + 
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE)
```


.bql[
Visually infer difference in Sex:
- Different correlation
- Different intercepts
]
]

---

# Adding a categorical variable: stats by group

.bq.font90[Can also use `filter` function available under `dplyr` package to divide responses into the groups of interest]

```{r}
library(dplyr)
table(bac$Sex)
```

--

```{r}
bac_female <- filter(bac, Sex == "female")
bac_male <- filter(bac, Sex == "male")
```

--

```{r}
cor(bac_female$BAC,bac_female$Beers)
cor(bac_male$BAC,bac_male$Beers)
```

---

class: middle

# Outliers: Average SAT by state


.code80[
```{r}
sat <- read.csv("https://math.carleton.edu/Stats215/RLabManual/sat.csv")
sat.MW <- filter(sat, region == "Midwest") # just MW states
cor(sat.MW$math, sat.MW$verbal)

sat.lm <- lm(math ~ verbal, data=sat.MW)
sat.lm
```

```{r}
summary(sat.lm)$r.squared
```

]

.out-t[Correlation = 0.9732, Regression Slope = 1.0469, R-squared = 94.7%]

---

class: middle

# Outliers: Average SAT by state, excluding Indiana and Ohio

.code70[
```{r}
library(dplyr)
# Find the rows where 'verbal' is less than 550 using filter
filtered_data <- filter(sat.MW, verbal < 550)

# Exclude data corresponding to specific indices and calculate correlation
filtered_sat_MW <- sat.MW %>%  slice(-c(2, 10))
cor_result <- cor(filtered_sat_MW$math, filtered_sat_MW$verbal)

sat.lm.noIO <- lm( math ~ verbal, data=sat.MW, subset = -c(2,10))
sat.lm.noIO
```

```{r}
summary(sat.lm.noIO)$r.squared
```
]

.out-t[Correlation = 0.8465, Regression slope = 0.9956 , R-squared = 71.66%]

---

class: action

# <i class="fa fa-pencil-square-o" style="font-size:48px;color:purple">&nbsp;Your&nbsp;Turn&nbsp;`r (yt <- yt + 1)`</i>    

.pull-left-40[
![](https://media.giphy.com/media/RKApDdwsQ6jkwd6RNn/giphy.gif)
]
.pull-right-60[

<br>
<br>
.bq[

<br>

Go over some examples in [class helper page](https://stat120-winter24.netlify.app/) and complete the class activity and let me know if you have any questions!

]
]

`r countdown(minutes = 15, seconds = 00, top = 0 , color_background = "inherit", padding = "3px 4px", font_size = "2em")`


