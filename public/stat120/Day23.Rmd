---
title: "Inference for multiple proportions"
subtitle: "<br/> STAT 120"
author: "Bastola"
date: "`r format(Sys.Date(), ' %B %d %Y')`"
output:
  xaringan::moon_reader:
    css: ["default", css/xaringan-themer-solns.css, css/my-theme.css, css/my-font.css]
    lib_dir: libs
    chakra: libs/remark-latest.min.js
    seal: false
    nature:
      highlightStyle: googlecode  #http://arm.rbind.io/slides/xaringan.html#77 # idea, magula
      highlightLines: true
      highlightLanguage: ["r", "css", "yaml"]
      countIncrementalSlides: true
      slideNumberFormat: "%current%"
      titleSlideClass: ["left", "middle", "inverse"]
      ratio: "16:9"
    includes:
      in_header: header.html
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
options(htmltools.preserve.raw = FALSE)
options(ggrepel.max.overlaps = Inf)

knitr::opts_chunk$set(echo = TRUE, 
                      dev = 'svg',
                      collapse = FALSE, 
                      comment = NA,  # PRINTS IN FRONT OF OUTPUT, default is '##' which comments out output
                      prompt = FALSE, # IF TRUE adds a > before each code input
                      warning = FALSE, 
                      message = FALSE,
                      fig.height = 3, 
                      fig.width = 4,
                      out.width = "100%"
                      )

# load necessary packages
library(tidyverse)
library(dplyr)
library(countdown)
library(ggthemes)
library(xaringanExtra)
library(forcats)
xaringanExtra::use_panelset()
xaringanExtra::use_tachyons()
xaringanExtra::use_clipboard()
xaringanExtra::use_extra_styles(
  hover_code_line = TRUE,         
  mute_unhighlighted_code = TRUE  
)
library(flipbookr)
library(patchwork)
library(DT)
library(knitr)
library(grid)
library(gridExtra)
library(kableExtra)

select <- dplyr::select

# Set ggplot theme
theme_set(theme_tufte(base_size = 10))

yt <- 0

set.seed(1234)



# read.csv("https://raw.githubusercontent.com/deepbas/statdatasets/main/agstrat.csv")

```


```{r xaringanExtra-clipboard, echo=FALSE}
htmltools::tagList(
  xaringanExtra::use_clipboard(
    button_text = "<i class=\"fa fa-clipboard\"></i>",
    success_text = "<i class=\"fa fa-check\" style=\"color: #90BE6D\"></i>",
    error_text = "<i class=\"fa fa-times-circle\" style=\"color: #F94144\"></i>"
  ),
  rmarkdown::html_dependency_font_awesome()
)
```


layout: true
  
---

class: title-slide, middle

# .fancy[Inference for multiple proportions]

### .fancy[Stat 120]

`r format(Sys.Date(), ' %B %d %Y')`

---

class: middle

# Tests for Categorical Variable(s)

.bql[
Chi-square test for association

- Determine if a relationship between two categorical variables is statistically significant
- E.g. Does M&M color distribution depend on type (chocolate vs. peanut)?
]

---

# Chi-square test for association hypothesis

.bqt[Hypotheses look like:

$$H_0: \textrm{two categorical variables are not associated}$$
$$H_A: \textrm{two categorical variables are associated}$$
]

<br>

.hljs[
E.g. Does M&M color distribution depend on type (chocolate vs. peanut)?

$$H_0: \text{there is no association between M&M color and type}$$
$$H_A: \text{there is an association between M&M color and type}$$
]

---

class: middle

# Expected Counts and p-value

.bql.font90[
The expected counts for each combination in a two-way table

$$\textrm{expected count} = \dfrac{\textrm{row total} \times \textrm{column total}}{n}$$


$$\chi^2 = \sum_{\textrm{all cells}}\dfrac{(\textrm{Observed} - \textrm{Expected})^2}{\textrm{Expected}}$$

- Large chi-square test stat values support the .bold[alternative] hypothesis so: $p-value = P(\chi^2 \geq \text{observed } \chi^2)$

- always a .bold[right-tailed] value
]

---

# Chi-Square test for association: P-VALUE

.bqt.font90[.b[randomization/permutation:] simulate new data consistent with $H_0$ and recompute the $\chi^2$ test stat
  - .bold[Association:] permute the values of one variable column to break the link that could exist in the data between both variables
  ]
  
--

<br>

.bqt.font90[.b[Chi-square distribution (probability model):]
  - .bold[Association:] use $(r-1)(c-1)$ where $r=$ number of rows and $c=$ number of columns
  - need $n$ large enough so expected counts are at least 5
]

---

class: middle

# Example: Does political comfort level depend on religion?

.bq.font90[
$H_0:$ There is no association between religion and comfort level 
  - implies: the distribution of comfort level is the same for all three religion types 
]

<br>

.bq.font90[
$H_A:$ There is an association between religion and comfort level
  - implies: the distribution of comfort level is the different for at least one religion type. 
]


---

###  Association example

```{r, collapse=TRUE}
survey <- read.csv("https://raw.githubusercontent.com/deepbas/statdatasets/main/Survey.csv")
survey %>% dplyr::select(Question.8, Question.9) %>% head(8)
```

--

.font70[
```{r, collapse=TRUE, echo=FALSE}

kableExtra::kable(table(survey$Question.8, survey$Question.9), "html", 
      caption = "Table 1: A two way table of religious preference and political comfortness") %>%
  kable_styling(position = "center")

```
]


---

class: middle


## Association example

```{r, echo=FALSE, fig.width= 8, fig.height=3.7}
library(ggplot2)
ggplot(survey, aes(x=Question.8, fill=Question.9)) +
  geom_bar(position="fill") +
  labs(fill = "Comfort level", x = "Religious level", y = "proportion", title="Comfort level by religious level")+
  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 16))
```


---

## Association Example


.bql.font80[EDA for two categorical variables
- drop missing values, rename column names
- change/shorten comfort level names 
- reorder the levels
]

<br>

--

```{r, echo=FALSE}
# and drop the rows containing missing values using the tidyr package
survey <- survey %>% tidyr::drop_na()

# rename comfort level using fct_recode() from the forcats package
survey <- survey %>% mutate(comfortness = forcats::fct_recode(Question.9, 
                          `rarely` = "rarely, if ever, comfortable",
                          `sometimes` = "sometimes comfortable",
                          `almost always` = "almost always comfortable"),
                          comfortness = forcats::fct_relevel(comfortness, 
                                                             "almost always",
                                                             "sometimes", 
                                                             "rarely"))

# rename comfort level using fct_recode() from the forcats package
survey <- survey %>%mutate(religiousness = forcats::fct_recode(Question.8, 
                          `not religious` = "not religious",
                          `religious not active` = "religious but not actively practicing",
                          `religious active` = "religious and actively practicing my religion"),
                          religiousness = forcats::fct_relevel(religiousness,
                                                               "not religious",
                                                               "religious not active",
                                                               "religious active"))
```


.out-t[ Observed distribution of political comfort level given religiousness]

```{r, collapse=TRUE, echo=FALSE}
kableExtra::kable(table(survey$religiousness, survey$comfortness), 
                  caption = "Table 2: A two way table of religious preference and political comfortness (cleaned-up factors)") %>%
  kable_styling(position = "center")
```


---

class: middle

#  Association example

```{r, collapse=TRUE}
counts <- table(survey$religiousness, survey$comfortness)
counts
```


```{r, collapse=TRUE}
prop.table(counts,1)  
```

.hljs[There is a much higher rate of "almost always" comfortable for the not religious respondents (`r round(prop.table(counts,1),3)[1,1]*100`%) than those that are religious (not active: `r round(prop.table(counts,1),3)[2,1]*100`%; active: `r round(prop.table(counts,1),3)[3,1]*100`%).] 

---

# Association example

```{r, echo=FALSE, fig.width= 8, fig.height=3.7}
ggplot(survey, aes(x=religiousness, fill=comfortness)) +
  geom_bar(position="fill") +
  labs(fill = "Comfort level", x = "Religious level", y = "proportion", title="Comfort level by religious level") +
  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 16))
```

---

class: middle

#  Association example

.bql.font80[Expected counts assuming no association (null)?
  - expected number of respondents who are "not religious" and "almost always comfortable"?
  - is .bold[not] 1/9 of all respondents!
]

---

class: middle

#  Association example

.bqt.font90[
- There are `r sum(counts[1,])` "not religious" respondents (row total)

- The overall rate (ignoring religion) of "almost always comfortable" is $\dfrac{`r sum(counts[,1])`}{`r sum(counts)`}$, or about  `r round(prop.table(table(survey$Question.9))[1],3)*100`%. 

- If religion isn't related to comfort level, the expected number is about
$$\textrm{expected count} = \dfrac{\textrm{row total} \times \textrm{column total}}{n} = `r sum(counts[1,])` \times \dfrac{`r sum(counts[,1])`}{`r sum(counts)`} = `r round(sum(counts[1,])*sum(counts[,1])/sum(counts),3)`$$
]

---

class: middle

# Association example


.hljs[Chi-square contribution for "not religious" and "almost always comfortable" cell?]


.bql.font80[

```{r, echo=FALSE}
exp <- table(survey$religiousness)[1]*table(survey$comfortness)[1]/sum(counts)
contr <- (counts[1,1] - exp)^2/exp
```


- The contribution to the chi-square test stat from this category is `r round(contr, 2)`.

$$\dfrac{(`r counts[1,1]` - `r round(exp,3)`)^2}{`r round(exp,3)`} = `r round(contr,3)`$$
]


---

class: middle

# Association example: `chisq.test`

```{r}
ComfortReligion <- chisq.test(survey$religiousness, survey$comfortness)
ComfortReligion
```

.bql.font90[
- The test stat value is `r round(ComfortReligion$statistic,3)`. 
- There are 3 categories for each variable, so the degrees of freedom will be $df = (3-1)(3-1) = 4$. 
]

---

class: middle

# Association example

.bq.font90[
- .bold[Interpret:]  If there is no association between comfort level and religiousness, then we would see a chi-square test stat of `r round(ComfortReligion$statistic,3)`, or one even larger, only about `r round(ComfortReligion$p.value,4)*100`% of the time. 

- .bold[Conclusion:] We have strong evidence that there is an association between political comfort level and religiousness ( $\chi^2 = `r round(ComfortReligion$statistic,3)`$, df = `r ComfortReligion$parameter`, p-value = 0.0007).

]

---

class: middle

# Association example: Check Assumptions!


.hljs[Are the expected counts above 5?]


```{r}
ComfortReligion <- chisq.test(survey$religiousness, survey$comfortness)
ComfortReligion$expected
```

---

# Association example

.bq.font90[
- If we get a red warning when running `chisq.test`, it usually means the sample size conditions aren't met to use the chi-square model. 

- Instead run a randomization test with
]


```{r}
chisq.test(survey$religiousness, survey$comfortness, 
           simulate.p.value = TRUE)
```



---

# Association example

.bqt.font80[Describe the association! 

  - which groups have the most different comfort levels?
]
    
```{r, echo=FALSE, fig.width= 5, fig.height=2.5, out.width="70%", fig.align='center'}
library(ggplot2)
ggplot(survey, aes(x=religiousness, fill=comfortness)) +
  geom_bar(position="fill") +
  labs(fill = "Comfort level", x = "Religious level", y = "proportion", title="Comfort level by religious level")+
  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 16))

```

---

# Association example

.bql.font80[
95% CI for the difference in the true proportions of "rarely comfortable" people in the not religious and actively religious groups.
$$p = \textrm{proportion rarely comfortable}$$

  - 95% CI for $p_{not.relig} - p_{active}$
]

```{r, collapse=TRUE}
table(survey$religiousness)
```
$$n_{not.relig} = `r sum(counts[1,])` \ \ \ \ \ \ n_{active} = `r sum(counts[3,])`$$

---

class: middle

# Association example


.pull-left[

```{r, collapse=TRUE}
knitr::kable(counts)
```

]
.pull-right[
```{r, collapse=TRUE}
knitr::kable(round(prop.table(counts,1),3))
```

]


$$\hat{p}_{not.rel} = \dfrac{`r counts[1,3]`}{`r sum(counts[1,])`} = `r prop.table(counts,1)[1,3]`$$
$$\hat{p}_{active} = \dfrac{`r counts[3,3]`}{`r sum(counts[3,])`} = `r prop.table(counts,1)[3,3]`$$

---

class: middle

# Association example

.bq.font90[
95% CI for $p_{not.relig} - p_{active}$

\begin{align*}
`r prop.table(counts,1)[1,3]` - `r prop.table(counts,1)[3,3]`  \pm & 1.96 \sqrt{\dfrac{`r prop.table(counts,1)[1,3]`(1-`r prop.table(counts,1)[1,3]`)}{`r sum(counts[1,])`} + \dfrac{`r prop.table(counts,1)[3,3]`(1-`r prop.table(counts,1)[3,3]`)}{`r sum(counts[3,])`}} \\
`r prop.table(counts,1)[1,3] - prop.table(counts,1)[3,3]`  \pm & 1.96 (`r sqrt( prop.table(counts,1)[1,3]*(1- prop.table(counts,1)[1,3])/sum(counts[1,]) + prop.table(counts,1)[3,3]*(1- prop.table(counts,1)[3,3])/sum(counts[3,]))`) \\
(`r prop.table(counts,1)[1,3] - prop.table(counts,1)[3,3] - 1.96*sqrt( prop.table(counts,1)[1,3]*(1- prop.table(counts,1)[1,3])/sum(counts[1,]) + prop.table(counts,1)[3,3]*(1- prop.table(counts,1)[3,3])/sum(counts[3,]))`, &  `r prop.table(counts,1)[1,3] - prop.table(counts,1)[3,3] + 1.96*sqrt( prop.table(counts,1)[1,3]*(1- prop.table(counts,1)[1,3])/sum(counts[1,]) + prop.table(counts,1)[3,3]*(1- prop.table(counts,1)[3,3])/sum(counts[3,]))`)
\end{align*}


```{r, echo  = FALSE}
CI <- prop.table(counts,1)[1,3] - prop.table(counts,1)[3,3] + c(-1,1)* 1.96*sqrt( prop.table(counts,1)[1,3]*(1- prop.table(counts,1)[1,3])/sum(counts[1,]) + prop.table(counts,1)[3,3]*(1- prop.table(counts,1)[3,3])/sum(counts[3,]))
```

]


.hljs[
I am 95% confident that the percentage of all non-religious students who are  rarely comfortable is between `r round(-CI[2]*100,1)` to `r round(-CI[1]*100,1)` percentage points lower than the actively religious students. 
]


---


class: action

# <i class="fa fa-pencil-square-o" style="font-size:48px;color:purple">&nbsp;Your&nbsp;Turn&nbsp;`r (yt <- yt + 1)`</i>    


.pull-left-40[
![](https://media.giphy.com/media/RKApDdwsQ6jkwd6RNn/giphy.gif)
]
.pull-right-60[

<br>
.bql[
- Let's go over to the [course helper page](https://stat120-fall23.netlify.app/)
- Please do the class activity and let me know if you have any questions
- Feel free to talk to your neighbor
]
]

`r countdown(minutes = 10, seconds = 00, top = 0 , color_background = "inherit", padding = "3px 4px", font_size = "2em")`

