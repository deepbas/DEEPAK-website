---
title: "Multiple Linear Regression (MLR) Models"
subtitle: "<br/> STAT 230"
author: "Bastola"
date: "`r format(Sys.Date(), ' %B %d %Y')`"
output:
  xaringan::moon_reader:
    css: ["default", css/xaringan-themer-solns.css, css/my-theme.css, css/my-font.css]
    lib_dir: libs
    chakra: libs/remark-latest.min.js
    seal: false
    nature:
      highlightStyle: googlecode  #http://arm.rbind.io/slides/xaringan.html#77 # idea, magula
      highlightLines: true
      highlightLanguage: ["r", "css", "yaml"]
      countIncrementalSlides: true
      slideNumberFormat: "%current%"
      titleSlideClass: ["left", "middle", "inverse"]
      ratio: "16:9"
    includes:
      in_header: header.html
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
options(htmltools.preserve.raw = FALSE)
options(ggrepel.max.overlaps = Inf)

knitr::opts_chunk$set(echo = TRUE, 
                      dev = 'svg',
                      collapse = FALSE, 
                      comment = NA,  # PRINTS IN FRONT OF OUTPUT, default is '##' which comments out output
                      prompt = FALSE, # IF TRUE adds a > before each code input
                      warning = FALSE, 
                      message = FALSE,
                      fig.height = 3, 
                      fig.width = 4,
                      out.width = "100%"
                      )

# load necessary packages
library(Sleuth3)   # Data-set for Sleuth
library(tidyverse)
library(dplyr)
library(countdown)
library(mosaic)
library(ggthemes)
library(xaringanExtra)
library(forcats)
xaringanExtra::use_panelset()
xaringanExtra::use_tachyons()
xaringanExtra::use_clipboard()
xaringanExtra::use_extra_styles(
  hover_code_line = TRUE,         #<<
  mute_unhighlighted_code = TRUE  #<<
)
library(flipbookr)
library(patchwork)
library(DT)
library(moderndive)
library(knitr)
library(grid)
library(gridExtra)
library(Stat2Data)

# Set ggplot theme
theme_set(theme_tufte(base_size = 10))

yt <- 0

set.seed(1234)

sim_mlr = function(x1, x2, beta_0 = 2, beta_1 = 3, beta_2 = 2, sigma = 3) {
  n = length(x1)
  epsilon = rnorm(n, mean = 0, sd = sigma)
  y = beta_0 + beta_1 * x1 + beta_2 * x2 + epsilon
  data.frame(predictor1 = x1, predictor2 = x2, response = y)
}

num_obs = 25
x_vals1 = runif(num_obs, 0, 10)
x_vals2 = rbeta(num_obs, 1,5)*10
sim_data = sim_mlr(x1 = x_vals1, x2 = x_vals2, beta_0 = 3, beta_1 = 2, beta_2= 1.6, sigma = 3)


cars_lm <- lm(dist ~ speed, data = cars)

# read.csv("https://raw.githubusercontent.com/deepbas/statdatasets/main/APM_DougEvansCases.csv")

# Get regression table
reg_table_cars <-
  get_regression_table(cars_lm)

# Get regression points
reg_points_cars <- 
  get_regression_points(cars_lm)


energy <- read.csv("https://raw.githubusercontent.com/deepbas/statdatasets/main/EnergySurvey.csv")


# New example

lm_eqn <- function(df){
    m <- lm(df[,2] ~ df[,1], df);
    eq <- substitute(italic(y) == a + b %.% italic(x)*","~~italic(r)^2~"="~r2, 
         list(a = format(unname(coef(m)[1]), digits = 2),
              b = format(unname(coef(m)[2]), digits = 2),
             r2 = format(summary(m)$r.squared, digits = 3)))
    as.character(as.expression(eq));
}

```


```{r xaringanExtra-clipboard, echo=FALSE}
htmltools::tagList(
  xaringanExtra::use_clipboard(
    button_text = "<i class=\"fa fa-clipboard\"></i>",
    success_text = "<i class=\"fa fa-check\" style=\"color: #90BE6D\"></i>",
    error_text = "<i class=\"fa fa-times-circle\" style=\"color: #F94144\"></i>"
  ),
  rmarkdown::html_dependency_font_awesome()
)
```


layout: true
  
---

class: title-slide, middle

# .fancy[Multiple Linear Regression (MLR) Models]

### .fancy[Stat 230]

`r format(Sys.Date(), ' %B %d %Y')`

---

# Overview

.pull-left[
```{r, echo=FALSE, fig.align='center', fig.width=4, fig.height=4, out.width="100%"}
library(gg3D)
ggplot(sim_data, aes(predictor1, y=predictor2, z=response)) + 
  theme_void()+
  axes_3D() +
  stat_3D()
```


]
.pull-right[
<br>
<br>
Today: 
.blockquote-list[
- Multiple predictors 
- Quadratic predictors
- Interactions of predictors
- Interpretation
]

]


---

class: middle

# MLR Variables

.blockquote[

$Y=$ quantitative response
- $x_{1}, \ldots, x_{p}: p$ explanatory (predictor) variables
- $x_{j}$ can be either quantitative or categorical
- we will cover categorical predictors in another lecture!

]

---

# Statistical Modeling

$$Y_i  =  \mu(Y \mid x) +  \epsilon_{i}, \qquad \epsilon_{i} \sim N(0, \sigma)$$

.blockquote[
Simple Linear Regression model mean function:
$$\mu(Y \mid x)=\beta_{0}+\beta_{1} x$$
]


<br>
.blockquote[
Multiple Linear Regression (MLR) model mean function: 

$$\mu(Y \mid x)= \beta_{0}+\beta_{1} x_1 + \beta_{2} x_2 + \cdots$$ 
]


---

class: middle

# MLR: Basic model 

.blockquote-list[
$$\mu(Y \mid x)=\mu_{Y \mid x_{1}, \ldots, x_{p}}=\beta_{0}+\beta_{1} x_{1}+\beta_{2} x_{2}+\cdots \beta_{p} x_{p}$$

- General: $\beta_{j}$ is the change in the mean response for a one unit increase in $x_{j}$ holding all other predictors fixed.
- $\beta_{0}$ : mean response when all predictor values are 0
]

---

class: middle

# MLR: Presence of logged variables

.blockquote[
If $Y$ is logged, then any changes in predictors result in a multiplicative change in the median of $Y$
- If $x$ is unlogged, this interpretation is like the SLR .bold[exponential model]
- If $x$ is also logged, this interpretation is like the SLR .bold[power model]
]


---

class: middle

# MLR: Model interpretation

.blockquote[

- $\beta_{j}$ have the same basic interpretation as in a SLR, holding all other predictors constant!
- E.g. Holding all other predictors fixed, increasing $x_{1}$ by 1 unit results in a $\beta_{1}$ change in the mean of $Y$

$$
\begin{aligned}
\mu\left(y \mid x_{1}+1, x_{2}, \ldots, x_{p}\right) &=\beta_{0}+\beta_{1}\left(x_{1}+1\right)+\beta_{2} x_{2}+\cdots+\beta_{p} x_{p} \\
&=\beta_{0}+\beta_{1} x_{1}+\beta_{1}+\beta_{2} x_{2}+\cdots+\beta_{p} x_{p} \\
&=\mu\left(y \mid x_{1}, x_{2}, \ldots, x_{p}\right)+\beta_{1}
\end{aligned}
$$
]

---

class: middle

# EDA Tools

- Scatterplot matrix: a $p$ by $p$ matrix of scatterplots for all combos of (quantitative) variables in a data frame

```r
pairs(my_data) # base-R
```
- `GGally` package (which is installed on Maize)
  - also includes correlation coefficient and density plots
    
```r
ggpairs(my_data) # includes all variables
```

- select variables (and order)

```r
ggpairs(my_data,
 columns = c("y", "x1", "x2")) # include only y, x1, x2 variables
```

---

class: middle

# EDA tools for MLR

- add SLR line to lower half

```r
ggpairs(my_data,
 columns = c("y", "x1", "x2"),
 lower = list(continuous = "smooth"))
```

- removes error bands from SLR fit

```r
ggpairs(my_data,
 columns = c("y", "x1", "x2"),
 lower = list(continuous = wrap("smooth", se = FALSE)))
```

---

`r chunk_reveal("recs-eda", widths= c(0.5,1), font_size_code="70%", title = "## Example: RECS MLR")`

```{r recs-eda, fig.width = 5, fig.height = 5, include=FALSE}
library(GGally)
ggpairs(energy,
 columns = c("CostTotal", "SqftMeasure", "HHSize"),
 lower = list(continuous = wrap("smooth", se = FALSE)))
```

---


# Example: RECS

.blockquote.font80[Regression of log of energy cost against log of square footage and household size]

<br>

```{r, echo=FALSE}
energy <- energy %>% 
  mutate(logCost = log(CostTotal), 
         logSqft = log(SqftMeasure))

cost_lm1 <- lm(logCost ~ logSqft + HHSize, data = energy)

reg_table <- get_regression_table(cost_lm1)
knitr::kable(reg_table, digits = 5, format = "html")
```

$$\hat{\mu}(\log (\text { Cost }) \mid x)=4.3667+0.3722 \log (\text { Sqft })+0.0839 \text { HHSize }$$
.blockquote-list.font80[
In the original scale of the response

$$
\begin{aligned}
\hat{\operatorname{med}}(\text { Cost } \mid x) &=e^{4.3667+0.3722 \log (\text { Sqft })+0.0839 H H \text { Size }} \\
&=e^{4.3667} \times(S q f t)^{0.3722} \times e^{0.0839 H H \text { Size }}
\end{aligned}
$$
]

---

class: middle

# Example: RECS

$$\hat{\mu}(\log (\text { Cost }) \mid x)=4.3667+0.3722 \log (\text { Sqft })+0.0839 \text { HHSize }$$


$$\hat{\operatorname{med}}(\text { Cost } \mid x) = e^{4.3667} \times(S q f t)^{0.3722} \times e^{0.0839 H H \text { Size }}$$

.blockquote.font80[

- $\hat{\beta}_{1}=0.3722:$ An increase in log of square footage of 1 unit is associated with an estimated $0.3722$ unit increase in the mean of the log of cost, holding household size constant.

- .bold[Power model] effect $2^{0.3722}=1.29:$ A doubling of square footage is associated with an estimated $29 \%$ increase in the median energy cost, holding household size constant.


]
---

class: middle

# Example: RECS


$$\hat{\mu}(\log (\text { Cost }) \mid x)=4.3667+0.3722 \log (\text { Sqft })+0.0839 \text { HHSize }$$

$$\hat{\operatorname{med}}(\text { Cost } \mid x) = e^{4.3667} \times(S q f t)^{0.3722} \times e^{0.0839 H H \text { Size }}$$


.blockquote.font80[

- $\hat{\beta}_{2}=0.0839:$ An increase in household size of 1 person is associated with an estimated $0.0839$ unit increase in the mean of the log of cost, holding square footage constant.

- .bold[Exponential model] effect $e^{0.0839}=1.09$ : An increase in household size of 1 person is associated with an estimated $9 \%$ increase in the median energy cost, holding square footage constant.
]

---

class: middle

# EDA tools for a quadratic model MLR

- We can use `ggplot` to create a quadratic trend line for the regression of `my_y` on `my_x` and `my_x^2`:

```r
ggplot(my_data, aes(x = my_x, y = my_y)) +
 geom_point() + # add data
 geom_smooth(method = "lm",
 formula = y ~ x + I(x^2), # specify lm formula
 se = FALSE )
```

- the `formula` is always written in terms of y and x, regardless of what your response/predictors are named

---

`r chunk_reveal("model-corn", widths = c(1,1.2), font_size_code="60%", title = "## Example: Corn Yield  (Textbook Ex. 9.15)")`

```{r model-corn, fig.width = 3, fig.height = 3.5, out.width = "100%", include=FALSE}
ggplot(ex0915, aes(Rainfall, Yield)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ x + I(x^2), se = FALSE) +
  labs(x='Summer rainfall (inches)', 
       y='Annual corn yield (bushels per acre)', 
       title='Quadratic fit') +
  theme(plot.title = element_text(hjust=0.5, size=9, face='bold')) 

```


---

class: middle

# MLR: Quadratic model

$$\mu_{y \mid x_{1}, x_{2}}=\beta_{0}+\beta_{1} x_{1}+\beta_{2} x_{1}^{2}+\beta_{3} x_{2}$$
.blockquote.font90[
- Quadratic with respect to $x_1$
- What happens when we change $x_{1}$ by one unit (holding $x_{2}$ constant)?

$$
\begin{aligned}
\mu\left(y \mid x_{1}+1, x_{2}\right) &=\beta_{0}+\beta_{1}\left(x_{1}+1\right)+\beta_{2}\left(x_{1}+1\right)^{2}+\beta_{3} x_{2} \\
&=\beta_{0}+\beta_{1} x_{1}+\beta_{1}+\beta_{2} x_{1}^{2}+\beta_{2} 2 x_{1}+\beta_{2}+\beta_{3} x_{2} \\
&=\mu\left(y \mid x_{1}, x_{2}\right)+\beta_{1}+\beta_{2}\left(2 x_{1}+1\right)
\end{aligned}
$$
]

---

class: middle

# MLR: Quadratic model

$$\mu\left(y \mid x_{1}+1, x_{2}\right) = \mu\left(y \mid x_{1}, x_{2}\right)+\beta_{1}+\beta_{2}\left(2 x_{1}+1\right)$$

.blockquote[
- $x_{1}$ effect: a 1 unit increase in $x_{1}$ is associated with a $\beta_{1}+\beta_{2}\left(2 x_{1}+1\right)$ change in the mean response holding all other predictors fixed.
- Because of the nonlinear association, the change in $y$ depends on the value of $x_{1}$.
- For example, if $x_{1}$ moves from 1 to 2 units, the mean change is $\beta_{1}+3 \beta_{2}$.
]

---

class: middle

## Example: Corn Yield

```{r, echo=FALSE}
corn_lm <- lm(Yield ~ Rainfall + I(Rainfall^2), data = ex0915)
reg_table_corn <- get_regression_table(corn_lm)
knitr::kable(reg_table_corn, digits = 5,format = "html")
```

<br>

.blockquote[
$$\hat{\mu}_{\text {yield } \mid \text { rain }}=-5.015+6.004(\text { rain })-0.229(\text { rain })^{2}$$
]

---

class: middle

## Example: Corn Yield

.blockquote[
- An increase from 9 to 10 inches of rainfall is associated with a mean yield increase of $1.646$ bushels per acre.
$$6.004-0.229(2 \times 9+1)=1.646$$
- An increase from 14 to 15 inches of rainfall is associated with a mean yield decrease of $0.648$ bushels per acre.
$$6.004-0.229(2 \times 14+1)=-0.648$$
]

---

# EDA tools for an interaction

.blockquote.font90[
- An interaction $x_{1} \times x_{2}$ is warranted if the effect of $x_{1}$ on $y$ depends on the value of $x_{2}$and vice versa
- EDA: we need to look at how $x_{1}$ and $y$ related for cases with the same, or similar, values of $x_{2}$
- If this relationship changes, as $x_{2}$ changes, then an interaction term may improve the model
- `ntile` with $\mathrm{n}=4$ divides cases into 4 equal sized groups based on the $25^{th}$, $50^{th}$, and $75^{th}$ percentiles of $x_2$
]

```{r, eval=FALSE}
ggplot(my_data, aes(x = x1, y = y)) +
 geom_point() +
 geom_smooth(method = "lm", se = FALSE) +
 facet_wrap(~ ntile(x2, n = 4)) #<<
```

---

`r chunk_reveal("perch-interaction", font_size_code="60%", title = "## Example: Perch interaction")`

```{r perch-interaction, fig.width = 3, widths = c(0.5,0.5), fig.height = 3.5, out.width = "100%", include=FALSE}
library(Stat2Data)
data("Perch")
ggplot(Perch, aes(x = Width, y = Weight)) +
 geom_point() +
 geom_smooth(method = "lm", se = FALSE) +
 facet_wrap(~ ntile(Length, n = 4))
```


---

class: middle

# MLR: Interaction model

$$\mu_{y \mid x_{1}, x_{2}}=\beta_{0}+\beta_{1} x_{1}+\beta_{2} x_{2}+\beta_{3} x_{1} x_{2}$$

.blockquote[
- What happens when we change $x_{1}$ by one unit (holding $x_{2}$ constant)?

$$
\begin{aligned}
\mu\left(y \mid x_{1}+1, x_{2}\right) &=\beta_{0}+\beta_{1}\left(x_{1}+1\right)+\beta_{2} x_{2}+\beta_{3}\left(x_{1}+1\right) x_{2} \\
&=\beta_{0}+\beta_{1} x_{1}+\beta_{1}+\beta_{2} x_{2}+\beta_{3} x_{1} x_{2}+\beta_{3} x_{2} \\
&=\mu\left(y \mid x_{1}, x_{2}\right)+\beta_{1}+\beta_{3} x_{2}
\end{aligned}
$$
- The effect of $x_{1}$ on the response, depends on the value of $x_{2}$ !
]

---

class: middle

# Example: Perch

```{r, echo=FALSE}
perch_lm <- lm(Weight ~ Length + Width + Length:Width, data = Perch)
reg_table_perch <- get_regression_table(perch_lm)
knitr::kable(reg_table_perch, digits = 5, format = "html")
```


$$\hat{\mu}_{\text {Weight } \mid x}=113.93-3.48 \text { Length }-94.63 \text { Width }+5.24 \text { Length } \times \text { Width }$$

---

class: middle

# Example: Perch

$$\hat{\mu}_{\text {Weight } \mid x}=113.93-3.48 \text { Length }-94.63 \text { Width }+5.24 \text { Length } \times \text { Width }$$

.blockquote.font80[
- How does width affect mean weight?

  - well, it depends on the length of the fish in a model with a length and width interaction
  
- Holding length fixed, a 1 unit increase in width is associated with an estimated mean change in weight of
$$\hat{\beta}_{\text {Width }}+\hat{\beta}_{\text {Width:Length }} \text { Length }=-94.63+5.24 \text { Length }$$

]

---

# Example: Perch

$$\hat{\mu}_{\text {Weight } \mid x}=113.93-3.48 \text { Length }-94.63 \text { Width }+5.24 \text { Length } \times \text { Width }$$

.blockquote.font80[
- Holding length fixed at $20 \mathrm{~cm}$, a $1 \mathrm{~cm}$ increase in width is associated with an estimated mean increase in weight of

$$\hat{\beta}_{\text {Width }}+\hat{\beta}_{\text {Width:Length }} 20=-94.63+5.24(20)=10.194 \mathrm{grams}$$
- Holding length fixed at $40 \mathrm{~cm}$, a $1 \mathrm{~cm}$ increase in width is associated with an estimated mean increase in weight of

$$\hat{\beta}_{\text {Width }}+\hat{\beta}_{\text {Width:Length }} 20=-94.63+5.24(40)=115.02 \text { grams}$$


- The positive interaction parameter estimate means the effect of width on weight is greater for larger values of length


  - same is true for the effect of length on weight
]

---

### Fitting MLR in R

- .small[Planar] 

.font80[
```r
lm(y~x1 + x2 + x3, data = )
```
]

- .small[Quadratic]

.font80[
```
lm(y ~ x1 + I(x1^2) + x2, data = )
```
]

- .small[Interaction]

.font80[
```
lm(y ~ x1 + x2 + x1:x2, data = ) # explicitly add interaction
lm(y ~ x1*x2, data = ) # equals x1 + x2 + x1:x2
```
]

- .small[Updating an existing model]

.font80[
```
my_lm <- lm(y ~ x1, data = ) # initial model
new_lm <- update(my_lm, . ~ . + x2 + x3) # equals y ~ x1 + x2 + x3
```
]

---

class: action

# <i class="fa fa-pencil-square-o" style="font-size:48px;color:purple">&nbsp;Your&nbsp;Turn&nbsp;`r (yt <- yt + 1)`</i>    


.pull-left-40[
![](https://media.giphy.com/media/RKApDdwsQ6jkwd6RNn/giphy.gif)
]
.pull-right-60[

<br>
<br>

.blockquote[
- Get the in class activity file from [moodle](https://moodle.carleton.edu/)
- We will further practice the concepts seen in the slides
]
]

`r countdown(minutes = 5, seconds = 00, top = 0 , color_background = "inherit", padding = "3px 4px", font_size = "2em")`

