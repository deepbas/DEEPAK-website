---
title: "Logistic regression for binary responses: Model"
subtitle: "<br/> STAT 230"
author: "Bastola"
date: "`r format(Sys.Date(), ' %B %d %Y')`"
output:
  xaringan::moon_reader:
    css: ["default", css/xaringan-themer-solns.css, css/my-theme.css, css/my-font.css]
    lib_dir: libs
    chakra: libs/remark-latest.min.js
    seal: false
    nature:
      highlightStyle: googlecode  #http://arm.rbind.io/slides/xaringan.html#77 # idea, magula
      highlightLines: true
      highlightLanguage: ["r", "css", "yaml"]
      countIncrementalSlides: true
      slideNumberFormat: "%current%"
      titleSlideClass: ["left", "middle", "inverse"]
      ratio: "16:9"
    includes:
      in_header: header.html
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
options(htmltools.preserve.raw = FALSE)
options(ggrepel.max.overlaps = Inf)

knitr::opts_chunk$set(echo = TRUE, 
                      dev = 'svg',
                      collapse = FALSE, 
                      comment = NA,  # PRINTS IN FRONT OF OUTPUT, default is '##' which comments out output
                      prompt = FALSE, # IF TRUE adds a > before each code input
                      warning = FALSE, 
                      message = FALSE,
                      fig.height = 3, 
                      fig.width = 4,
                      out.width = "100%"
                      )

# load necessary packages
library(Sleuth3)   # Data-set for Sleuth
library(tidyverse)
library(dplyr)
library(countdown)
library(mosaic)
library(ggthemes)
library(xaringanExtra)
library(forcats)
xaringanExtra::use_panelset()
xaringanExtra::use_tachyons()
xaringanExtra::use_clipboard()
xaringanExtra::use_extra_styles(
  hover_code_line = TRUE,         
  mute_unhighlighted_code = TRUE  
)
library(flipbookr)
library(patchwork)
library(DT)
library(moderndive)
library(knitr)
library(grid)
library(gridExtra)
library(palmerpenguins)
#library(MASS)
library(broom)
#library(car)

select <- dplyr::select

# Set ggplot theme
theme_set(theme_tufte(base_size = 10))

yt <- 0


# read.csv("https://raw.githubusercontent.com/deepbas/statdatasets/main/agstrat.csv")

```


```{r xaringanExtra-clipboard, echo=FALSE}
htmltools::tagList(
  xaringanExtra::use_clipboard(
    button_text = "<i class=\"fa fa-clipboard\"></i>",
    success_text = "<i class=\"fa fa-check\" style=\"color: #90BE6D\"></i>",
    error_text = "<i class=\"fa fa-times-circle\" style=\"color: #F94144\"></i>"
  ),
  rmarkdown::html_dependency_font_awesome()
)
```


layout: true
  
---

class: title-slide, middle

# .fancy[Logistic regression for binary responses: Model]

### .fancy[Stat 230]

`r format(Sys.Date(), ' %B %d %Y')`

---

# Overview

.pull-left[
```{r, echo=FALSE, fig.align='center', fig.width=4, fig.height=4, out.width="100%"}

sample <- read.csv("https://raw.githubusercontent.com/deepbas/statdatasets/main/Sample4.csv")

# load library ggplot2
library(ggplot2)


# Plot Predicted data and original data points
ggplot(sample, aes(x=Predictor, y=Class)) + geom_point() +
	stat_smooth(method="glm", color="orange", se=FALSE,
				method.args = list(family=binomial))+
  geom_hline(yintercept = 0.5, linetype = "dashed", col = "grey") +
  geom_text(aes(200, 0.52, label =c("Threshold"))) +
  theme_void()

```

]

.pull-right[

Today: 
<br>
<br>
.blockquote-list[
- Binary responses and Bernoulli distribution
- logistic and logit functions
- odds, log odds and odds ratio
- logistic regression model
- interpretation
]

]

---

# Example: Donner party (Case study 20.1)

.blockquote-list[
- Response: `Status` either `Died` or `Survived`
- Explanatory: `Age` and `Sex`
]

.pull-left[

```{r}
library(Sleuth3)
donner <- case2001
head(donner)
```
]

.pull-right[
<br>
<br>
.blockquote[
EDA for associations between:
- `age` and `status`?
- `sex` and `status`?
]
]

---

# Example: Donner party

```{r, eval=FALSE}
library(ggplot2)
ggplot(donner, aes(fill = Status, x = Sex)) +
 geom_bar(position="fill") +
 labs(y="proportion", title="Surival rates by Sex")
```


.pull-left[
```{r, echo=FALSE}
library(ggplot2)
ggplot(donner, aes(fill = Status, x = Sex)) +
 geom_bar(position="fill") +
 labs(y="proportion", title="Surival rates by Sex")+
 theme(plot.title = element_text(hjust = 0.5)) +
 scale_fill_wsj()
```

]
.pull-right[
<br>
.blockquote[
Stacked bar graph shows survival `status` conditioned on `sex`.
- `Females` had higher survival rates than `males`.
]
]

---

# Example: Donner party

```{r}
library(dplyr)
donner %>%
 group_by(Sex) %>% # for each Sex group
 summarize(mean(Status == "Survived")) # proportion who survived
```


.blockquote[
Survival rates conditioned on `sex`
- $2 / 3$ of `females` survived while only $1 / 3$ of `males` did.
]

---

# Example: Donner party

```{r, eval=FALSE}
library(ggplot2)
ggplot(donner, aes(x = Status, y = Age)) +
 geom_boxplot() +
 coord_flip()
```

.pull-left[
```{r, echo=FALSE}
library(ggplot2)
ggplot(donner, aes(x = Status, y = Age)) +
 geom_boxplot() +
 coord_flip()
```

]

.pull-right[
<br>
.blockquote[
`Age` distribution conditioned on `status`
- People who survived have lower median `age` than people who died.
]
]

---

# Example: Donner party


```{r}
donner %>%
 group_by(Status) %>% # for each status group
 summarize(mean(Age), sd(Age), median(Age)) # get summary stats
```

.blockquote.font80[
- `Age` distribution statistics conditioned on `status`
  - The mean `age` of people who `survived` is $27.2$ years compared to $35.5$ for people who `died`.
  
- .bold[Problem:] this EDA has `Status` as the "given" (conditioning) variable

- But we want to model `Status` given `Age`.
]

---

# Example: Donner party


```{r, eval=FALSE}
library(dplyr)
# recode Status as a binary (0 or 1) response:
donner$class_surv <- recode(donner$Status, Survived = 1, Died = 0)
ggplot(donner, aes(x = Age, y = class_surv)) +
 geom_jitter(aes(color=Status), height = .01) 
```


.pull-left[

```{r, echo=FALSE}
donner$class_surv <- recode(donner$Status, Survived = 1, Died = 0)
ggplot(donner, aes(x = Age, y = class_surv)) +
 geom_jitter(aes(color=Status), height = .01)+
    theme(legend.position = "bottom")

```

]

.pull-right[

```{r, collapse=TRUE}
mean(donner$class_surv)
```

.blockquote.font80[
- The mean of a binary variable gives the proportion of 1 's
- As age increases, proportion who survived decreases
]
.out-t.font90[Want to find a function to predict survival given age]



]

---

# The Bernoulli distribution

.blockquote.font90[
- A probability model for a random trial that has two possible outcomes: .bold[success or failure]

- A Bernoulli random variable $Y$
  - $Y=1$ if a success occurred
  - $Y=0$ if a failure occurred
  
- $\pi$ is the probability of success:
$$\pi=P(Y=1)=P(\text { success }), \quad 1-\pi=P(Y=0)=P(\text { failure })$$

- Shorthand notation: $Y \sim \operatorname{Bern}(\pi)$
]

---

# The Bernoulli distribution

.blockquote[
- The expected value, or mean, of $Y$ is equal to
$$E(Y)=\mu=\pi$$
- The standard deviation of $Y$ is equal to
$$S D(Y)=\sigma=\sqrt{\pi(1-\pi)}$$
- The expected value measures the "long run" average value that we would see from $Y$ if we were to repeat the random trial many, many times.
- The standard deviation tells us how these values of $Y$ will vary over these repeated trials.
]

---

class: middle

# The logistic model form

.blockquote[
- Our Bernoulli responses are modeled as a function of predictors $X_{i}=x_{1, i}, \ldots, x_{p, i}$ through the probability of success:
$$Y_{i} \mid X_{i} \stackrel{\text { indep. }}{\sim} \operatorname{Bern}\left(\pi\left(X_{i}\right)\right)$$
- Need to find a function $f()$ that takes in any number and produces a probability between 0 and 1 :
$$\pi\left(X_{i}\right)=f\left(x_{1, i}, \ldots, x_{p, i}\right)$$
]


---

class: middle

# The logistic model form

.pull-left-60[
.blockquote.font90[
- Define $\eta_{i}$ as the linear combination of predictors for case $i$
$$\eta_{i}=\beta_{0}+\beta_{1} x_{1, i}+\cdots+\beta_{p} x_{p, i}$$
- Use a logistic function to relate $X$ to $\pi$ :
$$\pi\left(X_{i}\right)=\frac{e^{\eta_{i}}}{1+e^{\eta_{i}}}=\frac{e^{\beta_{0}+\beta_{1} x_{1, i}+\cdots+\beta_{p} x_{p, i}}}{1+e^{\beta_{0}+\beta_{1} x_{1, i}+\cdots+\beta_{p} x_{p, i}}}$$

]
]

.pull-right-40[

```{r, echo=FALSE}
# Plot Predicted data and original data points
ggplot(sample, aes(x=Predictor, y=Class)) + geom_point() +
	stat_smooth(method="glm", color="orange", se=FALSE,
				method.args = list(family=binomial)) +
  labs(x = "eta",
       y = "logistic(eta)")
```

]

---

`r chunk_reveal("s-curve-donner", widths= c(0.5,0.5), font_size_code="70%", title = "## Example: Donner party model")`

```{r s-curve-donner, fig.width = 3, fig.height = 3.5, out.width = "100%", include=FALSE}
ggplot(donner, aes(x = Age, y = class_surv)) +
  geom_jitter(aes(color=Status), height = .01) +
  # Add estimated logistic curve for the prob of survival.
  geom_smooth(method="glm", 
              method.args = list(family=binomial), 
              se=FALSE) +
 labs(y = "probability of survival") +
 theme(legend.position = "bottom")
```



---

class: middle

# Fitting logistic regression in `R`

.blockquote.font80[
- The basic syntax for a logistic model fit is
]

```r
glm(y ~ x1 + x2, family = binomial, data= )
```


<br>

.blockquote.font80[

- The variable $y$ can be either form:

  - $y$ can be binary $0 / 1$ coded response where 1 is a "success"
  - $y$ can be a factor variable with two levels. The second level is what $\mathrm{R}$ will call a "success"
]

---

# Example: Donner party model

.blockquote[
- The model form logistic regression of survival status on age:
$$\eta=\beta_{0}+\beta_{1} A g e$$
- The second level of Status will be what R defines as a "success"
- So, $\pi$ is the probability of survival
]

```{r}
table(donner$Status) # second level = Survived
```

---

# Example: Donner party model

```{r}
donner_glm1 <- glm(Status ~ Age , family=binomial, data=donner)
library(broom)
tidy(donner_glm1)
```


.blockquote.font90[
- The estimated value of $\eta$ is
$$\hat{\eta}=1.82-0.0665 \text { Age }$$
- What is the estimated probability of survival? of death?
- What are these values for a 20 year old?
]


---

class: middle


# Example: Donner party model

.blockquote.font80[
- the estimated probability of survival is
$$\hat{\pi}(\text { age })=\frac{e^{1.82-0.0665 \text { Age }}}{1+e^{1.82-0.0665 \text { Age }}}$$
- the estimated probability of death is
$$1-\hat{\pi}(\text { age })=1-\frac{e^{1.82-0.0665 \text { Age }}}{1+e^{1.82-0.0665 A g e}}$$
- the estimated probability of survival for a 20 year old is
$$\hat{\pi}(\text { age }=20)=\frac{e^{1.82-0.0665(20)}}{1+e^{1.82-0.0665(20)}}=0.62$$
- the estimated probability of death for a 20 year old is
$$1-\hat{\pi}(\text { age }=20)=1-\frac{e^{1.82-0.0665(20)}}{1+e^{1.82-0.0665(20)}}=0.38$$
]



---

# Example: Donner party model


```{r}
tidy(donner_glm1, conf.int=TRUE)
```

--

.out-t.center[How does a one year increase in age affect survival status?]

---

class: middle


# The logistic model: interpretation

.blockquote[
- To interpret the model, "solve for" $\eta$
- The inverse of the logistic function is called the .bold[logit function]:
$$\eta_{i}=\beta_{0}+\beta_{1} x_{1, i}+\cdots+\beta_{p} x_{p, i}=\log \left(\frac{\pi\left(X_{i}\right)}{1-\pi\left(X_{i}\right)}\right)$$
- .bold[Interpretation]: a one unit increase in $x_{1}$ is associated with an additive $\beta_{1}$ change in the logit function, holding other terms fixed.
- But what does this mean?
]


---

class: middle


# Odds of success

.blockquote[
- odds of success:
$$o d d s=\frac{\pi(X)}{1-\pi(X)}$$
- e.g If $\pi=0.6$, then odds of success is $0.6 / 0.4=1.5$.
- for every 6 successes, we see 4 failures.
]

---

class: middle


# Odds Ratio

.blockquote.font90[
- odds ratio for A vs. $B$ :
$$\frac{\text { odds of success for A }}{\text { odds of success for B }}=\frac{\frac{\pi(A)}{1-\pi(A)}}{\frac{\pi(B)}{1-\pi(B)}}$$

- e.g. If $\pi(A)=0.75$ and $\pi(B)=0.6$, then the odds ratio is 2 . odds ratio for A vs. $\mathrm{B}=\frac{0.75 / 0.25}{0.6 / 0.4}=\frac{3}{1.5}=2$

- Odds of success for group A is 2 times the odds of success in group B.
]


---

class: middle


# Interpretation

.blockquote[
- logit $=\log$ odds of success
$$\eta_{i}=\log \left(\frac{\pi\left(X_{i}\right)}{1-\pi\left(X_{i}\right)}\right)=\beta_{0}+\beta_{1} x_{1, i}+\cdots+\beta_{p} x_{p, i}$$
- The odds of success equals

$$\operatorname{odds}\left(x_{1}, \ldots, x_{p}\right)=\frac{\pi(X)}{1-\pi(X)}=e^{\beta_{0}+\beta_{1} x_{1}+\cdots+\beta_{p} x_{p}}$$
- What happens if we increase $x_{1}$ by one unit, holding other predictors fixed?
]

---

class: middle


# Interpretation

.blockquote[
$\operatorname{odds}\left(x_{1}+1, \ldots, x_{p}\right)=e^{\beta_{0}+\beta_{1}\left(x_{1}+1\right)+\cdots+\beta_{p} x_{p}}=e^{\beta_{0}+\beta_{1} x_{1}+\cdots+\beta_{p} x_{p}} \times e^{\beta_{1}}$
- Increasing $x_{1}$ by one unit has a multiplicative change of $e^{\beta_{1}}$ in the odds of success.
- The multiplicative change of $e^{\beta_{1}}$ is also called the odds ratio for a one unit increase in $x_{1}$
$$\frac{\text { odds of success for } x_{1}+1}{\text { odds of succes for } x_{1}}=\frac{\operatorname{odds}\left(x_{1}+1, \ldots, x_{p}\right)}{\operatorname{odds}\left(x_{1}, \ldots, x_{p}\right)}=e^{\beta_{1}}$$
]

---

class: middle


# Interpretation

.blockquote[
- What if we have a predictor that is logged?
$$\operatorname{odds}\left(x_{1}, \ldots, x_{p}\right)=e^{\beta_{0}+\beta_{1} \log \left(x_{1}\right)+\cdots+\beta_{p} x_{p}}=e^{\beta_{0}} x_{1}^{\beta_{1}} e^{\beta_{2} x_{2}+\cdots+\beta_{p} x_{p}}$$
- Changing $x_{1}$ by a factor of $m$ :
$$\text { odds }\left(m x_{1}, \ldots, x_{p}\right)=e^{\beta_{0}}\left(m x_{1}\right)^{\beta_{1}} e^{\beta_{2} x_{2}+\cdots+\beta_{p} x_{p}}=e^{\beta_{0}} x_{1}^{\beta_{1}} e^{\beta_{2} x_{2}+\cdots+\beta_{p} x_{p}} \times m^{\beta_{1}}$$
results in a multiplicative change of $m^{\beta_{1}}$ in the odds of success.
]


---

class: middle


# Example: Donner party model

```{r}
donner_glm1 <- glm(Status ~ Age , family=binomial, data=donner)
library(broom)
tidy(donner_glm1)
```

.blockquote.font80[
- The estimated log odds of survival is
$$\operatorname{logit}(\hat{\pi}(a g e))=\log \frac{\hat{\pi}(\text { age })}{1-\hat{\pi}(a g e)}=1.82-0.0665 \text { Age }$$
- What is the estimated odds of survival? of death?
- What are these values for a 20 year old?
]

---

class: middle


# Example: Donner party model

.blockquote.font80[
- the estimated odds of survival is
$$\widehat{\text { odd }(\text { age })}=\frac{\hat{\pi}(\text { age })}{1-\hat{\pi}(\text { age })}=e^{1.82} e^{-0.0665 \mathrm{Age}}$$
- the estimated odds of death is
$$\widehat{\text { odds.death }(\text { age })}=\frac{1-\hat{\pi}(\text { age })}{\hat{\pi}(\text { age })}=e^{-1.82} e^{0.0665 \text { Age }}$$
- the estimated odds of survival for a 20 year old is
$$\widehat{\text { odds }(\text { age }=20)}=\frac{\hat{\pi}(\text { age }=20)}{1-\hat{\pi}(\text { age }=20)}=e^{1.82} e^{-0.0665(20)}=1.632$$
- the estimated odds of death for a 20 year old is

$$\widehat{\text { odds.death(age}=20)}=\frac{1-\hat{\pi}(\text { age }=20)}{\hat{\pi}(\text { age }=20)}=e^{-1.82} e^{0.0665(20)}=0.613$$

]


---

class: middle


# Fitting logistic model in R

.blockquote.font90[
`glm` model attributes:

- `fitted(my.glm)` gives $\hat{\pi}(X)$ for each case in your data

- `predict(my.glm)` gives $\log \frac{\hat{\pi}(X)}{1-\hat{\pi}(X)}$ for each case in your data.
  - Add `newdata=` to get predicted log-odds for new data.

- `predict(my.glm, type = "response")` gives $\hat{\pi}(X)$ for each case in your data.
  - Add `newdata=` to get predicted log-odds for new data.
]


---

class: middle


# Example: Donner party model

.yellow-h[Get the predicted probability of survival:]

```{r, collapse=TRUE}
new_ages <- data.frame(Age = c(20, 45))
predict(donner_glm1, newdata = new_ages, type="response")
```


.yellow-h[with the default type, we get log odds survival estimates:]

```{r, collapse=TRUE}
new_ages <- data.frame(Age = c(20, 45))
predict(donner_glm1, newdata = new_ages) # log odds
```


```{r, collapse=TRUE}
exp(predict(donner_glm1, newdata = new_ages)) # odds
```

---

class: middle

# Example: Donner party model

```{r}
tidy(donner_glm1, conf.int=TRUE)
```


.out-t[How does a one year increase in age affect survival status?]

---

# Example: Donner party model

.blockquote[
A one year increase in age is associated with a $e^{-0.0665}=0.936$ multiplicative decrease on the odds of survival (95% CI $0.87,0.99)$
]

```{r, collapse=TRUE}
exp(-0.0665) # factor change
exp(c(-0.140, -0.0102)) # factor change CI
```


.blockquote[
A one year increase in age is associated with a decrease on the odds of survival by $6.4 \%(95 \%$ CI $1 \%$ to $13 \%)$.
]

```{r, collapse=TRUE}
100*(exp(-0.0665) - 1) # percent change
100*(exp(c(-0.140, -0.0102)) - 1) # % change CI
```

---

# Example: Donner party model

.blockquote[`broom` package: add `exponentiate=TRUE` to get exponentiatied estimated effects and confidence intervals
- but SE, test stat and p-values are untouched!]

```{r}
tidy(donner_glm1, conf.int=TRUE, exponentiate = TRUE)
```

---

# Example: Donner party model

```{r}
tidy(donner_glm1, conf.int=TRUE)
```

.blockquote[
How does a one year increase in age affect the odds of death?
$$\widehat{\text { odds.death(age)}}=\frac{1-\hat{\pi}}{\hat{\pi}}=\frac{1}{e^{1.82} e^{-0.0665 \text { Age }}}=e^{-1.82} e^{0.0665 \text { Age }}$$
]

---

class: middle

# Example: Donner party model

.blockquote[
A one year increase in age is associated with a $e^{0.0665}=1.069$ multiplicative increase on the odds of death $(95 \%$ CI $1.01,1.15)$
]

```{r, collapse=TRUE}
exp(0.0665) # factor change in odds of death
```

```{r, collapse=TRUE}
exp(c(0.140, 0.0102)) # factor change CI
```

---

class: middle

# Example: Donner party model

.blockquote[A one year increase in age is associated with an increase in the odds of
death by 6.9% (95% CI 1.0% to 15.0%)]

```{r, collapse=TRUE}
100*(exp(0.0665) - 1) # percent change
```

```{r, collapse=TRUE}
100*(exp(c(0.140, 0.0102)) - 1) # % change CI
```


