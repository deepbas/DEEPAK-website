<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Linear Regression</title>
    <meta charset="utf-8" />
    <meta name="author" content="Bastola" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link href="libs/panelset/panelset.css" rel="stylesheet" />
    <script src="libs/panelset/panelset.js"></script>
    <link href="libs/tachyons/tachyons.min.css" rel="stylesheet" />
    <script src="libs/clipboard/clipboard.min.js"></script>
    <link href="libs/xaringanExtra-clipboard/xaringanExtra-clipboard.css" rel="stylesheet" />
    <script src="libs/xaringanExtra-clipboard/xaringanExtra-clipboard.js"></script>
    <script>window.xaringanExtraClipboard(null, {"button":"<i class=\"fa fa-clipboard\"><\/i>","success":"<i class=\"fa fa-check\" style=\"color: #90BE6D\"><\/i>","error":"<i class=\"fa fa-times-circle\" style=\"color: #F94144\"><\/i>"})</script>
    <link href="libs/font-awesome/css/all.min.css" rel="stylesheet" />
    <link href="libs/font-awesome/css/v4-shims.min.css" rel="stylesheet" />
    <link href="libs/countdown/countdown.css" rel="stylesheet" />
    <script src="libs/countdown/countdown.js"></script>
    <script src="https://use.fontawesome.com/5235085b15.js"></script>

    <link rel="stylesheet" href="css/xaringan-themer-solns.css" type="text/css" />
    <link rel="stylesheet" href="css/my-theme.css" type="text/css" />
    <link rel="stylesheet" href="css/my-font.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">










layout: true
  
---

class: title-slide, middle

# .fancy[Cross Validation and Linear Regression]

### .fancy[Stat 220]

 February 26 2024


---

class: plain-background


# Resampling methods

&lt;center&gt;
&lt;img src="images/resampling.png" style="width:60%; height:auto;"&gt; &lt;br&gt;
&lt;/center&gt;


.yellow-h[Create a series of data sets similar to the training/testing split, always used with the training set]


.footnote[[Kuhn and Johnson (2019)](https://bookdown.org/max/FES/resampling.html)]
---









## Why not to use single (training) test set

&lt;img src="Day23_files/figure-html/unnamed-chunk-3-1.svg" width="90%" style="display: block; margin: auto;" /&gt;


---

background-image: url(images/k-folds.png)
background-position: 50% 90%
background-size: 90%

## Cross validation

.bq[
.bold[Idea:] Split the training data up into multiple training-validation pairs, evaluate the classifier on each split and average the performance metrics
]

.footnote[Image courtesy of Dennis Sun]

---

class: middle

## k-fold cross validation

.bq.font90[
1. split the data into `\(k\)` subsets

2. combine the first `\(k-1\)` subsets into a training set and train the classifier

3. evaluate the model predictions on the last (i.e. `\(k\)`th) held-out subset

4. repeat steps 2-3 `\(k\)` times (i.e. `\(k\)` "folds"), each time holding out a different one of the `\(k\)` subsets

5. calculate performance metrics from each validation set

6. average each metric over the `\(k\)` folds to come up with a single estimate of that metric
]

---

&lt;img src="Day23_files/figure-html/unnamed-chunk-4-1.svg" width="75%" style="display: block; margin: auto;" /&gt;

.hljs.purple[
- Based on accuracy, `\(k=4\)` appears best, We can look at other metrics. Notice that accuracy doesn't always decrease with `\(k\)`
]

---

class: middle

## 5-fold cross validation

Creating the recipe



```r
fire_recipe &lt;- recipe(classes ~  temperature + isi, data = fire_train) %&gt;%
  step_scale(all_predictors()) %&gt;%
  step_center(all_predictors()) %&gt;% 
  prep()
```


---

class: middle

## 5-fold cross validation

Create your model specification and use `tune()` as a placeholder for the number of neighbors


```r
knn_spec &lt;- nearest_neighbor(mode = "classification",
                             engine = "kknn",
                             weight_func = "rectangular", 
*                            neighbors = tune())
```


Split the `fire_train` data set into `v = 5` folds, stratified by `classes`


```r
# replicate 5-fold cross-validation 10 times, with unique partitions for each iteration
fire_vfold &lt;- vfold_cv(fire_train, v = 5, strata = classes, repeats = 10)
```


---

class: middle

## 5-fold cross validation

Create a grid of `\(K\)` values, the number of neighbors


```r
k_vals &lt;- tibble(neighbors = seq(from = 1, to = 40, by = 1))
```


Run 5-fold CV on the `k_vals` grid, storing four performance metrics


```r
knn_fit &lt;- workflow() %&gt;%
  add_recipe(fire_recipe) %&gt;%
  add_model(knn_spec) %&gt;%
  tune_grid(resamples = fire_vfold, 
            grid = k_vals,
            metrics = metric_set(accuracy, sensitivity, specificity, ppv))
```


---

class: middle

## Choosing K

Collect the performance metrics 

.font110[

```r
cv_metrics &lt;- collect_metrics(knn_fit)
cv_metrics %&gt;% head(6)
# A tibble: 6 × 7
  neighbors .metric     .estimator  mean     n std_err .config              
      &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;                
1         1 accuracy    binary     0.987    50 0.00343 Preprocessor1_Model01
2         1 ppv         binary     0.999    50 0.00133 Preprocessor1_Model01
3         1 sensitivity binary     0.979    50 0.00586 Preprocessor1_Model01
4         1 specificity binary     0.998    50 0.002   Preprocessor1_Model01
5         2 accuracy    binary     0.987    50 0.00343 Preprocessor1_Model02
6         2 ppv         binary     0.999    50 0.00133 Preprocessor1_Model02
```
]

---

class: middle

## Choosing K

Collect the performance metrics and find the best model



```r
cv_metrics %&gt;%
  group_by(.metric) %&gt;%
  slice_max(mean) 
# A tibble: 20 × 7
# Groups:   .metric [4]
   neighbors .metric     .estimator  mean     n std_err .config              
       &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;                
 1         1 accuracy    binary     0.987    50 0.00343 Preprocessor1_Model01
 2         2 accuracy    binary     0.987    50 0.00343 Preprocessor1_Model02
 3        11 ppv         binary     1        50 0       Preprocessor1_Model11
 4        12 ppv         binary     1        50 0       Preprocessor1_Model12
 5        13 ppv         binary     1        50 0       Preprocessor1_Model13
 6        14 ppv         binary     1        50 0       Preprocessor1_Model14
 7        15 ppv         binary     1        50 0       Preprocessor1_Model15
 8        16 ppv         binary     1        50 0       Preprocessor1_Model16
 9        17 ppv         binary     1        50 0       Preprocessor1_Model17
10        18 ppv         binary     1        50 0       Preprocessor1_Model18
11         1 sensitivity binary     0.979    50 0.00586 Preprocessor1_Model01
12         2 sensitivity binary     0.979    50 0.00586 Preprocessor1_Model02
13        11 specificity binary     1        50 0       Preprocessor1_Model11
14        12 specificity binary     1        50 0       Preprocessor1_Model12
15        13 specificity binary     1        50 0       Preprocessor1_Model13
16        14 specificity binary     1        50 0       Preprocessor1_Model14
17        15 specificity binary     1        50 0       Preprocessor1_Model15
18        16 specificity binary     1        50 0       Preprocessor1_Model16
19        17 specificity binary     1        50 0       Preprocessor1_Model17
20        18 specificity binary     1        50 0       Preprocessor1_Model18
```

---

# Choosing K: Visualization

&lt;img src="Day23_files/figure-html/unnamed-chunk-12-1.svg" width="90%" style="display: block; margin: auto;" /&gt;

---
background-image: url(images/cv-5.png)
background-position: middle, center
background-size: 55%
## The full process

.footnote[Image source: [rafalab.github.io/dsbook/](rafalab.github.io/dsbook/)]

---


class: action, middle

# &lt;i class="fa fa-pencil-square-o" style="font-size:48px;color:purple"&gt;&amp;nbsp;Group&amp;nbsp;Activity&amp;nbsp;1&lt;/i&gt;    


.pull-left-40[
![](https://media.giphy.com/media/RKApDdwsQ6jkwd6RNn/giphy.gif)
]
.pull-right-60[
&lt;br&gt;
&lt;br&gt;
.bq[
- Get the class activity 23.Rmd file from  [moodle](https://moodle.carleton.edu/course/view.php?id=43045) 
- Let's work on group activity 1 together
]

]

<div class="countdown" id="timer_b1878c58" data-update-every="1" tabindex="0" style="top:0;right:0;padding:3px 4px;font-size:2em;">
<div class="countdown-controls"><button class="countdown-bump-down">&minus;</button><button class="countdown-bump-up">&plus;</button></div>
<code class="countdown-time"><span class="countdown-digits minutes">10</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>


---

class: middle

# Supervised Learning 

.bql[
- .b[Supervised learning:] Learning a function that maps an input to an output based on example `inputoutput` pairs.
- .b[Function:] `\(\mathrm{y}=\mathrm{f}(\mathrm{x})\)`, where `\(\mathrm{y}\)` is the label (output) we predict, and `\(\mathrm{x}\)` is the feature(s) (input).
- .b[Goal:] Find a function that calculates `\(y\)` from `\(x\)` values accurately for all cases in the training dataset.
]


---

class: middle

## Linear Regression: The Basics

.hljs[Linear regression fits a linear equation to observed data to describe the relationship between variables.]

### Formulation: `\(y=\beta_0 + \beta_1x_1 + \beta_2x_2 + \cdots + \epsilon\)`, where:

.bq.font90[
- `\(y\)` is the dependent variable (what we're trying to predict),
- `\(x_1, x_2, \cdots\)` are independent variables (features),
- `\(\beta_0, \beta_1, \beta_2, \cdots\)` are coefficients, and `\(\epsilon\)` represents the error term.
]

.yellow-h[.b[Objective:] Minimize the differences between the observed values and the values predicted by the linear equation.]


---

class: middle

# Relevant Metrics

.bql[
`$$\text{MSE} =\frac{1}{n} \sum_{i=1}^n\left(y_i-\hat{y}_i\right)^2$$`


`$$\text{RMSE} =\sqrt{\frac{1}{n} \sum_{i=1}^n\left(y_i-\hat{y}_i\right)^2}$$`
]


---

class: middle

# Case study: Bike Share Scheme

.hljs[Data from a real study on a bicycle sharing scheme was collected to predict rental numbers based on seasonality and weather conditions.]

.scrollable-table[


|season |yr |mnth |holiday |weekday |workingday |weathersit |     temp|    atemp|      hum| windspeed| rentals|
|:------|:--|:----|:-------|:-------|:----------|:----------|--------:|--------:|--------:|---------:|-------:|
|1      |0  |1    |0       |6       |0          |2          | 0.344167| 0.363625| 0.805833| 0.1604460|     331|
|1      |0  |1    |0       |0       |0          |2          | 0.363478| 0.353739| 0.696087| 0.2485390|     131|
|1      |0  |1    |0       |1       |1          |1          | 0.196364| 0.189405| 0.437273| 0.2483090|     120|
|1      |0  |1    |0       |2       |1          |1          | 0.200000| 0.212122| 0.590435| 0.1602960|     108|
|1      |0  |1    |0       |3       |1          |1          | 0.226957| 0.229270| 0.436957| 0.1869000|      82|
|1      |0  |1    |0       |4       |1          |1          | 0.204348| 0.233209| 0.518261| 0.0895652|      88|
|1      |0  |1    |0       |5       |1          |2          | 0.196522| 0.208839| 0.498696| 0.1687260|     148|


]

---

class: middle

.font70[
| Variable        | Description |
|--------------|-------------|
| instant      | An identifier for each unique row |
| season       | Encoded numerical value for the season (1 for spring, 2 for summer, 3 for fall, 4 for winter) |
| yr           | Observation year in the study, spanning two years (0 for 2011, 1 for 2012) |
| mnth         | Month of observation, numbered from 1 (January) to 12 (December) |
| holiday      | Indicates if the observation was on a public holiday (binary value) |
| weekday      | Day of the week of the observation (0 for Sunday to 6 for Saturday) |
| workingday   | Indicates if the day was a working day (binary value, excluding weekends and holidays) |
| weathersit   | Weather condition category (1 for clear, 2 for mist/cloud, 3 for light rain/snow, 4 for heavy rain/hail/snow/fog) |
| temp         | Normalized temperature in Celsius |
| atemp        | Normalized "feels-like" temperature in Celsius |
| hum          | Normalized humidity level |
| windspeed    | Normalized wind speed |
| rentals      | Count of bicycle rentals recorded |

]

---


.panelset[

.panel[

.panel-name[Descriptive Statistics]



|variable  |     Min.|    1st Qu.|     Median|       Mean|     3rd Qu.|        Max.|
|:---------|--------:|----------:|----------:|----------:|-----------:|-----------:|
|atemp     | 0.079070|   0.337842|   0.486733|   0.474354|    0.608602|    0.840896|
|temp      | 0.059130|   0.337083|   0.498333|   0.495385|    0.655417|    0.861667|
|hum       | 0.000000|   0.520000|   0.626667|   0.627894|    0.730209|    0.972500|
|windspeed | 0.022392|   0.134950|   0.180975|   0.190486|    0.233214|    0.507463|
|rentals   | 2.000000| 315.500000| 713.000000| 848.176471| 1096.000000| 3410.000000|



]


.panel[

.panel-name[Code]



```r
bike %&gt;%
  select(atemp,temp, hum, windspeed, rentals) %&gt;%
  map_df(~summary(.), .id = "variable") %&gt;%
  mutate(across(-variable, round, digits = 6))
```

]

]

---

class: middle

&lt;img src="Day23_files/figure-html/unnamed-chunk-16-1.svg" width="80%" style="display: block; margin: auto;" /&gt;


---


class: middle

&lt;img src="Day23_files/figure-html/unnamed-chunk-17-1.svg" width="80%" style="display: block; margin: auto;" /&gt;

---

class: middle

# Data preparation and train-test split


```r
set.seed(2056)
bike_select &lt;- bike %&gt;% 
  select(c(season, mnth, holiday, weekday, workingday, weathersit,
           temp, atemp, hum, windspeed, rentals)) %&gt;% 
    mutate(across(1:6, factor))


bike_split &lt;- bike_select %&gt;% 
  initial_split(prop = 0.75, strata = holiday) # proportion stratified by holiday

bike_train &lt;- training(bike_split)
bike_test &lt;- testing(bike_split)
```

---

class: middle

# Model specification


```r

lm_spec &lt;- # your model specification
  linear_reg() %&gt;%  # model type
  set_engine(engine = "lm") %&gt;%  # model engine
  set_mode("regression") # model mode
```



```r
# Show your model specification
lm_spec
Linear Regression Model Specification (regression)

Computational engine: lm 
```

---

class: middle

# Fit the model


```r
# Train a linear regression model
lm_mod &lt;- lm_spec %&gt;% 
  fit(rentals ~ ., data = bike_train)
```


.scrollable-table[

```r
glance(lm_mod$fit) %&gt;% knitr::kable()
```



| r.squared| adj.r.squared|    sigma| statistic| p.value| df|    logLik|      AIC|      BIC| deviance| df.residual| nobs|
|---------:|-------------:|--------:|---------:|-------:|--:|---------:|--------:|--------:|--------:|-----------:|----:|
| 0.6956614|     0.6798592| 385.1778|  44.02308|       0| 27| -4025.838| 8109.677| 8234.559| 77148225|         520|  548|


]


---

class: middle

# Predict on test data


```r
results &lt;- bike_test %&gt;% 
  bind_cols(lm_mod %&gt;% 
    predict(new_data = bike_test)) %&gt;% 
      select(c(rentals, .pred))
```


```r
results %&gt;% slice_head(n =6) %&gt;% knitr::kable()
```



| rentals|     .pred|
|-------:|---------:|
|     331| 962.99041|
|     131| 777.55036|
|     148|  93.80756|
|     251| 779.49463|
|      75| -86.39861|
|     150| 483.58901|



---

class: middle


# Evaluate the model



```r
eval_metrics &lt;- metric_set(rmse, rsq)

# Evaluate RMSE, R2 based on the results
eval_metrics(data = results,
             truth = rentals,
             estimate = .pred) %&gt;% 
  select(-2)
# A tibble: 2 × 2
  .metric .estimate
  &lt;chr&gt;       &lt;dbl&gt;
1 rmse      380.   
2 rsq         0.710
```


---

class: middle


&lt;img src="Day23_files/figure-html/unnamed-chunk-26-1.svg" width="80%" style="display: block; margin: auto;" /&gt;


---

class: action, middle

# &lt;i class="fa fa-pencil-square-o" style="font-size:48px;color:purple"&gt;&amp;nbsp;Group&amp;nbsp;Activity&amp;nbsp;2&lt;/i&gt;    


.pull-left-40[
![](https://media.giphy.com/media/RKApDdwsQ6jkwd6RNn/giphy.gif)
]
.pull-right-60[
&lt;br&gt;
&lt;br&gt;
.bq[
- Please continue working on group activity 2
]

]

<div class="countdown" id="timer_687af20c" data-update-every="1" tabindex="0" style="top:0;right:0;padding:3px 4px;font-size:2em;">
<div class="countdown-controls"><button class="countdown-bump-down">&minus;</button><button class="countdown-bump-up">&plus;</button></div>
<code class="countdown-time"><span class="countdown-digits minutes">10</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>

    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="libs/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "googlecode",
"highlightLines": true,
"highlightLanguage": ["r", "css", "yaml"],
"countIncrementalSlides": true,
"slideNumberFormat": "%current%",
"ratio": "16:9"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
