---
title: "Shiny and Interactive Graphs"
subtitle: "<br/> Spring 2023"
author: "Bastola"
date: "`r format(Sys.Date(), ' %B %d %Y')`"
output:
  xaringan::moon_reader:
    css: ["default", css/xaringan-themer-solns.css, css/my-theme.css, css/my-font.css]
    lib_dir: libs
    chakra: libs/remark-latest.min.js
    seal: false
    nature:
      highlightStyle: googlecode  #http://arm.rbind.io/slides/xaringan.html#77 # idea, magula
      highlightLines: true
      highlightLanguage: ["r", "css", "yaml"]
      countIncrementalSlides: true
      slideNumberFormat: "%current%"
      titleSlideClass: ["left", "middle", "inverse"]
      ratio: "16:9"
    includes:
      in_header: header.html
editor_options: 
  chunk_output_type: console
header-includes:
    - \usepackage{caption}
---


```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
options(htmltools.preserve.raw = FALSE)
options(ggrepel.max.overlaps = Inf)

knitr::opts_chunk$set(echo = TRUE, 
                      dev = 'svg',
                      collapse = TRUE, 
                      comment = NA,  # PRINTS IN FRONT OF OUTPUT, default is '##' which comments out output
                      prompt = FALSE, # IF TRUE adds a > before each code input
                      warning = FALSE, 
                      message = FALSE,
                      fig.height = 3, 
                      fig.width = 4,
                      out.width = "100%",
                      prompt = FALSE,
                      rows.print=7
                      )


# load necessary packages
library(tidyverse)
library(ggplot2)
library(countdown)
library(ggthemes)
library(xaringanExtra)
xaringanExtra::use_panelset()
xaringanExtra::use_tachyons()
library(flipbookr)
library(htmlwidgets)
library(lubridate)

library(kableExtra)
library(fontawesome)
library(rvest)
library(forcats)
library(patchwork)
library(polite)
library(DT)
library(polite)
library(purrr)
library(leaflet)
library(maptools)
library(maps)     
library(sp)   
library(sf)
library(maptools) 
library(mapdata)
library(ggiraph)

select <- dplyr::select

# Set ggplot theme
# theme_set(theme_stata(base_size = 10))

yt <- 0

table_usafacts <- bow(url = "https://usafacts.org/visualizations/coronavirus-covid-19-spread-map/state/minnesota") %>%
  scrape() %>% 
  html_elements(css = "table") %>% 
  html_table()

covidMN <- table_usafacts[[2]]

library(leaflet)
library(maps)
library(sf)
library(viridis)
library(htmltools)

# tidy it up
covidMN_final <- covidMN %>% janitor::clean_names() %>%
  mutate(cases = as.numeric(str_remove(cases, ","))) %>%
  mutate(county = str_remove(county, " County"))

# leaflet
MNcounty <- map("county", "Minnesota", plot=FALSE, fill=TRUE)
MNmap <- map2SpatialPolygons(MNcounty, IDs = MNcounty$names)

map <- SpatialPolygonsDataFrame(MNmap, covidMN_final, match.ID = FALSE)

#pal <- colorNumeric(palette = "viridis", alpha = TRUE, domain = map$cases)

bins <- c(0, 1000, 5000, 10000, 100000, Inf)
pal <- colorBin("viridis", domain = map$cases, bins = bins)

labels <- sprintf("<strong> %s </strong> <br/> Observed: %s", map$county, map$cases) %>%
  lapply(htmltools::HTML)
```




```{r xaringanExtra-clipboard, echo=FALSE}
htmltools::tagList(
  xaringanExtra::use_clipboard(
    button_text = "<i class=\"fa fa-clipboard\"></i>",
    success_text = "<i class=\"fa fa-check\" style=\"color: #90BE6D\"></i>",
    error_text = "<i class=\"fa fa-times-circle\" style=\"color: #F94144\"></i>"
  ),
  rmarkdown::html_dependency_font_awesome()
)
```


layout: true
  
---

class: title-slide, middle

# .fancy[Shiny and Interactive Graphs]

### .fancy[Stat 220]

`r format(Sys.Date(), ' %B %d %Y')`


---

# Interactive leaflet map

```{r, echo=FALSE, fig.height=7, fig.width=5}

l <- leaflet(map) %>% addTiles() %>% setView(lng = -93.1616, lat = 46, zoom = 6) 

l %>% addPolygons(color = "grey", weight = 1,
                  fillColor = ~pal(cases), fillOpacity = 0.7,
                  highlightOptions = highlightOptions(weight = 5),
                  label = labels) %>%
                  addLegend(pal = pal, values = ~cases, opacity = 0.5, 
                            title = "Observed Cases", 
                            position = "bottomright")

```


---

class: middle

# Required packages

.bql[
- `leaflet` is used to create interactive maps
- `maps` provides geographical data
- `sp` and `maptools` are used to manipulate and convert geographical data into formats suitable for `leaflet`
]


---


.panelset[

.panel[

.panel-name[Why do we need map?]

.hljs[
- We need to construct a data framework of Minnesota's county boundaries, facilitating detailed mapping, analysis, and tailored visual insights at the county level.

- It creates a foundational geographic template for Minnesota, focusing on the county layout for subsequent customization and exploration.  ]

]

.panel[

.panel-name[Mapping objects in R]

```{r}
MNcounty <- map("county", "Minnesota", plot=FALSE, fill=TRUE); MNcounty
```


]



]

---



.panelset[


.panel[

.panel-name[Why do we need polygons?]

.hljs[

- We then need to convert the Minnesota county data into a `SpatialPolygons` object for use in R's spatial analysis and mapping libraries.

- Label each county within the spatial object, enabling easy access and manipulation in R environments.
]


]


.panel[

.panel-name[Mapping objects]

```{r}
MNmap <- map2SpatialPolygons(MNcounty, IDs = MNcounty$names); MNmap
```


]

]



---

`r chunk_reveal("demo3", widths = c(10, 10), font_size_code="40%", title = "# We need numeric data to project!", display_type = c("code", "output"))`


```{r, demo3, eval=TRUE, echo=FALSE}
bow(url = "https://usafacts.org/visualizations/coronavirus-covid-19-spread-map/state/minnesota") %>%
  scrape() %>% 
  html_elements(css = "table") %>% 
  html_table() %>% 
  pluck(2) ->
  covidMN

# tidy it up
 covidMN %>% janitor::clean_names() %>%
  mutate(cases = as.numeric(str_remove(cases, ","))) %>%
  mutate(county = str_remove(county, " County")) ->
  covidMN_final
```


---



.panelset[


.panel[

.panel-name[Merging Geographical and Covid-19 Data]

.bql.font80[
- Integrate Minnesota's geographic layout with Covid-19 data into a single analytical framework, enabling spatial analysis of the pandemic's impact across counties.

- The resulting dataset, 'map', combines location outlines with health statistics, offering a comprehensive view for targeted interventions and studies.
  
]
]

.panel[

.panel-name[Code]

```{r}
map <- SpatialPolygonsDataFrame(MNmap, covidMN_final, match.ID = FALSE); map
```


]


]

---

.panelset[


.panel[

.panel-name[Demo]

```{r, echo=FALSE, out.width="100%",  fig.height = 7,  fig.width = 6}
library(leaflet)
library(viridis) # For viridis color palette
library(sp) # Assuming 'map' is a SpatialPolygonsDataFrame

# Prepare the color palette
pal <- colorNumeric(palette = "viridis", domain = map$cases)

# Create the Leaflet map
leaflet(data = map) %>% setView(lng = -93.1616, lat = 45.9983, zoom = 5.5) %>% 
  addProviderTiles(provider = providers$CartoDB.Positron) %>% # Adding a light base map for contrast
  addPolygons(fillColor = ~pal(cases), 
              fillOpacity = 0.7, 
              color = "white", 
              weight = 1,
              popup = ~paste("Cases: ", cases)) %>%
  addLegend(pal = pal, values = ~cases, 
            title = "Case Counts",
            opacity = 1)
```


]


.panel[
.panel-name[`Viridis` color palette with `colorNumeric`]
```{r, eval=FALSE, out.width="100%",  fig.height = 7,  fig.width = 6}
library(leaflet)
library(viridis) 
library(sp) 

# Prepare the color palette
pal <- colorNumeric(palette = "viridis", domain = map$cases)

# Create the Leaflet map
leaflet(data = map) %>% setView(lng = -93.1616, lat = 45.9983, zoom = 5.5) %>% 
  addProviderTiles(provider = providers$CartoDB.Positron) %>% # Adding a light base map for contrast
  addPolygons(fillColor = ~pal(cases), # adds geographical shapes to a map
              fillOpacity = 0.7, 
              color = "white", 
              weight = 1) %>%
  addLegend(pal = pal, values = ~cases, # adds a legend to the Leaflet map
            title = "Case Counts",
            opacity = 1)
```
]


]

---

.panelset[

.panel[

.panel-name[Demo]

```{r, echo=FALSE, out.width="100%",  fig.height = 7,  fig.width = 6}
library(leaflet)
library(RColorBrewer) # For the "Paired" palette

# Define bins for categorizing case counts
bins <- c(0, 1000, 5000, 10000, 100000, Inf)

# Prepare the color palette using colorBin
pal <- colorBin(palette = "Paired", domain = map$cases, bins = bins)

# Create the Leaflet map
leaflet(data = map) %>% 
  setView(lng = -93.1616, lat = 45.9983, zoom = 5.5) %>% 
   addProviderTiles(provider = providers$CartoDB.Positron) %>% # Adding a light base map for contrast
  addPolygons(fillColor = ~pal(cases), 
              fillOpacity = 0.7, 
              color = "white", 
              weight = 1,
              popup = ~paste("Cases: ", cases)) %>%
  addLegend(pal = pal, values = ~cases, 
            title = "Case Counts", 
            bins = bins, # Specify bins in the legend
            opacity = 1)

```


]

.panel[
.panel-name[`RColorBrewer` palette (Paired) with `colorBin`]

```{r, eval=FALSE, out.width="100%",  fig.height = 7,  fig.width = 6}
library(leaflet)
library(RColorBrewer) # For the "Paired" palette

# Define bins for categorizing case counts
bins <- c(0, 1000, 5000, 10000, 100000, Inf)

# Prepare the color palette using colorBin
pal <- colorBin(palette = "Paired", domain = map$cases, bins = bins)

# Create the Leaflet map
leaflet(data = map) %>% 
  setView(lng = -93.1616, lat = 45.9983, zoom = 5.5) %>% 
   addProviderTiles(provider = providers$CartoDB.Positron) %>% # Adding a light base map for contrast
  addPolygons(fillColor = ~pal(cases), 
              fillOpacity = 0.7, 
              color = "white", 
              weight = 1,
              popup = ~paste("Cases: ", cases)) %>%
  addLegend(pal = pal, values = ~cases, 
            title = "Case Counts", 
            bins = bins, # Specify bins in the legend
            opacity = 1)

```
]



]

---

.panelset[

.panel[.panel-name[Demo]

```{r, echo=FALSE, out.width="100%",  fig.height = 7,  fig.width = 6}
library(leaflet)
library(RColorBrewer) # For diverging color palettes

# Assuming map$cases is preprocessed for logarithmic divergence from median

# Calculate median and apply a logarithmic transformation to create bins
median_cases <- median(map$cases, na.rm = TRUE)
# Creating a symmetric set of bins around the median, for demonstration
bins <- c(1, median_cases/2, median_cases, median_cases*2, max(map$cases))
# Prepare the color palette using a diverging scheme
# Note: Adjust palette choice for actual logarithmic data preprocessing
pal <- colorBin(palette = "RdYlBu", domain = map$cases, bins = bins, na.color = "transparent")

# Create the Leaflet map
leaflet(data = map) %>%
  setView(lng = -93.1616, lat = 45.9983, zoom = 5.5) %>% 
  addProviderTiles(provider = providers$CartoDB.Positron) %>%
  addPolygons(fillColor = ~pal(cases),
              fillOpacity = 0.7,
              color = "white",
              weight = 1,
              popup = ~paste("Cases: ", cases)) %>%
  addLegend(pal = pal, values = ~cases,
            title = "Case Counts",
            opacity = 1)

```


]


.panel[
.panel-name[Leaflet map with a diverging color scale]

```{r, eval=FALSE}
library(leaflet)
library(RColorBrewer) 

median_cases <- median(map$cases, na.rm = TRUE)
bins <- c(1, median_cases/2, median_cases, median_cases*2, max(map$cases))

pal <- colorBin(palette = "RdYlBu", domain = map$cases, bins = bins, na.color = "transparent")

leaflet(data = map) %>%
  setView(lng = -93.1616, lat = 45.9983, zoom = 5.5) %>% 
  addProviderTiles(provider = providers$CartoDB.Positron) %>%
  addPolygons(fillColor = ~pal(cases),
              fillOpacity = 0.7,
              color = "white",
              weight = 1,
              popup = ~paste("Cases: ", cases)) %>%
  addLegend(pal = pal, values = ~cases,
            title = "Case Counts",
            opacity = 1)
```


]



]

---

.panelset[

.panel[.panel-name[Demo]

```{r, echo=FALSE, out.width="100%",  fig.height = 7,  fig.width = 6}
library(leaflet)
library(RColorBrewer) # For accessing a variety of color palettes

# Prepare the color palette using colorQuantile
# "Pastel1" is chosen for its soft, distinguishable colors ideal for categorizing data into quantiles
pal <- colorQuantile(palette = "Dark2", domain = map$cases, n = 5)

# Create the Leaflet map
leaflet(data = map) %>%
  setView(lng = -93.1616, lat = 45.9983, zoom = 5.5) %>% 
  addProviderTiles(provider = providers$CartoDB.Positron) %>%
  addPolygons(fillColor = ~pal(cases),
              fillOpacity = 0.7,
              color = "white",
              weight = 1,
              popup = ~paste("Cases: ", cases)) %>%
  addLegend(pal = pal, values = ~cases,
            title = "Case Counts by Quantile",
            opacity = 1)


```


]


.panel[
.panel-name[Leaflet map with a `colorQuantile` color scale]

```{r, eval=FALSE}
library(leaflet)
library(RColorBrewer) 


pal <- colorQuantile(palette = "Dark2", domain = map$cases, n = 5)

# Create the Leaflet map
leaflet(data = map) %>%
  setView(lng = -93.1616, lat = 45.9983, zoom = 5.5) %>% 
  addProviderTiles(provider = providers$CartoDB.Positron) %>%
  addPolygons(fillColor = ~pal(cases),
              fillOpacity = 0.7,
              color = "white",
              weight = 1,
              popup = ~paste("Cases: ", cases)) %>%
  addLegend(pal = pal, values = ~cases,
            title = "Case Counts by Quantile",
            opacity = 1)

```


]



]


---

class: middle

# Creating better labels

```
labels <- sprintf("<strong> %s </strong> <br/> Observed: %s", map$county, map$cases) %>%
  lapply(htmltools::HTML)
```

```{r}
labels
```


---


class: action, middle

# 🚀 **Try the Leaflet Code Yourself!** `r (yt <- yt + 1)`


.pull-left[
![Try it out!](https://media.giphy.com/media/RKApDdwsQ6jkwd6RNn/giphy.gif)
]

.pull-right[
<br>
.bql[
- **Step 1:** Copy the codes on the previous slides
- **Step 2:** Paste the codes on Activity 1 on your .Rmd file 
- **Questions?** I'm here to help!
]
]

`r countdown(minutes = 10, seconds = 00, top = 0 , color_background = "inherit", padding = "3px 4px", font_size = "2em")`


---

# Shiny Implementation

.bql.font70[
- In the UI you call .bold[leafletOutput]

- On the server side you assign a .bold[renderLeaflet] call to the output

  - Inside the .bold[renderLeaflet] expression, you return a Leaflet map object.
]

```{r, eval=FALSE}
# Basic Leaflet using Shiny
ui <- fluidPage(
  leafletOutput("mymap")
  )

server <- function(input, output, session) {

  output$mymap <- renderLeaflet({
    leaflet() %>% # FILL IN ##
      addTiles() %>% # FILL IN ##
      addPolygons() %>% # FILL IN ##
      addLegend() # FILL IN ##
  })
}
```



---

`r chunk_reveal("demo4", widths = c(40, 40), font_size_code="80%", title = "# Summary: Mapping and Plotting Objects", display_type = c("code"))`

```{r, demo4, eval=FALSE, echo=FALSE}
library(leaflet) # for leaflet maps
library(maps) # for map data
library(sp) # for spatial polygons
library(maptools) # for sp polygon data frame


MNcounty <- map("county", "Minnesota", plot=FALSE, fill=TRUE)
MNmap <- map2SpatialPolygons(MNcounty, IDs = MNcounty$names)
map <- SpatialPolygonsDataFrame(MNmap, covidMN_final, match.ID = FALSE)

bins <- c(0, 1000, 5000, 10000, 100000, Inf)
pal <- colorBin("magma", pretty = TRUE, domain = map$cases, bins = bins)

labels <- sprintf("<strong> %s </strong> <br/> Observed: %s", map$county, map$cases) %>%
  lapply(htmltools::HTML)

l <- leaflet(map) %>% addTiles() %>% setView(lng = -93.1616, lat = 44.4583, zoom = 5) 

l %>% addPolygons(color = "grey", weight = 1,
                  fillColor = ~pal(cases), fillOpacity = 0.7,
                  highlightOptions = highlightOptions(weight = 5),
                  label = labels) %>%
  addLegend(pal = pal, values = ~cases, opacity = 0.5, 
            title = "Observed Cases", 
            position = "bottomright")

```

---

# Interactive leaflet map

```{r, echo=FALSE, fig.height=7, fig.width=5}

l <- leaflet(map) %>% addTiles() %>% setView(lng = -93.1616, lat = 46, zoom = 6) 

l %>% addPolygons(color = "grey", weight = 1,
                  fillColor = ~pal(cases), fillOpacity = 0.7,
                  highlightOptions = highlightOptions(weight = 5),
                  label = labels) %>%
                  addLegend(pal = pal, values = ~cases, opacity = 0.5, 
                            title = "Observed Cases", 
                            position = "bottomright")

```




---

class: action, middle

# <i class="fa fa-pencil-square-o" style="font-size:48px;color:purple">&nbsp;Group&nbsp;Activity&nbsp;`r (yt <- yt + 1)`</i>    


.pull-left-40[
![](https://media.giphy.com/media/RKApDdwsQ6jkwd6RNn/giphy.gif)
]
.pull-right-60[
<br>
.bql[
- Let's go over to maize server/ local Rstudio and our class [moodle](https://moodle.carleton.edu/course/view.php?id=43045)
- Get the class activity 20.Rmd file
- Work on activity 2 and 3
- Ask me questions
]

]

`r countdown(minutes = 30, seconds = 00, top = 0 , color_background = "inherit", padding = "3px 4px", font_size = "2em")`


