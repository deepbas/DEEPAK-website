---
title: "Shiny and Interactive Graphs"
subtitle: "<br/> Fall 2022"
author: "Bastola"
date: "`r format(Sys.Date(), ' %B %d %Y')`"
output:
  xaringan::moon_reader:
    css: ["default", css/xaringan-themer-solns.css, css/my-theme.css, css/my-font.css]
    lib_dir: libs
    chakra: libs/remark-latest.min.js
    seal: false
    nature:
      highlightStyle: googlecode  #http://arm.rbind.io/slides/xaringan.html#77 # idea, magula
      highlightLines: true
      highlightLanguage: ["r", "css", "yaml"]
      countIncrementalSlides: true
      slideNumberFormat: "%current%"
      titleSlideClass: ["left", "middle", "inverse"]
      ratio: "16:9"
    includes:
      in_header: header.html
editor_options: 
  chunk_output_type: console
header-includes:
    - \usepackage{caption}
---


```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
options(htmltools.preserve.raw = FALSE)
options(ggrepel.max.overlaps = Inf)

knitr::opts_chunk$set(echo = TRUE, 
                      dev = 'svg',
                      collapse = TRUE, 
                      comment = NA,  # PRINTS IN FRONT OF OUTPUT, default is '##' which comments out output
                      prompt = FALSE, # IF TRUE adds a > before each code input
                      warning = FALSE, 
                      message = FALSE,
                      fig.height = 3, 
                      fig.width = 4,
                      out.width = "100%",
                      prompt = FALSE,
                      rows.print=7
                      )


# load necessary packages
library(tidyverse)
library(ggplot2)
library(countdown)
library(ggthemes)
library(xaringanExtra)
xaringanExtra::use_panelset()
xaringanExtra::use_tachyons()
library(flipbookr)
library(htmlwidgets)
library(lubridate)

library(kableExtra)
library(fontawesome)
library(rvest)
library(forcats)
library(patchwork)
library(polite)
library(DT)
library(polite)
library(purrr)
library(leaflet)
library(maptools)
library(maps)     
library(sp)       
library(maptools) 
library(mapdata)
library(ggiraph)

select <- dplyr::select

# Set ggplot theme
# theme_set(theme_stata(base_size = 10))

yt <- 0

table_usafacts <- bow(url = "https://usafacts.org/visualizations/coronavirus-covid-19-spread-map/state/minnesota") %>%
  scrape() %>% 
  html_elements(css = "table") %>% 
  html_table()

covidMN <- table_usafacts[[2]]

# tidy it up
covidMN_final <- covidMN %>% janitor::clean_names() %>%
  mutate(cases = as.numeric(str_remove(cases, ","))) %>%
  mutate(county = str_remove(county, " County"))

# leaflet
MNcounty <- map("county","Minnesota", plot=FALSE, fill=TRUE)
MNmap <- map2SpatialPolygons(MNcounty, IDs = MNcounty$names)

map <- SpatialPolygonsDataFrame(MNmap, covidMN_final, match.ID = FALSE)

#pal <- colorNumeric(palette = "viridis", alpha = TRUE, domain = map$cases)

bins <- c(0, 1000, 5000, 10000, 100000, Inf)
pal <- colorBin("viridis", domain = map$cases, bins = bins)

labels <- sprintf("<strong> %s </strong> <br/> Observed: %s", map$county, map$cases) %>%
  lapply(htmltools::HTML)
```




```{r xaringanExtra-clipboard, echo=FALSE}
htmltools::tagList(
  xaringanExtra::use_clipboard(
    button_text = "<i class=\"fa fa-clipboard\"></i>",
    success_text = "<i class=\"fa fa-check\" style=\"color: #90BE6D\"></i>",
    error_text = "<i class=\"fa fa-times-circle\" style=\"color: #F94144\"></i>"
  ),
  rmarkdown::html_dependency_font_awesome()
)
```


layout: true
  
---

class: title-slide, middle

# .fancy[Shiny and Interactive Graphs]

### .fancy[Fall 2022]

`r format(Sys.Date(), ' %B %d %Y')`


---


class: middle

# Interactive maps using `ggiraph`

.bql[
A tool that allows you to create dynamic ggplot graphs.

- allows you to add `tooltips`, `hover effects` and other useful effects
- `displays` information when the mouse is over elements
]

.footnote[Click [here](https://davidgohel.github.io/ggiraph/index.html) for more useful resources.]

---


`r chunk_reveal("demo1", widths = c(10, 10), font_size_code="10%", title = "# Data Scraping and Cleaning", display_type = c("code"), float = "top")`

.code80[
```{r, demo1, eval=FALSE, echo=FALSE}
table_usafacts <- bow(url = "https://usafacts.org/visualizations/coronavirus-covid-19-spread-map/") %>%
  scrape() %>% 
  html_elements(css = "table") %>% 
  html_table()

covid <- table_usafacts[[2]]
covid_clean <- covid %>% drop_na() %>%  janitor::clean_names() %>%
  mutate_at(4:5, parse_number) %>% mutate(state = str_to_lower(state))

states <- map_data("state")
covid_data <- left_join(states, covid_clean, by = c("region" = "state"))
```
]

---

# Glimpse of data

```{r, echo=FALSE}
# Scrape the webpage for tables
table_usafacts <- bow(url = "https://usafacts.org/visualizations/coronavirus-covid-19-spread-map/") %>% scrape() %>% html_elements(css = "table") %>% html_table()

# Extract the right table
covid <- table_usafacts[[2]]

# Clean the data
covid_clean <- covid %>% janitor::clean_names() %>%
  mutate_at(4:5, parse_number) %>% mutate(state = str_to_lower(state))

# Store the geographical coordinates and grouping information
states <- map_data("state")

# Joint the state-wise data for plotting
covid_data <- left_join(states, covid_clean, by = c("region" = "state"))

```

.code100[
```{r}
glimpse(covid_data)
```
]


---


.panelset[
.panel[.panel-name[Implementation 1]
```{r scale-fill, echo=FALSE, out.width="100%", fig.align='center'}
breaks1 <- round(seq(min(covid_data$deaths), max(covid_data$deaths),length.out = 5)) 

map1 <- ggplot(covid_data, aes(long, lat, group = group)) + 
  coord_map(projection = "bonne", parameters = list(45)) + 
  theme_map() +
  geom_polygon_interactive(aes(fill = deaths, 
                               tooltip = deaths)) + 
  guides(fill=guide_legend(title="Total Deaths")) + 
  scale_fill_fermenter(type = "div", palette = "Spectral", breaks = breaks1) + 
  theme(legend.position = "right") 
  
ggiraph(code = print(map1)) #<<
```
]
.panel[.panel-name[Code]
```{r scale-fill, echo=TRUE, eval = FALSE, fig.show='hide', fig.height = 2.5, fig.width = 4.5}
```
]
]

---


.panelset[
.panel[.panel-name[Implementation 2]
```{r scale-fill1, echo=FALSE, fig.height = 2.5, fig.width = 4.5, out.width="60%", fig.align='center'}
breaks2 <- round(seq(min(covid_data$cases), max(covid_data$cases),length.out = 5)) 
covid_data$tooltip <- str_c("State = ", str_to_upper(covid_data$region), "\n Cases =", covid_data$cases) #<<

map2 <- ggplot(covid_data, aes(long, lat)) + 
  coord_map(projection = "bonne", parameters = list(45)) + 
  theme_map() +
  geom_polygon_interactive(aes(fill = cases, group = group,
                               tooltip = tooltip, 
                               data_id = cases)) +
  guides(fill=guide_legend(title="Total Cases")) + 
  scale_fill_fermenter(type = "div", palette = "Spectral", breaks = breaks2) + 
  theme(legend.position = "right") 
  
ggiraph(code = print(map2),  hover_css = "fill:lightgreen;r:10pt;") #<<
```
]
.panel[.panel-name[Code]
```{r scale-fill1, echo=TRUE, eval=FALSE, fig.show='hide', fig.height = 2.5, fig.width = 4.5}
```
]
]


---
class: middle

# Shiny Implementation

.code120[
```{r, eval=FALSE}
# Basic ggiraph using Shiny
ui <- fluidPage(
  girafeOutput("plot")
  )

server <- function(input, output) {

  output$plot <- renderGirafe({
    girafe(my_aweesome_plot )
  })
  })
}

```
]


---

class: middle

# Leaflet

<blockquote>
Leaflet is a JavaScript library for creating dynamic maps that support panning and zooming along with various annotations like markers, polygons, and popups.
</blockquote>


```{r, out.width="100%",  fig.height = 5,  fig.width = 6}
leaflet() %>%
  addTiles() %>% 
  setView(lng = -93.1616, lat = 44.4583, zoom = 14)
```

---

class: middle

# What can you do with `leaflet`?

.bq[
- Make the background map with `leaflet()`, `addTiles()` and `setView()`

- Use `addPolygons()` to add the shape of country/states/county

- Translate a numeric variable to a palette of color

  - Quantile with .out-t[colorQuantile]
  - Numeric with .out-t[colorNumeric]
  - Bin with .out-t[colorBin]
]

.footnote[For more information, [click here](https://rstudio.github.io/leaflet/)]

---

# Implementation

.bql.font80[
- In the UI you call .bold[leafletOutput]

- On the server side you assign a .bold[renderLeaflet] call to the output

  - Inside the .bold[renderLeaflet] expression, you return a Leaflet map object.
]

```{r, eval=FALSE}
# Basic Leaflet using Shiny
ui <- fluidPage(
  leafletOutput("mymap")
  )

server <- function(input, output, session) {

  output$mymap <- renderLeaflet({
    leaflet() %>%
      addTiles() %>%
      addPolygons() %>%
      addLegend()
  })
}
```


---

`r chunk_reveal("demo3", widths = c(10, 10), font_size_code="40%", title = "# Data Wrangling", display_type = c("code"))`


```{r, demo3, eval=TRUE, echo=FALSE}
table_usafacts <- bow(url = "https://usafacts.org/visualizations/coronavirus-covid-19-spread-map/state/minnesota") %>%
  scrape() %>% 
  html_elements(css = "table") %>% 
  html_table()
covidMN <- table_usafacts[[2]]

# tidy it up
covidMN_final <- covidMN %>% janitor::clean_names() %>%
  mutate(cases = as.numeric(str_remove(cases, ","))) %>%
  mutate(county = str_remove(county, " County"))
glimpse(covidMN_final)
```


---

`r chunk_reveal("demo4", widths = c(40, 40), font_size_code="80%", title = "# Objects needed for plotting", display_type = c("code"))`

```{r, demo4, eval=FALSE, echo=FALSE}
library(leaflet) # for leaflet maps
library(maps) # for map data
library(sp) # for spatial polygons
library(maptools) # for sp polygon data frame


MNcounty <- map("county", "Minnesota", plot=FALSE, fill=TRUE)
MNmap <- map2SpatialPolygons(MNcounty, IDs = MNcounty$names)
map <- SpatialPolygonsDataFrame(MNmap, covidMN_final, match.ID = FALSE)

pal <- colorNumeric(palette = "magma", alpha = TRUE, domain = map$cases)
bins <- c(0, 1000, 5000, 10000, 100000, Inf)
pal <- colorBin("viridis", domain = map$cases, bins = bins)

labels <- sprintf("<strong> %s </strong> <br/> Observed: %s", map$county, map$cases) %>%
  lapply(htmltools::HTML)

l <- leaflet(map) %>% addTiles() %>% setView(lng = -93.1616, lat = 44.4583, zoom = 5) 

l %>% addPolygons(color = "grey", weight = 1,
                  fillColor = ~pal(cases), fillOpacity = 0.7,
                  highlightOptions = highlightOptions(weight = 5),
                  label = labels) %>%
  addLegend(pal = pal, values = ~cases, opacity = 0.5, 
            title = "Observed Cases", 
            position = "bottomright")

```

---

# Interactive leaflet map

```{r, echo=FALSE, fig.height=7, fig.width=5}

l <- leaflet(map) %>% addTiles() %>% setView(lng = -93.1616, lat = 46, zoom = 6) 

l %>% addPolygons(color = "grey", weight = 1,
                  fillColor = ~pal(cases), fillOpacity = 0.7,
                  highlightOptions = highlightOptions(weight = 5),
                  label = labels) %>%
                  addLegend(pal = pal, values = ~cases, opacity = 0.5, 
                            title = "Observed Cases", 
                            position = "bottomright")

```


---

class: action, middle

# <i class="fa fa-pencil-square-o" style="font-size:48px;color:purple">&nbsp;Group&nbsp;Activity&nbsp;`r (yt <- yt + 1)`</i>    


.pull-left-40[
![](https://media.giphy.com/media/RKApDdwsQ6jkwd6RNn/giphy.gif)
]
.pull-right-60[
<br>
<br>
.bq[
- Let's go over to maize server/ local Rstudio and our class [moodle](https://moodle.carleton.edu/course/view.php?id=39491)
- Get the class activity 20.Rmd file
- Work on activity 1
- Ask me questions
]

]

`r countdown(minutes = 15, seconds = 00, top = 0 , color_background = "inherit", padding = "3px 4px", font_size = "2em")`
