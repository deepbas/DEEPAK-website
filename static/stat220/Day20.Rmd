---
title: "Shiny and Interactive Graphs"
subtitle: "<br/> Spring 2023"
author: "Bastola"
date: "`r format(Sys.Date(), ' %B %d %Y')`"
output:
  xaringan::moon_reader:
    css: ["default", css/xaringan-themer-solns.css, css/my-theme.css, css/my-font.css]
    lib_dir: libs
    chakra: libs/remark-latest.min.js
    seal: false
    nature:
      highlightStyle: googlecode  #http://arm.rbind.io/slides/xaringan.html#77 # idea, magula
      highlightLines: true
      highlightLanguage: ["r", "css", "yaml"]
      countIncrementalSlides: true
      slideNumberFormat: "%current%"
      titleSlideClass: ["left", "middle", "inverse"]
      ratio: "16:9"
    includes:
      in_header: header.html
editor_options: 
  chunk_output_type: console
header-includes:
    - \usepackage{caption}
---


```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
options(htmltools.preserve.raw = FALSE)
options(ggrepel.max.overlaps = Inf)

knitr::opts_chunk$set(echo = TRUE, 
                      dev = 'svg',
                      collapse = TRUE, 
                      comment = NA,  # PRINTS IN FRONT OF OUTPUT, default is '##' which comments out output
                      prompt = FALSE, # IF TRUE adds a > before each code input
                      warning = FALSE, 
                      message = FALSE,
                      fig.height = 3, 
                      fig.width = 4,
                      out.width = "100%",
                      prompt = FALSE,
                      rows.print=7
                      )


# load necessary packages
library(tidyverse)
library(ggplot2)
library(countdown)
library(ggthemes)
library(xaringanExtra)
xaringanExtra::use_panelset()
xaringanExtra::use_tachyons()
library(flipbookr)
library(htmlwidgets)
library(lubridate)

library(kableExtra)
library(fontawesome)
library(rvest)
library(forcats)
library(patchwork)
library(polite)
library(DT)
library(polite)
library(purrr)
library(leaflet)
library(maptools)
library(maps)     
library(sp)   
library(sf)
library(maptools) 
library(mapdata)
library(ggiraph)

select <- dplyr::select

# Set ggplot theme
# theme_set(theme_stata(base_size = 10))

yt <- 0

table_usafacts <- bow(url = "https://usafacts.org/visualizations/coronavirus-covid-19-spread-map/state/minnesota") %>%
  scrape() %>% 
  html_elements(css = "table") %>% 
  html_table()

covidMN <- table_usafacts[[2]]

library(leaflet)
library(maps)
library(sf)
library(viridis)
library(htmltools)

# tidy it up
covidMN_final <- covidMN %>% janitor::clean_names() %>%
  mutate(cases = as.numeric(str_remove(cases, ","))) %>%
  mutate(county = str_remove(county, " County"))

# leaflet
MNcounty <- map("county", "Minnesota", plot=FALSE, fill=TRUE)
MNmap <- map2SpatialPolygons(MNcounty, IDs = MNcounty$names)

map <- SpatialPolygonsDataFrame(MNmap, covidMN_final, match.ID = FALSE)

#pal <- colorNumeric(palette = "viridis", alpha = TRUE, domain = map$cases)

bins <- c(0, 1000, 5000, 10000, 100000, Inf)
pal <- colorBin("viridis", domain = map$cases, bins = bins)

labels <- sprintf("<strong> %s </strong> <br/> Observed: %s", map$county, map$cases) %>%
  lapply(htmltools::HTML)
```




```{r xaringanExtra-clipboard, echo=FALSE}
htmltools::tagList(
  xaringanExtra::use_clipboard(
    button_text = "<i class=\"fa fa-clipboard\"></i>",
    success_text = "<i class=\"fa fa-check\" style=\"color: #90BE6D\"></i>",
    error_text = "<i class=\"fa fa-times-circle\" style=\"color: #F94144\"></i>"
  ),
  rmarkdown::html_dependency_font_awesome()
)
```


layout: true
  
---

class: title-slide, middle

# .fancy[Shiny and Interactive Graphs]

### .fancy[Spring 2023]

`r format(Sys.Date(), ' %B %d %Y')`


---

# Interactive leaflet map

```{r, echo=FALSE, fig.height=7, fig.width=5}

l <- leaflet(map) %>% addTiles() %>% setView(lng = -93.1616, lat = 46, zoom = 6) 

l %>% addPolygons(color = "grey", weight = 1,
                  fillColor = ~pal(cases), fillOpacity = 0.7,
                  highlightOptions = highlightOptions(weight = 5),
                  label = labels) %>%
                  addLegend(pal = pal, values = ~cases, opacity = 0.5, 
                            title = "Observed Cases", 
                            position = "bottomright")

```


---

class: middle

# Required packages

.bql[
- `leaflet` is used to create interactive maps
- `maps` provides geographical data
- `sp` and `maptools` are used to manipulate and convert geographical data into formats suitable for `leaflet`
]


---

class: middle

# Mapping objects

extract county-level data for the state of Minnesota using the 'map' function. 

```
MNcounty <- map("county", "Minnesota", plot=FALSE, fill=TRUE)
```

convert this data into a SpatialPolygons object using 'map2SpatialPolygons'

```
MNmap <- map2SpatialPolygons(MNcounty, IDs = MNcounty$names)
```


.bql[
The resulting object, MNmap, represents the geographical boundaries of each county in Minnesota.
]


---

`r chunk_reveal("demo3", widths = c(10, 10), font_size_code="40%", title = "# We need numeric data to project!", display_type = c("code"))`


```{r, demo3, eval=TRUE, echo=FALSE}
table_usafacts <- bow(url = "https://usafacts.org/visualizations/coronavirus-covid-19-spread-map/state/minnesota") %>%
  scrape() %>% 
  html_elements(css = "table") %>% 
  html_table()
covidMN <- table_usafacts[[2]]

# tidy it up
covidMN_final <- covidMN %>% janitor::clean_names() %>%
  mutate(cases = as.numeric(str_remove(cases, ","))) %>%
  mutate(county = str_remove(county, " County"))
glimpse(covidMN_final)
```


---

class: middle

# Merging Geographical and Covid-19 Data

```
map <- SpatialPolygonsDataFrame(MNmap, covidMN_final, match.ID = FALSE)
```


.bql.font80[
- Create a SpatialPolygonsDataFrame, which merges our geographical data (MNmap) with the Covid-19 case data (covidMN_final). 

  - This new data frame, 'map', contains both the geographical boundaries of each county and the associated Covid-19 case data.
]

---

class: middle

# Defining Color Palettes

.bql.font60[
.hljs[Viridis color palette with colorNumeric:]
```
pal <- colorNumeric(palette = "viridis", domain = map$cases)
```
Other options: heat, Dark2, Spectral

.hljs[RColorBrewer palette (Paired) with colorBin:]

```
bins <- c(0, 1000, 5000, 10000, 100000, Inf)
pal <- colorBin(palette = "Paired", domain = map$cases, bins = bins)
```

Other options: Accent

.hljs[RColorBrewer palette (Set1) with colorQuantile:]

```
pal <- colorQuantile(palette = "Pastel1", domain = map$cases, n = 5)
```
Other options: Set1
]

---

class: middle

# Creating labels

```
labels <- sprintf("<strong> %s </strong> <br/> Observed: %s", map$county, map$cases) %>%
  lapply(htmltools::HTML)
```

```{r}
labels[1:5]
```


---

class: middle

# Initializing Leaflet Map

.hljs[Leaflet is a JavaScript library for creating dynamic maps that support panning and zooming along with various annotations like markers, polygons, and popups.]


```{r, out.width="100%",  fig.height = 5,  fig.width = 6}
l <- leaflet(map) %>% addTiles() %>% setView(lng = -93.1616, lat = 44.4583, zoom = 5) 
l
```

---

class: middle

# Adding Polygons and Highlight Options

.hljs[ `addPolygons` adds geographical shapes to a map. ]

.pull-left-40[
```
l <- l %>% addPolygons(
  color = "grey", 
  weight = 1,
  fillColor = ~pal(cases), 
  fillOpacity = 0.7,
  highlightOptions = highlightOptions(weight = 5),
  label = labels
)
```
]


.pull-right-60[

.bq.font60[
- Styling arguments include `color` (for border color), `weight` (for border thickness), `fillColor` (for the color inside the polygons), and `fillOpacity` (for the transparency of the fill color).
- `fillColor` means that the fill color of the polygons  is determined by the numerical quantity being projected, allowing for a visual representation of the data
- `highlightOptions` argument sets what happens when a user hovers over a polygon, and the `label` argument sets the label that is displayed when this happens. ]
]


---

class: middle

# Adding a Legend


.hljs[ `addLegend` adds a legend to the Leaflet map. It provides necessary context for the map's colors and markers, improving its interpretability.]

.pull-left-40[
```
l <- l %>% addLegend(
  pal = pal, 
  values = ~cases, 
  opacity = 0.5,
  title = "Observed Cases", 
  position = "bottomright"
)
```
]


.pull-right-60[

.bq.font60[

**Color Palette**: The `pal` argument is used to specify the color palette. This palette is used to color the items in the legend and, correspondingly, the polygons on the map.

**Opacity**: The `opacity` argument sets the level of transparency for the legend. Lower values make the legend more transparent, while higher values make it more opaque.

**Title and Position**: The `title` argument allows you to provide a title for the legend, giving context to the information displayed. The `position` argument controls where the legend is placed on the map, with options like "bottomright", "bottomleft", "topright", and "topleft".
 ]
]





---

class: middle

# Recap: thins we can do with `leaflet`

.bql.font80[
- Make the background map with `leaflet()`, `addTiles()` and `setView()`

- Use `addPolygons()` to add the shape of country/states/county

- Translate a numeric variable to a palette of color

  - Quantile with .out-t[colorQuantile]
  - Numeric with .out-t[colorNumeric]
  - Bin with .out-t[colorBin]
]

.footnote[For more information, [click here](https://rstudio.github.io/leaflet/)]

---

# Shiny Implementation

.bql.font70[
- In the UI you call .bold[leafletOutput]

- On the server side you assign a .bold[renderLeaflet] call to the output

  - Inside the .bold[renderLeaflet] expression, you return a Leaflet map object.
]

```{r, eval=FALSE}
# Basic Leaflet using Shiny
ui <- fluidPage(
  leafletOutput("mymap")
  )

server <- function(input, output, session) {

  output$mymap <- renderLeaflet({
    leaflet() %>%
      addTiles() %>%
      addPolygons() %>%
      addLegend()
  })
}
```



---

`r chunk_reveal("demo4", widths = c(40, 40), font_size_code="80%", title = "# Objects needed for plotting", display_type = c("code"))`

```{r, demo4, eval=FALSE, echo=FALSE}
library(leaflet) # for leaflet maps
library(maps) # for map data
library(sp) # for spatial polygons
library(maptools) # for sp polygon data frame


MNcounty <- map("county", "Minnesota", plot=FALSE, fill=TRUE)
MNmap <- map2SpatialPolygons(MNcounty, IDs = MNcounty$names)
map <- SpatialPolygonsDataFrame(MNmap, covidMN_final, match.ID = FALSE)

bins <- c(0, 1000, 5000, 10000, 100000, Inf)
pal <- colorBin("magma", pretty = TRUE, domain = map$cases, bins = bins)

labels <- sprintf("<strong> %s </strong> <br/> Observed: %s", map$county, map$cases) %>%
  lapply(htmltools::HTML)

l <- leaflet(map) %>% addTiles() %>% setView(lng = -93.1616, lat = 44.4583, zoom = 5) 

l %>% addPolygons(color = "grey", weight = 1,
                  fillColor = ~pal(cases), fillOpacity = 0.7,
                  highlightOptions = highlightOptions(weight = 5),
                  label = labels) %>%
  addLegend(pal = pal, values = ~cases, opacity = 0.5, 
            title = "Observed Cases", 
            position = "bottomright")

```

---

# Interactive leaflet map

```{r, echo=FALSE, fig.height=7, fig.width=5}

l <- leaflet(map) %>% addTiles() %>% setView(lng = -93.1616, lat = 46, zoom = 6) 

l %>% addPolygons(color = "grey", weight = 1,
                  fillColor = ~pal(cases), fillOpacity = 0.7,
                  highlightOptions = highlightOptions(weight = 5),
                  label = labels) %>%
                  addLegend(pal = pal, values = ~cases, opacity = 0.5, 
                            title = "Observed Cases", 
                            position = "bottomright")

```



---

`r chunk_reveal("demo6", widths = c(40, 40), font_size_code="80%", title = "# Objects needed for plotting", display_type = c("code"))`

```{r, demo6, eval=FALSE, echo=FALSE}
library(leaflet) # for leaflet maps
library(maps) # for map data
library(sp) # for spatial polygons
library(maptools) # for sp polygon data frame


MNcounty <- map("county", "Minnesota", plot=FALSE, fill=TRUE)
MNmap <- map2SpatialPolygons(MNcounty, IDs = MNcounty$names)
map <- SpatialPolygonsDataFrame(MNmap, covidMN_final, match.ID = FALSE)



pal <- colorNumeric(palette = "viridis", alpha = TRUE, domain = map$cases)
bins <- c(0, 1000, 5000, 10000, 100000, Inf)
pal <- colorBin("viridis", domain = map$cases, bins = bins)

labels <- sprintf("<strong> %s </strong> <br/> Observed: %s", map$county, map$cases) %>%
  lapply(htmltools::HTML)

l <- leaflet(map) %>% addTiles() %>% setView(lng = -93.1616, lat = 44.4583, zoom = 5) 

l %>% addPolygons(color = "grey", weight = 1,
                  fillColor = ~pal(cases), fillOpacity = 0.7,
                  highlightOptions = highlightOptions(weight = 5),
                  label = labels) %>%
  addLegend(pal = pal, values = ~cases, opacity = 0.5, 
            title = "Observed Cases", 
            position = "bottomright")

```

---

# Interactive leaflet map

```{r, echo=FALSE, fig.height=7, fig.width=5}

l <- leaflet(map) %>% addTiles() %>% setView(lng = -93.1616, lat = 46, zoom = 6) 

l %>% addPolygons(color = "grey", weight = 1,
                  fillColor = ~pal(cases), fillOpacity = 0.7,
                  highlightOptions = highlightOptions(weight = 5),
                  label = labels) %>%
                  addLegend(pal = pal, values = ~cases, opacity = 0.5, 
                            title = "Observed Cases", 
                            position = "bottomright")

```

---


`r chunk_reveal("demo7", widths = c(40, 40), font_size_code="80%", title = "# Another example", display_type = c("code"))`

```{r, demo7, eval=FALSE, echo=FALSE}
# Scrape the data
covid_final <- read_html("https://usafacts.org/visualizations/covid-vaccine-tracker-states/state/minnesota") %>%
  html_elements(css = "table") %>% html_table() %>% .[[1]] %>%
  janitor::clean_names() %>%
  mutate_at(2:4, parse_number) %>% mutate(state = str_to_lower(state)) %>%
  filter(state %in% c("minnesota", "wisconsin", "iowa", "michigan", "illinois", "indiana"))

# Prepare the map
USA <- maps::map("state", regions = c("minnesota", "wisconsin", "iowa", "michigan", "illinois","indiana"), plot = FALSE, fill=TRUE) %>%
  map2SpatialPolygons(IDs = str_remove(.$names, "(?=:).+"))

# Merge the data and the map
map <- SpatialPolygonsDataFrame(USA, covid_final, match.ID = FALSE)

# Create bins and color palette
bins <- seq(min(map$percent_fully_vaccinated), max(map$percent_fully_vaccinated), length.out = 6)
pal <- colorBin("viridis", domain = map$percent_fully_vaccinated, bins = bins)

# Create labels
labels <- sprintf("<strong> %s </strong> <br/> Observed: %s", str_to_upper(map$state), map$percent_fully_vaccinated) %>%
  lapply(htmltools::HTML)

# Plot the map
leaflet(map) %>% 
  addTiles() %>% 
  setView(lng = -93.1616, lat = 44.4583, zoom = 4) %>%
  addPolygons(
    color = "grey", 
    weight = 1,
    fillColor = ~pal(percent_fully_vaccinated), 
    fillOpacity = 0.7,
    highlightOptions = highlightOptions(weight = 5),
    label = labels
  ) %>%
  addLegend(
    pal = pal, 
    values = ~percent_fully_vaccinated, 
    opacity = 0.5, 
    title = "Percent Vaccn.", 
    position = "bottomright"
  )

```

---

# Interactive leaflet map 2

```{r, echo=FALSE, fig.height=7, fig.width=5}
# Scrape the data
covid_final <- read_html("https://usafacts.org/visualizations/covid-vaccine-tracker-states/state/minnesota") %>%
  html_elements(css = "table") %>% html_table() %>% .[[1]] %>%
  janitor::clean_names() %>%
  mutate_at(2:4, parse_number) %>% mutate(state = str_to_lower(state)) %>%
  filter(state %in% c("minnesota", "wisconsin", "iowa", "michigan", "illinois", "indiana"))

# Prepare the map
USA <- maps::map("state", regions = c("minnesota", "wisconsin", "iowa", "michigan", "illinois","indiana"), plot = FALSE, fill=TRUE) %>%
  map2SpatialPolygons(IDs = str_remove(.$names, "(?=:).+"))

# Merge the data and the map
map <- SpatialPolygonsDataFrame(USA, covid_final, match.ID = FALSE)

# Create bins and color palette
bins <- seq(min(map$percent_fully_vaccinated), max(map$percent_fully_vaccinated), length.out = 6)
pal <- colorBin("viridis", domain = map$percent_fully_vaccinated, bins = bins)

# Create labels
labels <- sprintf("<strong> %s </strong> <br/> Observed: %s", str_to_upper(map$state), map$percent_fully_vaccinated) %>%
  lapply(htmltools::HTML)

# Plot the map
leaflet(map) %>% 
  addTiles() %>% 
  setView(lng = -93.1616, lat = 44.4583, zoom = 4) %>%
  addPolygons(
    color = "grey", 
    weight = 1,
    fillColor = ~pal(percent_fully_vaccinated), 
    fillOpacity = 0.7,
    highlightOptions = highlightOptions(weight = 5),
    label = labels
  ) %>%
  addLegend(
    pal = pal, 
    values = ~percent_fully_vaccinated, 
    opacity = 0.5, 
    title = "Percent Vaccn.", 
    position = "bottomright"
  )

```



---

class: action, middle

# <i class="fa fa-pencil-square-o" style="font-size:48px;color:purple">&nbsp;Group&nbsp;Activity&nbsp;`r (yt <- yt + 1)`</i>    


.pull-left-40[
![](https://media.giphy.com/media/RKApDdwsQ6jkwd6RNn/giphy.gif)
]
.pull-right-60[
<br>
.bql[
- Let's go over to maize server/ local Rstudio and our class [moodle](https://moodle.carleton.edu/course/view.php?id=41417)
- Get the class activity 20.Rmd file
- Work on activity 1
- Ask me questions
]

]

`r countdown(minutes = 15, seconds = 00, top = 0 , color_background = "inherit", padding = "3px 4px", font_size = "2em")`
