---
title: "Factor manipulations"
subtitle: "<br/> Spring 2023"
author: "Bastola"
date: "`r format(Sys.Date(), ' %B %d %Y')`"
output:
  xaringan::moon_reader:
    css: ["default", css/xaringan-themer-solns.css, css/my-theme.css, css/my-font.css]
    lib_dir: libs
    chakra: libs/remark-latest.min.js
    seal: false
    nature:
      highlightStyle: googlecode  #http://arm.rbind.io/slides/xaringan.html#77 # idea, magula
      highlightLines: true
      highlightLanguage: ["r", "css", "yaml"]
      countIncrementalSlides: true
      slideNumberFormat: "%current%"
      titleSlideClass: ["left", "middle", "inverse"]
      ratio: "16:9"
    includes:
      in_header: header.html
editor_options: 
  chunk_output_type: console
header-includes:
    - \usepackage{caption}
---



```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
options(htmltools.preserve.raw = FALSE)
options(ggrepel.max.overlaps = Inf)

knitr::opts_chunk$set(echo = TRUE, 
                      dev = 'svg',
                      collapse = TRUE, 
                      comment = NA,  # PRINTS IN FRONT OF OUTPUT, default is '##' which comments out output
                      prompt = FALSE, # IF TRUE adds a > before each code input
                      warning = FALSE, 
                      message = FALSE,
                      fig.height = 3, 
                      fig.width = 4,
                      out.width = "100%",
                      prompt = FALSE,
                      rows.print=7
                      )

# load necessary packages
library(tidyverse)
library(dplyr)
library(countdown)
library(mosaic)
library(ggthemes)
library(xaringanExtra)
library(forcats)
xaringanExtra::use_panelset()
xaringanExtra::use_tachyons()
xaringanExtra::use_clipboard()
xaringanExtra::use_extra_styles(
  hover_code_line = TRUE,         
  mute_unhighlighted_code = TRUE  
)
library(flipbookr)
library(patchwork)
library(DT)
library(moderndive)
library(knitr)
library(grid)
library(gridExtra)
library(palmerpenguins)
library(broom)
library(ggResidpanel)
library(ggrepel)
library(lubridate)

# specific packages
library(maps)
library(maptools)
library(polite)
library(rvest)
library(stringr)
select <- dplyr::select

# Set ggplot theme
# theme_set(theme_stata(base_size = 10))

yt <- 0

# read.csv("https://raw.githubusercontent.com/deepbas/statdatasets/main/agstrat.csv")

desserts <- read.csv("https://raw.githubusercontent.com/deepbas/statdatasets/main/desserts.csv")

energy <- readr::read_csv("https://raw.githubusercontent.com/deepbas/statdatasets/main/energy.csv",
                    col_type = cols(
                     .default = col_double(), 
                      Timestamp = col_datetime(format = ""),
                      dayWeek = col_factor(levels=c("Mon","Tues","Wed","Thurs","Fri","Sat","Sun"))
                     ))

energy_narrow <- energy %>%
  pivot_longer(
    cols = `100_Nevada_Street`:Wilson_House, 
    names_to = "building",
    values_to = "energyKWH"
  )

```



```{r xaringanExtra-clipboard, echo=FALSE}
htmltools::tagList(
  xaringanExtra::use_clipboard(
    button_text = "<i class=\"fa fa-clipboard\"></i>",
    success_text = "<i class=\"fa fa-check\" style=\"color: #90BE6D\"></i>",
    error_text = "<i class=\"fa fa-times-circle\" style=\"color: #F94144\"></i>"
  ),
  rmarkdown::html_dependency_font_awesome()
)
```


layout: true
  
---

class: title-slide, middle

# .fancy[Factor manipulations]

### .fancy[Spring 2023]

`r format(Sys.Date(), ' %B %d %Y')`

---


class: middle


# Factors - categorical data

.pull-left-60[
<center><img src="images/forcats_cheatsheet.png" width="90%" height="90%"></center>

]
.pull-right-40[
<br>
.bql.font90[
- Clean and order factors with `forcats` package

- Important for visualization, statistical modeling (i.e. for `lm()`), and creating tables

]

]

.footnote[See [`forcats` cheatsheet](https://github.com/rstudio/cheatsheets/raw/master/factors.pdf)
and [`forcats` vignette]()]

---


class: middle


#  Example - specify levels `fct_relevel()`

.pull-left[
```{r}
mydata <- tibble(
  id = 1:4, 
  grade=c("9th","10th","11th","9th")) %>%
  mutate(grade_fac = factor(grade)) #<<
levels(mydata$grade_fac)
```


```{r}
mydata %>% 
  arrange(grade_fac)
```

]

.pull-right[

```{r}
mydata <- mydata %>% 
  mutate(
    grade_fac = #<<
      fct_relevel(grade_fac, #<<
                  c("9th","10th","11th"))) #<<
levels(mydata$grade_fac)
```


```{r}
mydata %>% arrange(grade_fac)
```

]

---


class: middle


# Example - collapse levels `fct_collapse()`

```{r}
mydata <- tibble(loc = c("SW","NW","NW","NE","SE","SE"))
mydata %>% mutate(
  loc_fac = factor(loc),
  loc2 = fct_collapse(loc_fac,                         # collapse levels #<<
                      south = c("SW","SE"), #<<
                      north = c("NE","NW")), #<<
  loc3 = fct_lump(loc_fac, 
                  n=2,
                  other_level = "other") # most common 2 levels + other
  )
```

---


class: middle


# Example - collapse levels `fct_collapse()`

```{r}
mydata <- tibble(loc = c("SW","NW","NW","NE","SE","SE"))
mydata %>% mutate(
  loc_fac = factor(loc),
  loc2 = fct_collapse(loc_fac,                         # collapse levels 
                      south = c("SW","SE"), 
                      north = c("NE","NW")), 
  loc3 = fct_lump(loc_fac,  #<<
                  n=2,       #<<
                  other_level = "other") # most common 2 levels + other #<<
  )
```

---

class: middle

# Order factor levels: `fct_infreq()`


.hljs[`fct_infreq()` : This function orders factor levels by their frequency in the data.]



```{r}
# Order factor levels by their frequency
mydata <- tibble(
  id = 1:8, 
  grade = c("9th", "10th", "11th", "9th", "10th", "11th", "9th", "9th")) %>%
  mutate(grade_fac = factor(grade))

mydata <- mydata %>%
  mutate(grade_fac = fct_infreq(grade_fac)) #<<

levels(mydata$grade_fac)

```


---

class: middle


# `fct_rev()` : Reverse the order of factor levels

```{r}
# Reverse the order of factor levels
mydata <- tibble(
  id = 1:4, 
  grade = c("9th", "10th", "11th", "9th")) %>%
  mutate(grade_fac = factor(grade))

mydata <- mydata %>%
  mutate(grade_fac = fct_rev(grade_fac)) #<<

levels(mydata$grade_fac)
```


---

class: middle


# `fct_shitf()`

.hljs[`fct_shift()`: Shift factor levels by a specified number of positions, either to the left or right.]


```{r}
# Shift factor levels to the right by 1 position
mydata <- tibble(
  id = 1:4, 
  grade = c("9th", "10th", "11th", "9th")) %>%
  mutate(grade_fac = factor(grade))

mydata <- mydata %>%
  mutate(grade_fac = fct_shift(grade_fac, n = 1)) #<<

levels(mydata$grade_fac)
```


---


class: middle


# `fct_anon()`

.hljs[`fct_anon()`: Anonymize factor levels by replacing them with unique, randomly generated character strings.]

```{r}
# Anonymize factor levels
mydata <- tibble(
  id = 1:4, 
  grade = c("9th", "10th", "11th", "9th")) %>%
  mutate(grade_fac = factor(grade))

mydata <- mydata %>%
  mutate(grade_fac = fct_anon(grade_fac)) #<<

levels(mydata$grade_fac)

```


---


class: action, middle

# <i class="fa fa-pencil-square-o" style="font-size:48px;color:purple">&nbsp;Group&nbsp;Activity&nbsp;`r (yt <- yt + 1)`</i>    


.pull-left-40[
![](https://media.giphy.com/media/RKApDdwsQ6jkwd6RNn/giphy.gif)
]
.pull-right-60[
<br>
<br>
.bql.font90[
- Let's go over to maize server/ local Rstudio and our class [moodle](https://moodle.carleton.edu/course/view.php?id=41417)
- Get the class activity 10.Rmd file
- Work on your turn 1
- Ask me questions
]

]

`r countdown(minutes = 10, seconds = 00, top = 0 , color_background = "inherit", padding = "3px 4px", font_size = "2em")`

---


class: middle


## `gss_cat`

.bq.font80[A sample of data from the General Social Survey, a long-running US survey conducted by NORC at the University of Chicago.]


```{r echo=FALSE}
gss_cat
```

---

`r chunk_reveal("gss-religion-tv", font_size_code="90%", title = "## Which religions watch the least TV?")`

```{r gss-religion-tv, fig.width = 3, fig.height = 3.5, out.width = "100%", include=FALSE}
gss_cat %>%
  tidyr::drop_na(tvhours) %>%
  group_by(relig) %>%
  summarize(tvhours = mean(tvhours)) %>%
  ggplot(aes(tvhours, relig)) +
    geom_point()
```


---

# Which one do you prefer?

```{r gss-religion-oredering, fig.width = 8, fig.height = 3.5, out.width = "100%", echo=FALSE}
p1 <- gss_cat %>%
  drop_na(tvhours) %>%
  group_by(relig) %>%
  summarize(tvhours = mean(tvhours)) %>%
  ggplot(aes(tvhours, relig)) +
    geom_point()

p2 <- gss_cat %>%
  drop_na(tvhours) %>%
  group_by(relig) %>%
  summarize(tvhours = mean(tvhours)) %>%
  ggplot(aes(tvhours, fct_reorder(relig, tvhours))) +
    geom_point() +
  labs(y = "relig")

p1 + p2
```

---


## Why is the y-axis in this order?

```{r echo=FALSE, fig.height = 3.25, fig.width = 4, fig.align='center', out.width = "62%"}
p1
```

---

`r chunk_reveal("levels", font_size_code="90%", title = "## Use levels() to access a factorâ€™s levels")`

.scroll-output-20[
```{r levels, fig.width = 3, fig.height = 3.5, out.width = "100%", include=FALSE}
gss_cat %>% 
  pull(relig) %>% 
  levels() %>% 
  kable()

```
]

---
class: middle 
# Most useful factor skills

.bql[
## 1. **Reorder** the levels

## 2. **Recode** the levels

## 3. **Collapse** levels

## 4. **Lump** levels
]


---

`r chunk_reveal("reorder-tv-relig", break_type = "rotate", font_size_code="90%", widths = c(1,1), title = "## Reorder relig by tvhours")`

```{r reorder-tv-relig, echo=FALSE, eval=FALSE}
gss_cat %>%
  drop_na(tvhours) %>%
  group_by(relig) %>%
  summarize(tvhours = mean(tvhours)) %>%
  ggplot(aes(
    x = tvhours, 
    y = relig  #ROTATE
    y = fct_reorder(relig, tvhours)                 #ROTATE
  )) +
    geom_point()
```


---

## Which political leaning watches more TV?


```{r echo=FALSE, fig.height = 3, fig.width = 4, out.width = "50%", fig.align='center'}
gss_cat %>%
   drop_na(tvhours) %>%
   group_by(partyid) %>%
   summarize(tvhours = mean(tvhours)) %>%
   ggplot(aes(tvhours, fct_reorder(partyid, tvhours))) +
     geom_point() +
     labs(y = "partyid")
```

--

.out-t.center[How could we improve the `partyid` labels?]

---

`r chunk_reveal("fct-recode-partyid", widths = c(60, 40), font_size_code="90%", title = "## Recoding partyid with fct_recode()")`


```{r fct-recode-partyid, echo=FALSE, eval=FALSE}
gss_cat %>%
  drop_na(tvhours) %>%
  select(partyid, tvhours) %>%
    mutate(partyid = fct_recode(partyid,
    "Republican, strong"    = "Strong republican",
    "Republican, weak"      = "Not str republican",
    "Independent, near rep" = "Ind,near rep",
    "Independent, near dem" = "Ind,near dem",
    "Democrat, weak"        = "Not str democrat",
    "Democrat, strong"      = "Strong democrat")) %>% 
  group_by(partyid) %>%
  summarize(tvhours = mean(tvhours)) %>%
  ggplot(aes(tvhours, fct_reorder(partyid, tvhours))) +
  geom_point() + 
  labs(y = "partyid")
```

---

`r chunk_reveal("fct-collapse-partyid", widths = c(50, 50), font_size_code="90%", title = "## Collapsing partyid: fct_collapse()")`


```{r fct-collapse-partyid, eval=FALSE, echo=FALSE}
gss_cat %>%
  drop_na(tvhours) %>%
  select(partyid, tvhours) %>%
  mutate(
    partyid = 
      fct_collapse(
        partyid,
        conservative = c("Strong republican", 
                         "Not str republican", 
                         "Ind,near rep"),
        liberal = c("Strong democrat", 
                    "Not str democrat", 
                    "Ind,near dem"))
  ) %>% 
  group_by(partyid) %>%
  summarize(tvhours = mean(tvhours)) %>%
  ggplot(aes(tvhours, fct_reorder(partyid, tvhours))) +
  geom_point() + 
  labs(y = "partyid")
```

```{r include=FALSE}
gss_cat <- gss_cat %>%
  drop_na(tvhours) %>%
  mutate(
    partyid = 
      fct_collapse(
        partyid,
        conservative = c("Strong republican", 
                         "Not str republican", 
                         "Ind,near rep"),
        liberal = c("Strong democrat", 
                    "Not str democrat", 
                    "Ind,near dem"))
  )
```

---

`r chunk_reveal("fct-lump-partyid", widths = c(50, 50), font_size_code="80%", title = "## Lumping partyid: fct_lump()", break_type = "rotate")`


```{r fct-lump-partyid, eval=FALSE, echo=FALSE}
gss_cat %>%
  mutate(partyid = partyid) %>% #ROTATE
  mutate(partyid = fct_lump(partyid, n = 2)) %>% #ROTATE
  mutate(partyid = fct_lump(partyid, n = 2)) %>% #ROTATE
  mutate(partyid = fct_lump(partyid, n = 3)) %>% #ROTATE
  ggplot(aes(x = fct_infreq(partyid))) + 
  geom_bar() +
  theme(axis.text.x = element_text(angle = 20, 
                                  vjust = 1,
                                  hjust=1)) +
  labs(x = "partyid")
```

---

# Summary


.hljs[To enhance your data analysis, you can use the following factor manipulation techniques:]

.bql[
- Reorder the levels to arrange them in a meaningful order.
- Recode the levels to modify the labels or merge similar categories.
- Collapse levels to group multiple categories into one.
- Lump levels to reduce the number of categories by combining less frequent ones.
]



---

class: action, middle

# <i class="fa fa-pencil-square-o" style="font-size:48px;color:purple">&nbsp;Group&nbsp;Activity&nbsp;`r (yt <- yt + 1)`</i>    


.pull-left-40[
![](https://media.giphy.com/media/RKApDdwsQ6jkwd6RNn/giphy.gif)
]
.pull-right-60[
<br>
<br>
.bql.font90[
- Work on your turn 2
- Ask me questions
]

]

`r countdown(minutes = 10, seconds = 00, top = 0 , color_background = "inherit", padding = "3px 4px", font_size = "2em")`

