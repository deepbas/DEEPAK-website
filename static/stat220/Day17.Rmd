---
title: "Advanced Web Scraping"
subtitle: "<br/> Spring 2023"
author: "Bastola"
date: "`r format(Sys.Date(), ' %B %d %Y')`"
output:
  xaringan::moon_reader:
    css: ["default", css/xaringan-themer-solns.css, css/my-theme.css, css/my-font.css]
    lib_dir: libs
    chakra: libs/remark-latest.min.js
    seal: false
    nature:
      highlightStyle: googlecode  #http://arm.rbind.io/slides/xaringan.html#77 # idea, magula
      highlightLines: true
      highlightLanguage: ["r", "css", "yaml"]
      countIncrementalSlides: true
      slideNumberFormat: "%current%"
      titleSlideClass: ["left", "middle", "inverse"]
      ratio: "16:9"
    includes:
      in_header: header.html
editor_options: 
  chunk_output_type: console
header-includes:
    - \usepackage{caption}
---


```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
options(htmltools.preserve.raw = FALSE)
options(ggrepel.max.overlaps = Inf)

knitr::opts_chunk$set(echo = TRUE, 
                      dev = 'svg',
                      collapse = TRUE, 
                      comment = NA,  # PRINTS IN FRONT OF OUTPUT, default is '##' which comments out output
                      prompt = FALSE, # IF TRUE adds a > before each code input
                      warning = FALSE, 
                      message = FALSE,
                      fig.height = 3, 
                      fig.width = 4,
                      out.width = "100%",
                      prompt = FALSE,
                      rows.print=7
                      )

# load necessary packages
library(tidyverse)
library(countdown)
library(mosaic)
library(ggthemes)
library(xaringanExtra)
library(forcats)
xaringanExtra::use_panelset()
xaringanExtra::use_tachyons()
xaringanExtra::use_clipboard()
xaringanExtra::use_extra_styles(
  hover_code_line = TRUE,         
  mute_unhighlighted_code = TRUE  
)
library(flipbookr)
library(patchwork)
library(DT)
library(knitr)
library(grid)
library(gridExtra)
library(ggrepel)
library(lubridate)

# specific packages
library(plotly)
library(polite)
library(rvest)
library(stringr)
select <- dplyr::select

# Set ggplot theme
# theme_set(theme_stata(base_size = 10))

yt <- 0

# read.csv("https://raw.githubusercontent.com/deepbas/statdatasets/main/agstrat.csv")

base_url <- "https://www.the-numbers.com/movie/budgets/all"
base_webpage <- read_html(base_url)
table_base <- html_table(base_webpage)[[1]]

# all webpages
new_urls <- "https://www.the-numbers.com/movie/budgets/all/"

# creating one table
table_new <-data.frame()
df_movies <- data.frame()

# iterator
idx <-  seq(1, 6301, 100)

# it loops through 5501 times so as to extract and then store and then combine about 5000 movies so far extracted.

for (i in 1:length(idx)) {
  new_webpage <- read_html(str_glue(new_urls, {idx[i]})) 
  table_new <- html_table(new_webpage)[[1]] %>%
  tibble::as_tibble(.name_repair = "unique")
  df_movies <- rbind(df_movies, table_new)
}

df_movies_tidy <- df_movies %>% rename(ID = `...1`) %>%
  mutate(ProductionBudget = parse_number(ProductionBudget),
         DomesticGross = parse_number(DomesticGross),
         WorldwideGross = parse_number(WorldwideGross),
         ReleaseDate = mdy(ReleaseDate),
         ReleaseDate = replace_na(ReleaseDate, make_date()),
         MonthOfRelease = month(ReleaseDate, label = TRUE),
         YearOfRelease = year(ReleaseDate))

df_DomesticGross_month <- df_movies_tidy %>%
  select(MonthOfRelease, DomesticGross) %>%
  group_by(MonthOfRelease) %>%
  summarize(AverageByMonth = mean(DomesticGross))
```



```{r xaringanExtra-clipboard, echo=FALSE}
htmltools::tagList(
  xaringanExtra::use_clipboard(
    button_text = "<i class=\"fa fa-clipboard\"></i>",
    success_text = "<i class=\"fa fa-check\" style=\"color: #90BE6D\"></i>",
    error_text = "<i class=\"fa fa-times-circle\" style=\"color: #F94144\"></i>"
  ),
  rmarkdown::html_dependency_font_awesome()
)
```


layout: true
  
---

class: title-slide, middle

# .fancy[Advanced Web Scraping]

### .fancy[Stat 220]

`r format(Sys.Date(), ' %B %d %Y')`


---

`r chunk_reveal("demo2", widths = c(60, 60), font_size_code="80%", title = "## Get links")`

```{r demo2, eval=FALSE, echo=FALSE }
bow(url = "https://www.imdb.com/search/title/?groups=best_picture_winner&sort=year,desc&count=100&view=advanced") %>%
  scrape() %>%
  html_elements(css = ".lister-item-header a") %>%
  html_attr(name = "href") %>%
  url_absolute(base = "https://www.imdb.com")
```


---


# Scrape table

.scroll-box-32[
```{r}
table_usafacts <- bow(url = "https://usafacts.org/visualizations/covid-vaccine-tracker-states/state/minnesota") %>%
  scrape() %>% html_elements(css = "table") %>% html_table() %>% pluck(1)
knitr::kable(table_usafacts, format = "html")
```
]


.footnote[Click [here](https://usafacts.org/visualizations/covid-vaccine-tracker-states/state/minnesota) to take a look at the webpage]


---

# Scraping multiple tables

```{r}
all_url <- "https://finance.yahoo.com/screener/predefined/day_gainers?count=25&offset=" #<<
idx <- seq(0, 1050, by = 25)  


my_list <- list()

for (i in seq_along(idx)) {
  new_webpage <- read_html(str_glue({all_url}, {idx[i]})) # same as bow(url) %>% scrape() 
  table_new <- html_table(new_webpage)[[1]] %>%  # first element of the list
    as_tibble(.name_repair = "unique")  # repairs same column names
  my_list[[i]] <- table_new
}

my_df <- do.call(rbind, my_list)

```


.footnote[Click [here](https://finance.yahoo.com/gainers?count=25&offset=0) to take a look at the webpage]

---

### Multiple tables combined

.scroll-output[
```{r, echo=FALSE}
DT::datatable(
  my_df %>% select(-`52 Week Range`),
  fillContainer = FALSE, options = list(pageLength = 5)
)
```
]


---

class: action, middle

# <i class="fa fa-pencil-square-o" style="font-size:48px;color:purple">&nbsp;Group&nbsp;Activity&nbsp;`r (yt <- yt + 1)`</i>    


.pull-left-40[
![](https://media.giphy.com/media/RKApDdwsQ6jkwd6RNn/giphy.gif)
]
.pull-right-60[
<br>
.bql.font90[
- Let's go over to maize server/ local Rstudio and our class [moodle](https://moodle.carleton.edu/course/view.php?id=41417)
- Get the class activity 17.Rmd file
- Work on activity 1
]

]

`r countdown(minutes = 5, seconds = 00, top = 0 , color_background = "inherit", padding = "3px 4px", font_size = "2em")`


---


`r chunk_reveal("demo3", widths = c(60, 40), font_size_code="80%", title = "## Tidy further")`

```{r,demo3, eval=FALSE, echo=FALSE }
df_movies %>% 
  rename(ID = `...1`) %>% 
  mutate(ProductionBudget = parse_number(ProductionBudget),
         DomesticGross = parse_number(DomesticGross),
         WorldwideGross = parse_number(WorldwideGross),
         ReleaseDate = mdy(ReleaseDate),
         ReleaseDate = replace_na(ReleaseDate, make_date()),
         MonthOfRelease = month(ReleaseDate, label = TRUE),
         YearOfRelease = year(ReleaseDate)) %>%
  select(MonthOfRelease, DomesticGross) %>%
  group_by(MonthOfRelease) %>%
  summarize(AverageByMonth = mean(DomesticGross))
```


---

class: middle


# Interactive Donut Plot

```{r, echo=FALSE, fig.height=7, fig.width=6}
fig <- df_DomesticGross_month %>% plot_ly(labels = ~MonthOfRelease, values = ~AverageByMonth)
fig <- fig %>% add_pie(hole = 0.6)
fig <- fig %>% layout(title = "Average Domestic Gross by Month",  showlegend = F,
                      xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
                      yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig
```

---

class: middle

# Interactive visualizations using `ggplotly`

.scroll-box-16[
```{r}
midwest %>% as_tibble()
```
]



---

# Interactive visualizations using `ggplotly`

```{r, echo=FALSE, fig.height=7, fig.width=6}
midwest %>%
  filter(inmetro == T) %>%
  plot_ly(x =  ~ percbelowpoverty, y =  ~ percollege) %>%
  add_markers()
```

---

class: middle

# Interactive visualizations using `ggplotly`

```{r}
mtcars %>% as_tibble() %>% head()
```

--

```{r, fig.height=7, fig.width=6, eval=FALSE}
gp = mtcars %>%
  mutate(amFactor = factor(am, labels = c('auto', 'manual')),
         hovertext = paste(wt, mpg, amFactor)) %>%
  arrange(wt) %>%
  ggplot(aes(x = wt, y = mpg, color = amFactor)) +
  geom_smooth(se = F) +
  geom_point(aes(color = amFactor)) + theme_economist_white()
```

--


```{r}
ggplotly()  #<<
```


---

# Interactive visualizations using `ggplotly`

```{r, echo=FALSE, fig.height=7, fig.width=6}
gp = mtcars %>%
  mutate(amFactor = factor(am, labels = c('auto', 'manual')),
         hovertext = paste(wt, mpg, amFactor)) %>%
  arrange(wt) %>%
  ggplot(aes(x = wt, y = mpg, color = amFactor)) +
  geom_smooth(se = F) +
  geom_point(aes(color = amFactor))

ggplotly()
```

---

# DT: Interactive Data Tables

.code100[
```{r, eval=FALSE}
library(ggplot2movies)
movies %>%
  select(1:6) %>%
  filter(rating > 8, !is.na(budget), votes > 1000) %>% 
  datatable(fillContainer = FALSE, options = list(pageLength = 6))
```
]

--

```{r, echo=FALSE}
library(ggplot2movies)
movies %>%
  select(1:6) %>%
  filter(rating > 8, !is.na(budget), votes > 1000) %>% 
  datatable(fillContainer = FALSE, options = list(pageLength = 6))
```

---


class: action, middle

# <i class="fa fa-pencil-square-o" style="font-size:48px;color:purple">&nbsp;Group&nbsp;Activity&nbsp;`r (yt <- yt + 1)`</i>    


.pull-left-40[
![](https://media.giphy.com/media/RKApDdwsQ6jkwd6RNn/giphy.gif)
]
.pull-right-60[
<br>
<br>
.bq[
- Work on activity 2
- Ask me questions
]

]

`r countdown(minutes = 15, seconds = 00, top = 0 , color_background = "inherit", padding = "3px 4px", font_size = "2em")`



