---
title: "Post-ANOVA"
subtitle: "<br/> STAT 120"
author: "Bastola"
date: "`r format(Sys.Date(), ' %B %d %Y')`"
output:
  xaringan::moon_reader:
    css: ["default", css/xaringan-themer-solns.css, css/my-theme.css, css/my-font.css]
    lib_dir: libs
    chakra: libs/remark-latest.min.js
    seal: false
    nature:
      highlightStyle: googlecode  #http://arm.rbind.io/slides/xaringan.html#77 # idea, magula
      highlightLines: true
      highlightLanguage: ["r", "css", "yaml"]
      countIncrementalSlides: true
      slideNumberFormat: "%current%"
      titleSlideClass: ["left", "middle", "inverse"]
      ratio: "16:9"
    includes:
      in_header: header.html
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
options(htmltools.preserve.raw = FALSE)
options(ggrepel.max.overlaps = Inf)

knitr::opts_chunk$set(echo = TRUE, 
                      dev = 'svg',
                      collapse = FALSE, 
                      comment = NA,  # PRINTS IN FRONT OF OUTPUT, default is '##' which comments out output
                      prompt = FALSE, # IF TRUE adds a > before each code input
                      warning = FALSE, 
                      message = FALSE,
                      fig.height = 3, 
                      fig.width = 4,
                      out.width = "100%"
                      )

# load necessary packages
library(tidyverse)
library(dplyr)
library(countdown)
library(ggthemes)
library(xaringanExtra)
library(forcats)
xaringanExtra::use_panelset()
xaringanExtra::use_tachyons()
xaringanExtra::use_clipboard()
xaringanExtra::use_extra_styles(
  hover_code_line = TRUE,         
  mute_unhighlighted_code = TRUE  
)
library(flipbookr)
library(patchwork)
library(DT)
library(knitr)
library(grid)
library(gridExtra)


select <- dplyr::select

# Set ggplot theme
theme_set(theme_tufte(base_size = 10))

yt <- 0

# read.csv("https://raw.githubusercontent.com/deepbas/statdatasets/main/agstrat.csv")
```


```{r xaringanExtra-clipboard, echo=FALSE}
htmltools::tagList(
  xaringanExtra::use_clipboard(
    button_text = "<i class=\"fa fa-clipboard\"></i>",
    success_text = "<i class=\"fa fa-check\" style=\"color: #90BE6D\"></i>",
    error_text = "<i class=\"fa fa-times-circle\" style=\"color: #F94144\"></i>"
  ),
  rmarkdown::html_dependency_font_awesome()
)
```


layout: true
  
---

class: title-slide, middle

# .fancy[Post-ANOVA]

### .fancy[Stat 120]

`r format(Sys.Date(), ' %B %d %Y')`

---

class: middle

# Post-ANOVA

.bql.font90[ Inference .b[AFTER] doing .b[ANOVA] to compare means for several groups:
- Confidence interval for a single mean
- Confidence interval for a difference in two means
- Pairwise t-test for a difference in two means
- Multiple comparisons
]

---

class: middle

# ANOVA for Difference in Means

.bqt.font90[.b[Data:] Random samples of size $n_1, n_2, \cdots , n_k$ from each of k populations (or groups)

.b[Summary statistics:]

  - Sample mean for each group
  - Std. dev. for each group
  - Mean and std. dev. for all values
]

---

class: middle

# ANOVA for Difference in Means

.bql[
$$H_0:\mu_1 = \mu_2 = \cdots = \mu_k$$
$$H_a: \text{at least one } \mu_i \text{ is different}$$

- .bold[Conditions:] Similar variability AND either sample sizes in each group are large (each $n_i \geq 30$) OR the data are relatively normally distributed
]

---


# Cuckoo Birds

.pull-left-60[
.bql.font80[
- Cuckoo birds lay their eggs in the nests of other birds

- When the cuckoo baby hatches, it kicks out all the original eggs/babies

- If the cuckoo is lucky, the mother will raise the cuckoo as if it were her own
]
]

.pull-right-40[
<br>
<br>
<center>
<img src="images/cuckoo.jpg" width="80%" height="80%"> <br>
<a>Cuckoo bird in nest</a><br>
</center>
<br>
]

--

.green-h.font110[Do cuckoo bird eggs found in nests of different species differ in size?]

---

class: middle

# Cuckoo Dataset

.pull-left[
.bql.font80[
- .bold[cuckoo] dataset contains information on 120 Cuckoo eggs, obtained from randomly selected "foster" nests.

- researchers have measured the `length` (in mm) and established the `type` (species) of foster parent.
]

]
.pull-right[
<br>
.bq.font80[
- `Species=1`: Hedge Sparrow
- `Species=2`: Meadow Pit
- `Species=3`: Pied Wagtail
- `Species=4`: European Robin
- `Species=5`: Tree Pipit
- `Species=6`: Eurasian Wren

]

]

---

class: inverse, middle

.b.large.bql[Goal: test if the type of foster parent has an effect on the average length of the cuckoo eggs.]

---

`r chunk_reveal("cuckoo", widths= c(0.6,0.4), font_size_code="70%", title = "## ANOVA")`

```{r cuckoo, fig.width = 3, fig.height = 3.5, out.width = "100%", include=FALSE}
library(dplyr)
Cuckoo <- read.csv("https://raw.githubusercontent.com/deepbas/stat120datasets/main/cuckoos.csv")
Cuckoo <- Cuckoo %>%
  mutate(species = as.factor(species))   # change species to a categorical variable

stat <- Cuckoo %>% 
  group_by(species) %>%  # group by type
  summarize(mean(length), sd(length), length(length)) %>% # summarize various info
  `colnames<-`(c( "type", "mean", "sd", "n")) %>%  # change column names 
   as.data.frame() # change it to a data frame
knitr::kable(stat)
```

---

`r chunk_reveal("boxplot", widths= c(0.4,0.6), font_size_code="70%", title = "## Side-by-side Boxplot (1a)")`

.scroll-output[
```{r boxplot, fig.width = 3, fig.height = 3.5, out.width = "100%", include=FALSE}
Cuckoo %>%
  ggplot(aes(x=species,y=length,fill=species)) +
  theme_bw() +
  geom_boxplot() +
  geom_jitter(width = 0.2) +
  labs(title ="Boxplot of the length of eggs per type", 
       y = "length (mm)",
       x = "type") + 
  stat_summary(fun=mean, geom="point", shape=10, 
               size=2, color="red", fill="black") +
  ggthemes::theme_tufte() +
  theme(axis.text.x = element_text(angle = 25, hjust = 1, vjust = 0.5)) 

```
]

---

class: middle

# Check Assumptions (1b)

.bql[
$$H_0: \text{The mean egg length is equal between the different bird tpyes.}$$
$$H_a: \text{The mean egg length for at least one bird type is different }$$

Make sure that all assumptions for ANOVA are met:

- The data (length) must be normally distributed (in all groups)
- The variability within all groups is similar
]

---

`r chunk_reveal("normality", widths= c(0.3,0.7), font_size_code="70%", title = "## Approximate normality in groups (1b)")`

.scroll-output[
```{r normality, fig.width = 3, fig.height = 3.5, out.width = "100%", include=FALSE}
Cuckoo %>% 
  ggplot(aes(sample=length)) + 
  geom_qq() + 
  geom_qq_line() + 
  facet_grid(~species) +  
  theme(strip.text.x = element_text(size = 6)) 
```

]

---

# Fitting ANOVA (1c)

```{r, highlight.output = c(2)}
library(broom)
fit_anova <- aov(length~species, Cuckoo)
knitr::kable(tidy(fit_anova))
```

<br>

--

.bql[
Since the .b[p-value] is very small, at the significance level of $5\%$, we have sufficient evidence to conclude that the mean egg length for at least one bird type is .b[different] from the mean egg length in at least one other bird type.
]

--

.out-t.font100[But which of the species are different?]

---

class: middle

# Inference after ANOVA

.bql[Compute a CI for any $\mu_i$

$$\bar{x}_i \pm t^{*} \frac{s_i}{\sqrt{n_i}}$$
]

.b.font90[
.b[BUT] after .b[ANOVA], estimate any $\sigma$ with the pooled standard deviation:

$$\bar{x}_i \pm t^{*}\frac{\sqrt{MSE}}{\sqrt{n_i}}$$

the corresponding `df=n-k`
]

---

# Cuckoo Eggs (1d)
.bqt.font90[Find a 95% confidence interval for the mean cuckoo egg length in .b[European robin] nests (Type = 4).]

.pull-left-60[
.font80[
```{r}
MSE <- 0.8193847
knitr::kable(tidy(fit_anova))
```
]
]
.pull-right-40[
.font80[
```{r, echo=FALSE}
knitr::kable(stat)
```
]
]

$$\bar{x}_i \pm t^{*}\frac{\sqrt{MSE}}{\sqrt{n_i}}, \text{ df = n-k }$$

---

# Inference after ANOVA

$$H_0: \mu_i = \mu_j \text{ vs. } H_a: \mu_i \neq \mu_j$$


.bql.font90[Compute a CI for $\mu_i - \mu_j$

$$(\bar{x}_i - \bar{x}_j) \pm t^{*} \sqrt{\frac{s_i^2}{n_i} + \frac{s_j^2}{n_j}}$$

]

.b.font90[
Use the usual procedures except estimate any $\sigma$ with the pooled standard deviation: $\sqrt{MSE}$ and use the error degrees of freedom, `df=n-k`, for any t-values
  $$(\bar{x}_i - \bar{x}_j) \pm t^{*} \sqrt{MSE \left(\frac{1}{n_i} + \frac{1}{n_j}\right)}$$
]


---

# Cuckoo Eggs (1e)

Find a 95% CI for the difference in mean egg length between .b[European robin](type = 4) and .b[Eurasian wren](type = 6) nests.

.pull-left-60[

.font80[
```{r, echo=FALSE}
knitr::kable(tidy(fit_anova))
```
]
$$(22.556 - 21.120) \pm 1.981 \cdot \sqrt{0.8194\left(\frac{1}{16} + \frac{1}{15} \right)} = (0.792, 2.081)$$
]
.pull-right-40[
.font80[
```{r, echo=FALSE}
knitr::kable(stat)
```
]
]


.code70[
```{r, collapse=TRUE}
(stat[4,2] - stat[6,2]) + c(-1,1)* (qt(1-0.05/2, df=114))* sqrt(MSE*(1/stat[4,4] + 1/stat[6,4]))
```
]

--

.out-t.font80[Why is it important that the interval contains only positive values?]


---

# Cuckoo Eggs (1f)

.bql.font80[Find a 95% CI for the difference in mean egg length between .b[Pied Wagtail] (type = 3) and .b[European robin](type = 4)  nests.]

.pull-left-60[
.font80[
```{r, echo=FALSE}
knitr::kable(tidy(fit_anova))
```
]
$$(22.887 - 22.556) \pm 1.981\cdot \sqrt{0.8194\left(\frac{1}{15} + \frac{1}{16} \right)} = (-0.314, 0.975)$$

]
.pull-right-40[
.font80[
```{r, echo=FALSE}
knitr::kable(stat)
```
]
]

.code70[
```{r, collapse=TRUE}
(stat[3,2] - stat[4,2]) + c(-1,1)* (qt(1-0.05/2, df=114))*sqrt(MSE*(1/stat[3,4] + 1/stat[4,4]))
```
]


--

.out-t.font80[What does it mean if the interval contains 0?]

---

class: middle

# Mutiple Comparisons 

.bql.font90[Often, doing pairwise comparisons after ANOVA involves many tests

  - e.g. $k$ groups/categories,then we have $\frac{k(k-1)}{2}$ comparisons
  - $k=6$ bird species then 15 pairwise tests.
]

---

class: middle

# Mutiple Comparisons 


.bql.font90[If each test has an $\alpha$ chance of a Type I error (finding a difference between a pair that aren’t different),  the overall Type I error rate can be much higher.
]

.bqt[
Use a smaller $\alpha$ for each pairwise test (Bonferroni)
  - $\alpha^{*} = \frac{\alpha}{k}$
  - e.g $\alpha = 0.05$ and $k = 6$, then $\alpha^{*} = 0.05/6 =  0.0083$
]
---


# Cuckoo Eggs (1g)

> Which means are “different” at a $5\%$ significance level?

```{r}
pairwise.t.test(Cuckoo$length, Cuckoo$species, p.adjust.method =  "bonferroni")
```

---

class: action

# <i class="fa fa-pencil-square-o" style="font-size:48px;color:purple">&nbsp;Your&nbsp;Turn&nbsp;`r (yt <- yt + 1)`</i>    

.pull-left-40[
![](https://media.giphy.com/media/RKApDdwsQ6jkwd6RNn/giphy.gif)
]
.pull-right-60[

<br>
<br>

.bql[
- Go over to the in-class activity file
- Complete the remaining activity 
]
]

`r countdown(minutes = 10, seconds = 00, top = 0 , color_background = "inherit", padding = "3px 4px", font_size = "2em")`
