---
title: "Inference for multiple proportions"
subtitle: "<br/> STAT 120"
author: "Bastola"
date: "`r format(Sys.Date(), ' %B %d %Y')`"
output:
  xaringan::moon_reader:
    css: ["default", css/xaringan-themer-solns.css, css/my-theme.css, css/my-font.css]
    lib_dir: libs
    chakra: libs/remark-latest.min.js
    seal: false
    nature:
      highlightStyle: googlecode  #http://arm.rbind.io/slides/xaringan.html#77 # idea, magula
      highlightLines: true
      highlightLanguage: ["r", "css", "yaml"]
      countIncrementalSlides: true
      slideNumberFormat: "%current%"
      titleSlideClass: ["left", "middle", "inverse"]
      ratio: "16:9"
    includes:
      in_header: header.html
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
options(htmltools.preserve.raw = FALSE)
options(ggrepel.max.overlaps = Inf)

knitr::opts_chunk$set(echo = TRUE, 
                      dev = 'svg',
                      collapse = FALSE, 
                      comment = NA,  # PRINTS IN FRONT OF OUTPUT, default is '##' which comments out output
                      prompt = FALSE, # IF TRUE adds a > before each code input
                      warning = FALSE, 
                      message = FALSE,
                      fig.height = 3, 
                      fig.width = 4,
                      out.width = "100%"
                      )

# load necessary packages
library(tidyverse)
library(dplyr)
library(countdown)
library(ggthemes)
library(xaringanExtra)
library(forcats)
xaringanExtra::use_panelset()
xaringanExtra::use_tachyons()
xaringanExtra::use_clipboard()
xaringanExtra::use_extra_styles(
  hover_code_line = TRUE,         
  mute_unhighlighted_code = TRUE  
)
library(flipbookr)
library(patchwork)
library(DT)
library(knitr)
library(grid)
library(gridExtra)


select <- dplyr::select

# Set ggplot theme
theme_set(theme_tufte(base_size = 10))

yt <- 0

set.seed(1234)



# read.csv("https://raw.githubusercontent.com/deepbas/statdatasets/main/agstrat.csv")

```


```{r xaringanExtra-clipboard, echo=FALSE}
htmltools::tagList(
  xaringanExtra::use_clipboard(
    button_text = "<i class=\"fa fa-clipboard\"></i>",
    success_text = "<i class=\"fa fa-check\" style=\"color: #90BE6D\"></i>",
    error_text = "<i class=\"fa fa-times-circle\" style=\"color: #F94144\"></i>"
  ),
  rmarkdown::html_dependency_font_awesome()
)
```


layout: true
  
---

class: title-slide, middle

# .fancy[Inference for multiple proportions]

### .fancy[Stat 120]

`r format(Sys.Date(), ' %B %d %Y')`

---

class: middle

# Tests for Categorical Variable(s)

.blockquote[
Chi-square test for association

- Determine if a relationship between two categorical variables is statistically significant
- E.g. Does M&M color distribution depend on type (chocolate vs. peanut)?
]

---

# Chi-square test for association hypothesis

.blockquote[
- Hypotheses look like

$$H_0: \textrm{two categorical variables are not associated}$$
$$H_A: \textrm{two categorical variables are associated}$$

- E.g. Does M&M color distribution depend on type (chocolate vs. peanut)?

$$H_0: \text{there is no association between M&M color and type}$$
$$H_A: \text{there is an association between M&M color and type}$$
]

---

# Expected Counts and p-value

.blockquote-list[
The expected counts for each combination in a two-way table

$$\textrm{expected count} = \dfrac{\textrm{row total} \times \textrm{column total}}{n}$$


$$\chi^2 = \sum_{\textrm{all cells}}\dfrac{(\textrm{expected count} - \textrm{observed count})^2}{\textrm{expected count}}$$

- For both types of test, large chi-square test stat values support the .bold[alternative] hypothesis so

$$p-value = P(\chi^2 \geq \text{observed } \chi^2)$$

- always a .bold[right-tailed] value
]

---

# Chi-Square test for association

.blockquote.font80[
.bold[Options for computing the p-value:]

- randomization/permutation: simulate new data consistent with $H_0$ and recompute the $\chi^2$ test stat
  - .bold[Association:] permute the values of one variable column to break the link that could exist in the data between both variables

- Chi-square distribution (probability model)
  - .bold[Association:] use $(r-1)(c-1)$ where $r=$ number of rows and $c=$ number of columns
  - need $n$ large enough so expected counts are at least 5
]

---

# Association example

.blockquote.font90[
- Does political comfort level depend on religion?

- $H_0:$ There is no association between religion and comfort level 
  - implies: the distribution of comfort level is the same for all three religion types 

- $H_A:$ There is an association between religion and comfort level
  - implies: the distribution of comfort level is the different for at least one religion type. 
]


---

##  Association example

.blockquote.font90[
- EDA for two categorical variables

  - change comfort level names then reorder
]

```{r, collapse=TRUE}
survey <- read.csv("http://math.carleton.edu/kstclair/data/Survey.csv")
summary(survey$Question.9)
levels(survey$Question.9) <- c("almost always", "rarely", "sometimes")
survey$Question.9 <- fct_relevel(survey$Question.9,
                      "almost always", "sometimes", "rarely")
summary(survey$Question.9)  # always check work!
```

---

class: action

# <i class="fa fa-pencil-square-o" style="font-size:48px;color:purple">&nbsp;Your&nbsp;Turn&nbsp;`r (yt <- yt + 1)`</i>    


.pull-left-40[
![](https://media.giphy.com/media/RKApDdwsQ6jkwd6RNn/giphy.gif)
]
.pull-right-60[

<br>
<br>

.blockquote[
- Go over to the in class activity file
- Complete the activity in your group
]
]

`r countdown(minutes = 5, seconds = 00, top = 0 , color_background = "inherit", padding = "3px 4px", font_size = "2em")`


---

#  Association example

- Observed distribution of comfort level given religiousness

```{r, collapse=TRUE}
counts <- table(survey$Question.8, survey$Question.9)
counts
```

---

#  Association example

```{r, collapse=TRUE}
sum(counts)  # number of respondents
prop.table(counts,1)  
```

There is a much higher rate of "almost always comfortable" for the not religious respondents (`r round(prop.table(counts,1),3)[1,1]*100`%) than those that are religious (not active: `r round(prop.table(counts,1),3)[2,1]*100`%; active: `r round(prop.table(counts,1),3)[3,1]*100`%). 

---

# 2b. Association example

```{r, echo=FALSE, fig.width= 8, fig.height=3.7}
ggplot(survey, aes(x=Question.8, fill=Question.9)) +
  geom_bar(position="fill") +
  labs(fill = "Comfort level", x = "Religious level", y = "proportion", title="Comfort level by religious level") +
  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 16))
```

---

# Association example

- Both variables have missing value(s). Remove using `drop_na` then redo plot.

```{r}
library(tidyr)
survey_ex2 <- drop_na(survey, Question.8, Question.9) # removes missing values 
```


```{r, echo=FALSE, fig.width= 5, fig.height=2.5, out.width="70%", fig.align='center'}
library(ggplot2)
ggplot(survey_ex2, aes(x=Question.8, fill=Question.9)) +
  geom_bar(position="fill") +
  labs(fill = "Comfort level", x = "Religious level", y = "proportion", title="Comfort level by religious level")+
  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 16))
```

---

#  Association example

.blockquote-list.font80[
- Expected counts assuming no association (null)?

  - expected number of respondents who are "not religious" and "almost always comfortable"?
  - is .bold[not] 1/9 of all respondents!

- There are `r sum(counts[1,])` "not religious" respondents (row total)

- The overall rate (ignoring religion) of "almost always comfortable" is $\dfrac{`r sum(counts[,1])`}{`r sum(counts)`}$, or about  `r round(prop.table(table(survey$Question.9))[1],3)*100`%. 

- If religion isn't related to comfort level, the expected number is about
$$\textrm{expected count} = \dfrac{\textrm{row total} \times \textrm{column total}}{n} = `r sum(counts[1,])` \times \dfrac{`r sum(counts[,1])`}{`r sum(counts)`} = `r round(sum(counts[1,])*sum(counts[,1])/sum(counts),3)`$$
]

---

class: middle

# 2d. Association example

.blockquote[
- Chi-square contribution for "not religious" and "almost always comfortable" cell?

```{r, echo=FALSE}
exp <- table(survey$Question.8)[1]*table(survey$Question.9)[1]/sum(counts)
contr<- (counts[1,1] - exp)^2/exp
```


- The contribution to the chi-square test stat from this category is `r round(contr, 2)`.
$$\dfrac{(`r counts[1,1]` - `r round(exp,3)`)^2}{`r round(exp,3)`} = `r round(contr,3)`$$
]


---

# 2e. Association example

- Use `chisq.test` to finish the test stat calculation (who wants to add 9 cell contributions!)

```{r}
ComfortReligion <- chisq.test(survey_ex2$Question.8, survey_ex2$Question.9)
ComfortReligion
```

.blockquote[
- The test stat value is `r round(ComfortReligion$statistic,3)`. 
- There are 3 categories for each variable, so the degrees of freedom will be $df = (3-1)(3-1) = 4$. 
]

---

class: middle

# 2f. Association example

.blockquote.font90[
- .bold[Interpret:]  If there is no association between comfort level and religiousness, then we would see a chi-square test stat of `r round(ComfortReligion$statistic,3)`, or one even larger, only about `r round(ComfortReligion$p.value,4)*100`% of the time. 

- Conclusion?

- We have strong evidence that there is an association between political comfort level and religiousness ( $\chi^2 = `r round(ComfortReligion$statistic,3)`$, df = `r ComfortReligion$parameter`, p-value = 0.00026).

]

---

# 2g. Association example

- Are the expected counts above 5?
```{r, collapse=TRUE}
ComfortReligion$expected
```

---

# 2h. Association example

.blockquote.font90[
- If we get a red warning when running `chisq.test`, it usually means the sample size conditions aren't met to use the chi-square model. 

- Instead run a randomization test with
]


```{r}
chisq.test(survey_ex2$Question.8, survey_ex2$Question.9, 
           simulate.p.value = TRUE)
```



---

# 2i. Association example

.blockquote.font80[
- Describe the association! 

  - which groups have the most different comfort levels?
]
    
```{r, echo=FALSE, fig.width= 5, fig.height=2.5, out.width="70%", fig.align='center'}
library(ggplot2)
ggplot(survey_ex2, aes(x=Question.8, fill=Question.9)) +
  geom_bar(position="fill") +
  labs(fill = "Comfort level", x = "Religious level", y = "proportion", title="Comfort level by religious level")+
  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 16))

```

---

# 2i. Association example

.blockquote.font80[
- 95% CI for the difference in the true proportions of "rarely comfortable" people in the not religious and actively religious groups.
$$p = \textrm{proportion rarely comfortable}$$

  - 95% CI for $p_{not.relig} - p_{active}$
]

```{r, collapse=TRUE}
table(survey_ex2$Question.8)
```
$$n_{not.relig} = `r sum(counts[1,])` \ \ \ n_{active} = `r sum(counts[3,])`$$

---

# 2i. Association example

.code90[
```{r, collapse=TRUE}
prop.table(counts,1)  
```
]

---

# 2i. Association example


```{r, collapse=TRUE}
counts
```

$$\hat{p}_{not.rel} = \dfrac{`r counts[1,3]`}{`r sum(counts[1,])`} = `r prop.table(counts,1)[1,3]`$$
$$\hat{p}_{active} = \dfrac{`r counts[3,3]`}{`r sum(counts[3,])`} = `r prop.table(counts,1)[3,3]`$$

---


# 2i. Association example

.blockquote[
- 95% CI for $p_{not.relig} - p_{active}$

\begin{align*}
`r prop.table(counts,1)[1,3]` - `r prop.table(counts,1)[3,3]`  \pm & 1.96 \sqrt{\dfrac{`r prop.table(counts,1)[1,3]`(1-`r prop.table(counts,1)[1,3]`)}{`r sum(counts[1,])`} + \dfrac{`r prop.table(counts,1)[3,3]`(1-`r prop.table(counts,1)[3,3]`)}{`r sum(counts[3,])`}} \\
`r prop.table(counts,1)[1,3] - prop.table(counts,1)[3,3]`  \pm & 1.96 (`r sqrt( prop.table(counts,1)[1,3]*(1- prop.table(counts,1)[1,3])/sum(counts[1,]) + prop.table(counts,1)[3,3]*(1- prop.table(counts,1)[3,3])/sum(counts[3,]))`) \\
(`r prop.table(counts,1)[1,3] - prop.table(counts,1)[3,3] - 1.96*sqrt( prop.table(counts,1)[1,3]*(1- prop.table(counts,1)[1,3])/sum(counts[1,]) + prop.table(counts,1)[3,3]*(1- prop.table(counts,1)[3,3])/sum(counts[3,]))`, &  `r prop.table(counts,1)[1,3] - prop.table(counts,1)[3,3] + 1.96*sqrt( prop.table(counts,1)[1,3]*(1- prop.table(counts,1)[1,3])/sum(counts[1,]) + prop.table(counts,1)[3,3]*(1- prop.table(counts,1)[3,3])/sum(counts[3,]))`)
\end{align*}


```{r, echo  = FALSE}
CI <- prop.table(counts,1)[1,3] - prop.table(counts,1)[3,3] + c(-1,1)* 1.96*sqrt( prop.table(counts,1)[1,3]*(1- prop.table(counts,1)[1,3])/sum(counts[1,]) + prop.table(counts,1)[3,3]*(1- prop.table(counts,1)[3,3])/sum(counts[3,]))
```


- I am 95% confident that the percentage of all non-religious 215 students who are  rarely comfortable is between `r round(-CI[2]*100,1)` to `r round(-CI[1]*100,1)` percentage points lower than the actively religious students. 
]

