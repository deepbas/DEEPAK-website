---
title: "More date and time and strings"
subtitle: "<br/> STAT 220"
author: "Bastola"
date: "`r format(Sys.Date(), ' %B %d %Y')`"
output:
  xaringan::moon_reader:
    css: [css/xaringan-themer.css, css/my-theme.css]
    lib_dir: libs
    chakra: libs/remark-latest.min.js
    nature:
      highlightStyle: tomorrow #http://arm.rbind.io/slides/xaringan.html#77
      highlightLines: true
      highlightLanguage: r
      countIncrementalSlides: false
      titleSlideClass: ["left", "middle", "inverse"]
      ratio: "16:9"
      countdown: 60000
    includes:
      in_header: header.html  
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)

knitr::opts_chunk$set(echo = TRUE, 
                      dev = 'svg',
                      collapse = TRUE, 
                      comment = NA,  # PRINTS IN FRONT OF OUTPUT, default is '##' which comments out output
                      prompt = FALSE, # IF TRUE adds a > before each code input
                      warning = FALSE, 
                      message = FALSE,
                      fig.height = 3, 
                      fig.width = 4,
                      out.width = "100%"
                      )


# load necessary packages
library(tidyr)
library(dplyr)
library(dslabs)
library(ggplot2)
library(countdown)
library(ggthemes)
library(tidyverse)
library(stringr)
library(xaringanExtra)
xaringanExtra::use_panelset()
xaringanExtra::use_tachyons()
library(flipbookr)

library(knitr)
library(kableExtra)
library(fontawesome)
library(lubridate)
library(janitor)
library(rvest)
library(forcats)
library(patchwork)
library(readr)
library(stringr)
library(gapminder) 


# set ggplot theme
# theme_set(theme_bw(base_size = 24))

yt <- 0

# Some codes
data("flights", package = "nycflights13")

top_dest <- flights %>%
  count(dest) %>%
  slice_max(n, n = 10)

energy <- readr::read_csv("https://raw.githubusercontent.com/deepbas/statdatasets/main/energy.csv",
                    col_type = cols(
                     .default = col_double(), 
                      Timestamp = col_datetime(format = ""),
                      dayWeek = col_factor(levels=c("Mon","Tues","Wed","Thurs","Fri","Sat","Sun"))
                     ))

energy_narrow <- energy %>%
  pivot_longer(
    cols = `100_Nevada_Street`:Wilson_House, 
    names_to = "building",
    values_to = "energyKWH"
  )


set.seed(123)
cell_info <- str_c(
  str_c("Specimen", 1:12),
  sample(c("RNA", "DNA"), 12, replace = TRUE),
  sample(c("H5N1", "SARS5", "COV19"), 12, replace = TRUE),
  sample(seq(as.Date('2022/01/01'), as.Date('2022/06/01'),
             by="day"), 12),
  sep = "_"
)

```


```{r xaringan-themer, include = FALSE}
# Use xaringan theme from first set
```


# Reading the Energy Dataset 

```{r}
energy <- read_csv("https://raw.githubusercontent.com/deepbas/statdatasets/main/energy.csv",
                    col_type = cols(
                     .default = col_double(), 
                      Timestamp = col_datetime(format = ""),
                      dayWeek = col_factor(levels=c("Mon","Tues","Wed","Thurs","Fri","Sat","Sun"))
                     ))

```

--

```{r}
energy %>% slice_max(n=2, order_by = Timestamp) 
```



---

# Wide to Long 

```{r}
energy_narrow <- energy %>%
  pivot_longer( cols = `100_Nevada_Street`:Wilson_House, names_to = "building", values_to = "energyKWH")
```

```{r}
energy_narrow
```

---

# Dates and times manipulation

.pull-left[

```{r}
energy$Timestamp[1]
## [1] "2015-09-01 UTC"
as.numeric(energy$Timestamp[1])
## [1] 1441065600

# 5th timestamp
( stamp5 <- energy$Timestamp[5] )

```
]
--
.pull-right[
```{r}
mdy("1/4/2021")

dmy_hms("01/04/2020-01-30-23")
```

```{r}
make_datetime(year = 2022,
              month = 1, 
              day = 5, 
              hour = 10,
              sec = 20)
```
]

---

# Measuring time

.pull-left[
```{r}
first_day <- ymd_hm("2022-01-05 12:30")
classtime <- now() - first_day
classtime
```

```{r}
as.period(classtime)
as.duration(classtime)
```
]
--
.pull-right[

```{r}
diff1 <- first_day %--% now()
diff1/dminutes(1)
```

```{r}
diff2 <- interval(first_day, now())
diff2/dminutes(1)
```

]


---
`r chunk_reveal("demo1", widths = c(60, 40), font_size_code="70%", title = "## Top ten destination")`


```{r demo1, eval=FALSE, echo=FALSE}
data("flights", package = "nycflights13")

flights %>%
  count(dest) %>%
  slice_max(n, n = 10)

```

---



`r chunk_reveal("demo2", widths = c(52, 48), font_size_code="70%", title = "## Duration using lubriate")`


```{r, demo2, eval = FALSE, echo=FALSE}
top_dest <- flights %>%
  count(dest) %>%
  slice_max(n, n = 10)

flights %>% 
  semi_join(top_dest) %>%
  mutate(sch_datetime = make_datetime(  
    year = year, month = month, 
    day = day, hour = hour, 
    min = minute)
    ) %>%
  select(dest, sch_datetime) %>%
  group_by(dest) %>%     
  arrange(sch_datetime) %>%    
  mutate(
    diff1 = (lag(sch_datetime) %--% 
                    sch_datetime)/minutes(1),
    diff2 = interval(lag(sch_datetime), 
                    sch_datetime)/minutes(1)) %>%   
  summarize(medianMins1 = median(diff1, 
                                 na.rm=TRUE),
            medianMins2 = median(diff2, 
                                 na.rm=TRUE))

```

---

# String Parsing

- .Large[**Powerful tool useful for overcoming many data wrangling challenges**]

<!-- manipulate (or parse) textual data by looking for patterns in a string -->

- .Large[The most common tasks in string processing include:]

  + .yellow-h[extracting] numbers from strings
  + .yellow-h[removing] unwanted characters from text
  + .yellow-h[finding and replacing] characters
  + .yellow-h[extracting] specific parts of strings
  + .yellow-h[converting] free form text to more uniform formats
  + .yellow-h[splitting] strings into multiple values

---

# `stringr` package

<!-- add a picture -->

.pull-left-60[
<!-- The main types of string processing tasks are -->

  + detecting, locating, extracting and replacing elements of strings.
  
<!-- The **stringr** package from the **tidyverse** includes a variety of string processing functions that -->  

  +  begin with `str_` and take the string as the first argument
  
<!-- which makes them compatible with the pipe. -->
]
.pull-right-40[

![](images/stringr.png)]



---


# Regular expressions: Regex

  <!-- Use **regular expressions (regex)** to process strings. -->


- A way to describe a specific pattern of characters of text. 

- To use regex in R, you need to use the **stringr** package

- **stringr** functions can take a regex as a pattern.

- Main difference between a regex and a regular string is that a regex can include special characters.


---

# Defining Strings

  * A string is any sequence of characters

  * Define a string by surrounding text with either single quotes or double quotes.
  
```{r}
s <- "Hello!"    # double quotes define a string
s <- 'Hello!'    # single quotes define a string  
```
  
--

  * The `cat()` or `writeLines()` function displays a string as it is represented inside R.

.pull-left[
```{r}
cat(s)
```
]
.pull-right[
```{r}
writeLines(s)
```
]


--

```{r, eval=FALSE, echo=TRUE}
s <- `Hello`    # backquotes do not define a string
s <- "10""    # error - unclosed quotes
```

---

# Special characters
  
  * The "escape" backslash \ is used to escape the special use of certain characters 

```{r collapse=TRUE}
writeLines("\"")
writeLines("\\")
writeLines("Math\\Stats")
```

--

  * To include both single and double quotes in string, escape with \
  
<!--  To include a double quote inside a string, use single quotes on the outside. To include a single quote inside a string, use double quotes on the outside. -->

--

```{r}
s <- '5\'10"'    # outer single quote
cat(s)
```

--

```{r}
s <- "5'10\""    # outer double quote
cat(s)
```

---

# More Special Characters

- The | symbol inside a regex means `"or"`.


- Use `\\s` to match white space characters (spaces, tabs, and newlines)


- Use `\\w` to match alphanumeric characters (letters and numbers)


- Use `\\d` to represent digits (numbers)

<!-- The backlash is used to distinguish it from the character `'d'`. -->

---

## More Special Characters

- .out-t[`^`] = start of a string

- .out-t[`$`] = end of a string

- .out-t[`.`] = any character

- .out-t[`[:alpha:]`] = any letter

- .out-t[`[:digit:]`] = any digit

--

## Quantifiers

- .out-t[`*`] = matches the preceding character any number of times

- .out-t[`+`] = matches the preceding character once

- .out-t[`?`] = matches the preceding character at most once (i.e. optionally)

- .out-t[{n}] = matches the preceding character exactly n times


---

#  Combining strings

```{r}
str_c("fire", "man")
```

--

```{r}
a <- c("a", "b", "c")
b <- c("A", "B", "C")
str_c(a, b)
```

--

```{r}
building <- "CMC"
room <- "102"
begin_time <- "12:30 p.m."
end_time <- "01:40 p.m."
days <- "MWF"
class <- "STAT 220"
str_c(class, "meets from", begin_time, "to", end_time, 
      days, "in", building, room, sep=" ")
```

---

# `str_detect()`

- `str_detect()` indicates whether a pattern is present in a string.

```{r, echo=FALSE}
url <- "https://en.wikipedia.org/w/index.php?title=Gun_violence_in_the_United_States_by_state&direction=prev&oldid=810166167"
murders_raw <- read_html(url) %>% 
  html_nodes("table") %>% 
  html_table() %>%
  .[[1]] %>%
  setNames(c("state", "population", "total", "murder_rate"))
```


```{r}
head(murders_raw)
```


```{r}
# detect whether a comma is present

pattern <- ","
str_detect(murders_raw$population, pattern) 
```

---

# `str_detect()`

```{r}
days <- rep(c("Monday", "Tuesday", "Wednesday", 
              "Thursday", "Friday", "Saturday", "Sunday"),2)
```

--

```{r}
str_detect(days, "^[Ss]un.*")
```

--

```{r}
identical(str_detect(days, "Su"), str_detect(days, "^[Ss]un.*"))
```

--

```{r}
days %>% 
 
  str_which("^T")  #indices of matching entries  #<<
```


---

# `str_subset()`

- returns all values in a vector which match a pattern

```{r}
gapminder$country %>% 
  unique() %>% 
  str_subset("^[CU].*a$")
```

--

```{r}
# columns with names starting with "c"
gapminder %>% names() %>% str_subset("^c")
```


---

# `str_extract()` and `str_sub()`

- extracts parts of strings based on their position with the start and end arguments

```{r}
gapminder %>% 
  names() %>% 
  str_sub(start = 1, end = 6) #return the 1st 6 characters of each column name #<<
```

--

- extract just the part of the string matching the specified regex instead of the entire entry

```{r}
name_phone <- c("Moly: 250-999-8878", 
       "Ali: 416-908-2044", 
       "Eli: 204-192-9829", 
       "May: 250-209-7047")

str_extract(name_phone, "[:alpha:]*") 

```


---

# `str_split()`

- Splits a string into a list or matrix of pieces based on a supplied pattern


```{r}
str_split(c("a_3", "d_54"), pattern = "_") # returns a list
```

--

```{r}
str_split(c("a_3", "d_54"), pattern = "_", simplify = TRUE) # returns a matrix
```


---



# `str_replace()`

`str_replace()` replaces the first instance of the detected pattern with a specified string.

```{r}
gap_names <- gapminder %>% names

str_replace(gap_names, 
            pattern = "^.{3}", # match the 1st 3 characters of each string in the vector
            replacement = "X_")
```

---

class: action

# Your turn `r (yt <- yt + 1)`


Please git clone the repository on [basic string manipulation](https://github.com/stat220/09-basic-string) to your local folder. 

```{r}
cell_info
```

- Complete the required tasks using `str_subset`, `str_extract`, `str_split` and `str_replace`.

```{r echo=FALSE}
countdown(7.5)
```


